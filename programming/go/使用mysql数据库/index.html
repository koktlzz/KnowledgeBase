<!doctype html><html lang=en-us><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-D022F6NT2P"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-D022F6NT2P')</script><script>(function(b,d,e,a,g){b[a]=b[a]||[],b[a].push({'gtm.start':(new Date).getTime(),event:'gtm.js'});var f=d.getElementsByTagName(e)[0],c=d.createElement(e),h=a!='dataLayer'?'&l='+a:'';c.async=!0,c.src='https://www.googletagmanager.com/gtm.js?id='+g+h,f.parentNode.insertBefore(c,f)})(window,document,'script','dataLayer','GTM-P72R45W')</script><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://koktlzz.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://koktlzz.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://koktlzz.github.io/fonts/KaTeX_Main-Regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://koktlzz.github.io/fonts/KaTeX_Math-Italic.woff2 type=font/woff2 crossorigin><link rel=stylesheet href=https://koktlzz.github.io/main.27967119d9bfd1f18848f648c47494cdf9c8666df2bb5d54d01736bacd6e74dc5f8b9b2cbc827df0fc8e4cef4f4bae41b13b93c84017caf5272a107d6f2af5cc.css integrity="sha512-J5ZxGdm/0fGISPZIxHSUzfnIZm3yu11U0Bc2us1udNxfi5ssvIJ98PyOTO9PS65BsTuTyEAXyvUnKhB9byr1zA==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>使用 MySQL 数据库 | KnowledgeBase</title><meta name=description content><link rel=canonical href=https://koktlzz.github.io/programming/go/%E4%BD%BF%E7%94%A8mysql%E6%95%B0%E6%8D%AE%E5%BA%93/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="使用 MySQL 数据库"><meta property="og:description" content="连接数据库 package main import ( &#34;context&#34; &#34;database/sql&#34; &#34;fmt&#34; &#34;log&#34; _ &#34;github.com/mikespook/mymysql&#34; ) func main() { var db *sql.DB // 第二个参数的格式为：user:password@tcp(ip: port)/dbname  db, _ = sql.Open(&#34;mysql&#34;, &#34;******&#34;) err := db.Ping() if err != nil { log.Fatalln(err.Error()) } fmt.Println(&#34;CONNECTION SUCCESSFUL&#34;) } 数据库驱动 想要连接到 SQL 数据库，那么首先需要加载目标数据库的驱动，驱动中包含了与数据库交互的逻辑。正常获取数据库驱动的方法是调用 sql.Register() 函数进行注册：
var ( driversMu sync.RWMutex // 使用一个 map 来储存用户定义的数据库驱动  drivers = make(map[string]driver.Driver) ) func Register(name string, driver driver.Driver) { driversMu.Lock() defer driversMu.Unlock() if driver == nil { panic(&#34;sql: Register driver is nil&#34;) } if _, dup := drivers[name]; dup { panic(&#34;sql: Register called twice for driver &#34; + name) } // 将用户定义的数据库驱动添加到 map 中  drivers[name] = driver } 它的第一个参数是数据库驱动的名称，在本例中为 mysql。第二个参数是一个结构体，类型为 driver."><meta property="og:url" content="https://koktlzz.github.io/programming/go/%E4%BD%BF%E7%94%A8mysql%E6%95%B0%E6%8D%AE%E5%BA%93/"><meta property="og:site_name" content="KnowledgeBase"><meta property="article:published_time" content="2020-11-04T09:19:42+01:00"><meta property="article:modified_time" content="2020-11-04T09:19:42+01:00"><meta property="og:image" content="https://koktlzz.github.io/doks.png"><meta property="og:image:alt" content="KnowledgeBase"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@getdoks"><meta name=twitter:creator content="@henkverlinde"><meta name=twitter:title content="使用 MySQL 数据库"><meta name=twitter:description content><meta name=twitter:image content="https://koktlzz.github.io/doks.png"><meta name=twitter:image:alt content="使用 MySQL 数据库"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://koktlzz.github.io/#/schema/organization/1","name":"Doks","url":"https://koktlzz.github.io/","sameAs":["https://twitter.com/getdoks","https://github.com/h-enk/doks"],"logo":{"@type":"ImageObject","@id":"https://koktlzz.github.io/#/schema/image/1","url":"https://koktlzz.github.io/logo-doks.png","width":512,"height":512,"caption":"Doks"},"image":{"@id":"https://koktlzz.github.io/#/schema/image/1"}},{"@type":"WebSite","@id":"https://koktlzz.github.io/#/schema/website/1","url":"https://koktlzz.github.io/","name":"KnowledgeBase","description":"","publisher":{"@id":"https://koktlzz.github.io/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://koktlzz.github.io/programming/go/%E4%BD%BF%E7%94%A8mysql%E6%95%B0%E6%8D%AE%E5%BA%93/","url":"https://koktlzz.github.io/programming/go/%E4%BD%BF%E7%94%A8mysql%E6%95%B0%E6%8D%AE%E5%BA%93/","name":"使用 MySQL 数据库","description":"","isPartOf":{"@id":"https://koktlzz.github.io/#/schema/website/1"},"about":{"@id":"https://koktlzz.github.io/#/schema/organization/1"},"datePublished":"2020-11-04T09:19:42CET","dateModified":"2020-11-04T09:19:42CET","breadcrumb":{"@id":"https://koktlzz.github.io/programming/go/%E4%BD%BF%E7%94%A8mysql%E6%95%B0%E6%8D%AE%E5%BA%93/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://koktlzz.github.io/programming/go/%E4%BD%BF%E7%94%A8mysql%E6%95%B0%E6%8D%AE%E5%BA%93/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://koktlzz.github.io/programming/go/%E4%BD%BF%E7%94%A8mysql%E6%95%B0%E6%8D%AE%E5%BA%93/"]}]},{"@type":"BreadcrumbList","@id":"https://koktlzz.github.io/programming/go/%E4%BD%BF%E7%94%A8mysql%E6%95%B0%E6%8D%AE%E5%BA%93/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://koktlzz.github.io/","url":"https://koktlzz.github.io/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://koktlzz.github.io/programming/","url":"https://koktlzz.github.io/programming/","name":"Programming"}},{"@type":"ListItem","position":3,"item":{"@type":"WebPage","@id":"https://koktlzz.github.io/programming/go/","url":"https://koktlzz.github.io/programming/go/","name":"Go"}},{"@type":"ListItem","position":4,"item":{"@id":"https://koktlzz.github.io/programming/go/%E4%BD%BF%E7%94%A8mysql%E6%95%B0%E6%8D%AE%E5%BA%93/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://koktlzz.github.io/programming/go/%E4%BD%BF%E7%94%A8mysql%E6%95%B0%E6%8D%AE%E5%BA%93/#/schema/image/2","url":"https://koktlzz.github.io/doks.png","contentUrl":"https://koktlzz.github.io/doks.png","caption":"使用 MySQL 数据库"}]}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=https://koktlzz.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://koktlzz.github.io/favicon-32x32.ico><link rel=icon type=image/png sizes=16x16 href=https://koktlzz.github.io/favicon-16x16.ico><link rel=manifest crossorigin=use-credentials href=https://koktlzz.github.io/site.webmanifest></head><body class="Programming single dark"><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-P72R45W" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container-fluid><input class="menu-btn order-0" type=checkbox id=menu-btn>
<label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label><a class="navbar-brand order-1 order-md-0 me-auto" href=https://koktlzz.github.io/>KnowledgeBase</a>
<button id=mode class="btn btn-link order-2 order-md-4" type=button aria-label="Toggle mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button><ul class="navbar-nav social-nav order-3 order-md-5"><li class=nav-item><a class=nav-link href=https://github.com/koktlzz><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><span class="ms-2 visually-hidden">GitHub</span></a></li></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav me-auto order-5 order-md-2"><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/container/docker/intro>Container</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/observability/elasticstack/intro>Observability</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/programming/go/intro>Programming</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/infrastructure/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/tcpip%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B>Infrastructure</a></li></ul><div class="break order-6 d-md-none"></div></div></div></header><div class="wrap container-fluid" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-4 col-xl-3 d-none d-xl-block"><nav class=docs-links aria-label="Main navigation"><h3>Go</h3><ul class=list-unstyled><li><a class=docs-link href=https://koktlzz.github.io/programming/go/intro/>Getting Started</a></li><li><a class=docs-link href=https://koktlzz.github.io/programming/go/requestresponse/>Request & Response</a></li><li><a class=docs-link href=https://koktlzz.github.io/programming/go/%E6%90%AD%E5%BB%BAweb%E6%9C%8D%E5%8A%A1%E5%99%A8/>搭建 Web 服务器</a></li><li><a class=docs-link href=https://koktlzz.github.io/programming/go/%E4%BD%BF%E7%94%A8mysql%E6%95%B0%E6%8D%AE%E5%BA%93/>使用 MySQL 数据库</a></li></ul></nav></div><main class="docs-content col-lg-12 col-xl-10"><h1>使用 MySQL 数据库</h1><p class=lead></p><h2 id=连接数据库>连接数据库<a href=#连接数据库 class=anchor aria-hidden=true>#</a></h2><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#ff79c6>package</span> main

<span style=color:#ff79c6>import</span> (
    <span style=color:#f1fa8c>&#34;context&#34;</span>
    <span style=color:#f1fa8c>&#34;database/sql&#34;</span>
    <span style=color:#f1fa8c>&#34;fmt&#34;</span>
    <span style=color:#f1fa8c>&#34;log&#34;</span>

    _ <span style=color:#f1fa8c>&#34;github.com/mikespook/mymysql&#34;</span>
)

<span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>main</span>() {
    <span style=color:#8be9fd;font-style:italic>var</span> db <span style=color:#ff79c6>*</span>sql.DB
    <span style=color:#6272a4>// 第二个参数的格式为：user:password@tcp(ip: port)/dbname
</span><span style=color:#6272a4></span>    db, _ = sql.<span style=color:#50fa7b>Open</span>(<span style=color:#f1fa8c>&#34;mysql&#34;</span>, <span style=color:#f1fa8c>&#34;******&#34;</span>)
    err <span style=color:#ff79c6>:=</span> db.<span style=color:#50fa7b>Ping</span>()
    <span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
        log.<span style=color:#50fa7b>Fatalln</span>(err.<span style=color:#50fa7b>Error</span>())
    }
    fmt.<span style=color:#50fa7b>Println</span>(<span style=color:#f1fa8c>&#34;CONNECTION SUCCESSFUL&#34;</span>)
}
</code></pre></div><h3 id=数据库驱动>数据库驱动<a href=#数据库驱动 class=anchor aria-hidden=true>#</a></h3><p>想要连接到 SQL 数据库，那么首先需要加载目标数据库的驱动，驱动中包含了与数据库交互的逻辑。正常获取数据库驱动的方法是调用 sql.Register() 函数进行注册：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#8be9fd;font-style:italic>var</span> (
    driversMu sync.RWMutex
    <span style=color:#6272a4>// 使用一个 map 来储存用户定义的数据库驱动
</span><span style=color:#6272a4></span>    drivers   = <span style=color:#8be9fd;font-style:italic>make</span>(<span style=color:#8be9fd;font-style:italic>map</span>[<span style=color:#8be9fd>string</span>]driver.Driver)
)

<span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>Register</span>(name <span style=color:#8be9fd>string</span>, driver driver.Driver) {
    driversMu.<span style=color:#50fa7b>Lock</span>()
    <span style=color:#ff79c6>defer</span> driversMu.<span style=color:#50fa7b>Unlock</span>()
    <span style=color:#ff79c6>if</span> driver <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>nil</span> {
        <span style=color:#8be9fd;font-style:italic>panic</span>(<span style=color:#f1fa8c>&#34;sql: Register driver is nil&#34;</span>)
    }
    <span style=color:#ff79c6>if</span> _, dup <span style=color:#ff79c6>:=</span> drivers[name]; dup {
        <span style=color:#8be9fd;font-style:italic>panic</span>(<span style=color:#f1fa8c>&#34;sql: Register called twice for driver &#34;</span> <span style=color:#ff79c6>+</span> name)
    }
    <span style=color:#6272a4>// 将用户定义的数据库驱动添加到 map 中
</span><span style=color:#6272a4></span>    drivers[name] = driver
}
</code></pre></div><p>它的第一个参数是数据库驱动的名称，在本例中为 mysql。第二个参数是一个结构体，类型为 driver.Driver：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#8be9fd;font-style:italic>type</span> Driver <span style=color:#8be9fd;font-style:italic>interface</span> {
    <span style=color:#6272a4>// Open returns a new connection to the database.
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>// The name is a string in a driver-specific format.
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>// Open may return a cached connection (one previously closed), but doing so is unnecessary; 
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>// the sql package maintains a pool of idle connections for efficient re-use.
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>// The returned connection is only used by one goroutine at a time.
</span><span style=color:#6272a4></span>    <span style=color:#50fa7b>Open</span>(name <span style=color:#8be9fd>string</span>) (Conn, <span style=color:#8be9fd>error</span>)
}
</code></pre></div><p>Driver 的底层分析详见：<a href=https://github.com/astaxie/build-web-application-with-golang/blob/master/zh/05.1.md>https://github.com/astaxie/build-web-application-with-golang/blob/master/zh/05.1.md</a></p><p>而我们在注册数据库时却并没有调用 Register() 函数，而是引入了一个数据库驱动的包：<em>github.com/mikespook/mymysql</em>：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#6272a4>// go get 命令安装数据库驱动包
</span><span style=color:#6272a4></span>_ <span style=color:#f1fa8c>&#34;github.com/mikespook/mymysql&#34;</span>

<span style=color:#6272a4>// mymysql 包内部：
</span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>var</span> d = Driver{proto: <span style=color:#f1fa8c>&#34;tcp&#34;</span>, raddr: <span style=color:#f1fa8c>&#34;127.0.0.1:3306&#34;</span>}
<span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>init</span>() {
    <span style=color:#50fa7b>Register</span>(<span style=color:#f1fa8c>&#34;SET NAMES utf8&#34;</span>)
    sql.<span style=color:#50fa7b>Register</span>(<span style=color:#f1fa8c>&#34;mymysql&#34;</span>, <span style=color:#ff79c6>&amp;</span>d)
}
</code></pre></div><p>由于 Go 引入 package 时，会自动调用自身的 init() 函数。因此只要我们引入数据库驱动包，就通过它自身的 init() 函数完成了数据库驱动的注册。所有第三方的数据库驱动包都实现 database/sql/driver 中定义的接口。</p><blockquote><p>新手都会被这个<code>_</code>所迷惑，其实这个就是 Go 设计的巧妙之处，我们在变量赋值的时候经常看到这个符号，它是用来忽略变量赋值的占位符，那么包引入用到这个符号也是相似的作用，这儿使用<code>_</code>的意思是引入后面的包名而不直接使用这个包中定义的函数，变量等资源。</p></blockquote><h3 id=调用-sqlopen>调用 sql.Open()<a href=#调用-sqlopen class=anchor aria-hidden=true>#</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>Open</span>(driverName, dataSourceName <span style=color:#8be9fd>string</span>) (<span style=color:#ff79c6>*</span>DB, <span style=color:#8be9fd>error</span>) {
    driversMu.<span style=color:#50fa7b>RLock</span>()
    driveri, ok <span style=color:#ff79c6>:=</span> drivers[driverName]
    driversMu.<span style=color:#50fa7b>RUnlock</span>()
    <span style=color:#ff79c6>if</span> !ok {
        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>nil</span>, fmt.<span style=color:#50fa7b>Errorf</span>(<span style=color:#f1fa8c>&#34;sql: unknown driver %q (forgotten import?)&#34;</span>, driverName)
    }

    <span style=color:#ff79c6>if</span> driverCtx, ok <span style=color:#ff79c6>:=</span> driveri.(driver.DriverContext); ok {
        connector, err <span style=color:#ff79c6>:=</span> driverCtx.<span style=color:#50fa7b>OpenConnector</span>(dataSourceName)
        <span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
            <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>nil</span>, err
        }
        <span style=color:#ff79c6>return</span> <span style=color:#50fa7b>OpenDB</span>(connector), <span style=color:#ff79c6>nil</span>
    }

    <span style=color:#ff79c6>return</span> <span style=color:#50fa7b>OpenDB</span>(dsnConnector{dsn: dataSourceName, driver: driveri}), <span style=color:#ff79c6>nil</span>
}
</code></pre></div><p>第一个参数 driverName 为数据库驱动名称，在本例中为 mysql。第二个参数为数据源名称，它支持如下格式：</p><ul><li>user@unix(/path/to/socket)/dbname?charset=utf8</li><li>user:password@tcp(localhost:5555)/dbname?charset=utf8</li><li>user:password@/dbname</li><li>user:password@tcp([de:ad:be:ef::ca:fe]:80)/dbname</li></ul><p>该方法返回一个指向 sql.DB 结构体类型的指针。</p><p>Open() 函数并不会真正的连接数据库，甚至不会验证其参数。它只是把后续连接数据库所需的 sql.DB 设置好，而真正的连接是在后续操作数据库时才建立的。</p><h3 id=sqldb>sql.DB<a href=#sqldb class=anchor aria-hidden=true>#</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#8be9fd;font-style:italic>type</span> DB <span style=color:#8be9fd;font-style:italic>struct</span> {
    connector driver.Connector
    mu           sync.Mutex <span style=color:#6272a4>// protects following fields
</span><span style=color:#6272a4></span>    freeConn     []<span style=color:#ff79c6>*</span>driverConn
    <span style=color:#6272a4>// Used to signal the need for new connections
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>// a goroutine running connectionOpener() reads on this chan and
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>// maybeOpenNewConnections sends on the chan (one send per needed connection)
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>// It is closed during db.Close(). The close tells the connectionOpener
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>// goroutine to exit.
</span><span style=color:#6272a4></span>    openerCh          <span style=color:#8be9fd;font-style:italic>chan</span> <span style=color:#8be9fd;font-style:italic>struct</span>{
        closed            <span style=color:#8be9fd>bool</span>
        stop <span style=color:#8be9fd;font-style:italic>func</span>() <span style=color:#6272a4>// stop cancels the connection opener and the session resetter.
</span><span style=color:#6272a4></span>        <span style=color:#ff79c6>...</span>
}
</code></pre></div><p>sql.DB 可以操作数据库，它代表了 0 个或 1 个数据库连接池，这些连接由 sql 包进行维护。sql 包会自动的创建和释放这些连接，而且它对于多个 goroutine 并发的使用的安全的。</p><p>最后通过 sql.DB 的 Ping() 方法检查数据库连接是否成功。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#6272a4>// Ping 检查与数据库的连接是否仍有效，如果需要会创建连接。
</span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>func</span> (db <span style=color:#ff79c6>*</span>DB) <span style=color:#50fa7b>Ping</span>() <span style=color:#8be9fd>error</span>
</code></pre></div><h2 id=操作数据库>操作数据库<a href=#操作数据库 class=anchor aria-hidden=true>#</a></h2><p>在数据库 kokt 中新建一张表 userinfo 并添加一些记录：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>TABLE</span> <span style=color:#ff79c6>`</span>userinfo<span style=color:#ff79c6>`</span> (
    <span style=color:#ff79c6>`</span>uid<span style=color:#ff79c6>`</span> <span style=color:#8be9fd;font-style:italic>INT</span>(<span style=color:#bd93f9>10</span>) <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>NULL</span> AUTO_INCREMENT,
    <span style=color:#ff79c6>`</span>username<span style=color:#ff79c6>`</span> <span style=color:#8be9fd;font-style:italic>VARCHAR</span>(<span style=color:#bd93f9>64</span>) <span style=color:#ff79c6>NULL</span> <span style=color:#ff79c6>DEFAULT</span> <span style=color:#ff79c6>NULL</span>,
    <span style=color:#ff79c6>`</span>department<span style=color:#ff79c6>`</span> <span style=color:#8be9fd;font-style:italic>VARCHAR</span>(<span style=color:#bd93f9>64</span>) <span style=color:#ff79c6>NULL</span> <span style=color:#ff79c6>DEFAULT</span> <span style=color:#ff79c6>NULL</span>,
    <span style=color:#ff79c6>`</span>created<span style=color:#ff79c6>`</span> <span style=color:#8be9fd;font-style:italic>DATE</span> <span style=color:#ff79c6>NULL</span> <span style=color:#ff79c6>DEFAULT</span> <span style=color:#ff79c6>NULL</span>,
    <span style=color:#ff79c6>PRIMARY</span> <span style=color:#ff79c6>KEY</span> (<span style=color:#ff79c6>`</span>uid<span style=color:#ff79c6>`</span>)
);
</code></pre></div><p><img src=https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/20210108031143.png alt=20210108031143></p><h3 id=查询>查询<a href=#查询 class=anchor aria-hidden=true>#</a></h3><p>sql.DB 的 Query() 方法可以执行一次 select 命令，传入 SQL 语句，返回多行结果（即结构体类型 Rows）。第一个参数 query 表示 SQL 语句，第二个参数 args 表示 query 中的占位参数。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#8be9fd;font-style:italic>func</span> (db <span style=color:#ff79c6>*</span>DB) <span style=color:#50fa7b>Query</span>(query <span style=color:#8be9fd>string</span>, args <span style=color:#ff79c6>...</span><span style=color:#8be9fd;font-style:italic>interface</span>{}) (<span style=color:#ff79c6>*</span>Rows, <span style=color:#8be9fd>error</span>)
</code></pre></div><p>Rows 拥有的方法主要有：</p><ul><li>func (rs *Rows) Columns() ([]string, error)；Columns 返回列名。如果 Rows 已经关闭会返回错误。</li><li>func (rs *Rows) Scan(dest &mldr;interface{}) error；Scan 将当前行各列结果填充进 dest 指定的各个值中。</li><li>func (rs *Rows) Next() bool；Next 准备用于 Scan 方法的下一行结果。如果成功会返回真，如果没有下一行或者出现错误会返回假。</li><li>func (rs *Rows) Close() error；Close 关闭 Rows，阻止对其更多的列举。</li><li>func (rs *Rows) Err() error；Err 返回可能的、在迭代时出现的错误。Err 需在显式或隐式调用 Close 方法后调用。</li></ul><p>查询表中 departmen 字段为 marin 的记录，并将结果填充到一个结构体切片中：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#8be9fd;font-style:italic>type</span> result <span style=color:#8be9fd;font-style:italic>struct</span> {
    uid        <span style=color:#8be9fd>int</span>
    username   <span style=color:#8be9fd>string</span>
    department <span style=color:#8be9fd>string</span>
    created    <span style=color:#8be9fd>string</span>
}
<span style=color:#8be9fd;font-style:italic>var</span> results []result
department <span style=color:#ff79c6>:=</span> <span style=color:#f1fa8c>&#34;marin&#34;</span>
<span style=color:#6272a4>// 使用？传递参数
</span><span style=color:#6272a4></span>rw, err <span style=color:#ff79c6>:=</span> db.<span style=color:#50fa7b>Query</span>(<span style=color:#f1fa8c>&#34;select * from userinfo where department = ?&#34;</span>, department)
<span style=color:#ff79c6>defer</span> rw.<span style=color:#50fa7b>Close</span>()
<span style=color:#6272a4>// 当读取数据完毕后，rw.Next() 返回 false，退出循环
</span><span style=color:#6272a4></span><span style=color:#ff79c6>for</span> rw.<span style=color:#50fa7b>Next</span>() {
    <span style=color:#6272a4>// temp 代表查询得到的一条记录
</span><span style=color:#6272a4></span>    temp <span style=color:#ff79c6>:=</span> result{} 
    err = rw.<span style=color:#50fa7b>Scan</span>(<span style=color:#ff79c6>&amp;</span>temp.uid, <span style=color:#ff79c6>&amp;</span>temp.username, <span style=color:#ff79c6>&amp;</span>temp.department, <span style=color:#ff79c6>&amp;</span>temp.created)
    <span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
        log.<span style=color:#50fa7b>Fatal</span>(err)
    }
    <span style=color:#6272a4>// 将查询记录添加到结果切片中
</span><span style=color:#6272a4></span>    results = <span style=color:#8be9fd;font-style:italic>append</span>(results, temp)
}
fmt.<span style=color:#50fa7b>Println</span>(results)
</code></pre></div><p>上述程序输出结果为：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>[{<span style=color:#bd93f9>4</span> luffy marin <span style=color:#bd93f9>2020</span><span style=color:#ff79c6>-</span><span style=color:#bd93f9>01</span><span style=color:#ff79c6>-</span><span style=color:#bd93f9>31</span>} {<span style=color:#bd93f9>5</span> ace marin <span style=color:#bd93f9>2020</span><span style=color:#ff79c6>-</span><span style=color:#bd93f9>01</span><span style=color:#ff79c6>-</span><span style=color:#bd93f9>01</span>}]
</code></pre></div><h3 id=更新插入删除>更新/插入/删除<a href=#更新插入删除 class=anchor aria-hidden=true>#</a></h3><p>sql.DB 的 Exec() 方法可以执行一次命令（包括查询、删除、更新、插入等），传入 SQL 语句。返回值类型为 Result（对已执行的 SQL 命令的总结），参数 args 表示 query 中的占位参数。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#8be9fd;font-style:italic>func</span> (db <span style=color:#ff79c6>*</span>DB) <span style=color:#50fa7b>Exec</span>(query <span style=color:#8be9fd>string</span>, args <span style=color:#ff79c6>...</span><span style=color:#8be9fd;font-style:italic>interface</span>{}) (Result, <span style=color:#8be9fd>error</span>)
</code></pre></div><p>以更新命令为例，将表中 username 字段为 luffy 的记录中的 department 字段更新为 pirate：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>department <span style=color:#ff79c6>:=</span> <span style=color:#f1fa8c>&#34;pirate&#34;</span>
username <span style=color:#ff79c6>:=</span> <span style=color:#f1fa8c>&#34;luffy&#34;</span>
_, err = db.<span style=color:#50fa7b>Exec</span>(<span style=color:#f1fa8c>&#34;update userinfo set department = ? where username = ?&#34;</span>,department, username)
</code></pre></div><p>运行程序后可以发现 userinfo 表中的字段发生了改变：</p><p><img src=https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/20210108031040.png alt=20210108031040></p><h3 id=模板>模板<a href=#模板 class=anchor aria-hidden=true>#</a></h3><p>如果我们需要对一个 SQL 语句进行重复调用，例如在不同的 goroutine 中使用相同的 SQL 语句，那么声明一个模板变量是一个明智的抉择：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#8be9fd;font-style:italic>type</span> Stmt <span style=color:#8be9fd;font-style:italic>struct</span> {
    <span style=color:#6272a4>// 内含隐藏或非导出字段
</span><span style=color:#6272a4></span>}

<span style=color:#8be9fd;font-style:italic>func</span> (s <span style=color:#ff79c6>*</span>Stmt) <span style=color:#50fa7b>Exec</span>(args <span style=color:#ff79c6>...</span><span style=color:#8be9fd;font-style:italic>interface</span>{}) (Result, <span style=color:#8be9fd>error</span>)

<span style=color:#8be9fd;font-style:italic>func</span> (<span style=color:#ff79c6>*</span>Stmt) Query

<span style=color:#8be9fd;font-style:italic>func</span> (s <span style=color:#ff79c6>*</span>Stmt) <span style=color:#50fa7b>Close</span>() <span style=color:#8be9fd>error</span>
</code></pre></div><p>一般先调用 sql.DB 的 Prepare() 方法创建一个 Stmt 结构体作为模板：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#8be9fd;font-style:italic>func</span> (db <span style=color:#ff79c6>*</span>DB) <span style=color:#50fa7b>Prepare</span>(query <span style=color:#8be9fd>string</span>) (<span style=color:#ff79c6>*</span>Stmt, <span style=color:#8be9fd>error</span>)
</code></pre></div><p>然后调用 Stmt 的 Exec() 方法传入占位参数，执行模板中的 SQL 语句。以插入命令为例，向表 userinfo 中插入一条新的记录：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>username <span style=color:#ff79c6>:=</span> <span style=color:#f1fa8c>&#34;joker&#34;</span>
department <span style=color:#ff79c6>:=</span> <span style=color:#f1fa8c>&#34;movie&#34;</span>
created <span style=color:#ff79c6>:=</span> <span style=color:#f1fa8c>&#34;2020-02-14&#34;</span>
stmt, _ <span style=color:#ff79c6>:=</span> db.<span style=color:#50fa7b>Prepare</span>(<span style=color:#f1fa8c>&#34;insert into userinfo set username=?,department=?,created=?&#34;</span>)
<span style=color:#ff79c6>defer</span> stmt.<span style=color:#50fa7b>Close</span>()
<span style=color:#6272a4>// func (s *Stmt) Exec(args ...interface{}) (Result, error)
</span><span style=color:#6272a4></span>stmt.<span style=color:#50fa7b>Exec</span>(username, department, created)
</code></pre></div><p>运行程序后可以发现 userinfo 表中插入的新记录：</p><p><img src=https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/20210108025449.png alt=20210108025449></p><p class=edit-page><a href=https://github.com/koktlzz/koktlzz.github.io/blob/master/content/Programming/Go/%e4%bd%bf%e7%94%a8MySQL%e6%95%b0%e6%8d%ae%e5%ba%93.md><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2"><path d="M17 3a2.828 2.828.0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>Edit this page on GitHub</a></p><div class="docs-navigation d-flex justify-content-between"><a href=https://koktlzz.github.io/programming/go/%E6%90%AD%E5%BB%BAweb%E6%9C%8D%E5%8A%A1%E5%99%A8/><div class="card my-1"><div class="card-body py-2">&larr; 搭建 Web 服务器</div></div></a></div><script src=https://utteranc.es/client.js repo=koktlzz/koktlzz.github.io issue-term=pathname theme=photon-dark crossorigin=anonymous async></script></main><nav class="docs-toc d-none d-xl-block col-lg-3 col-xl-2" aria-label="Secondary navigation"><div class=page-links><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=#连接数据库>连接数据库</a><ul><li><a href=#数据库驱动>数据库驱动</a></li><li><a href=#调用-sqlopen>调用 sql.Open()</a></li><li><a href=#sqldb>sql.DB</a></li></ul></li><li><a href=#操作数据库>操作数据库</a><ul><li><a href=#查询>查询</a></li><li><a href=#更新插入删除>更新/插入/删除</a></li><li><a href=#模板>模板</a></li></ul></li></ul></nav></div></nav></div></div></div><script src=https://koktlzz.github.io/js/bootstrap.min.d67050adf5d370668aede4201f82af781b16970934804995a1ca37c1ee9222c2fc530972aa6d5d2b6124caf1fe318f139aac99df2c1e89af65504fc1185c7972.js integrity="sha512-1nBQrfXTcGaK7eQgH4KveBsWlwk0gEmVoco3we6SIsL8Uwlyqm1dK2EkyvH+MY8TmqyZ3yweia9lUE/BGFx5cg==" crossorigin=anonymous defer></script><script src=https://koktlzz.github.io/js/vendor/katex/dist/katex.min.b334e5b00c45f572e7f38a543046f36854bf4cbb543880480c09271a0efedc694d6905f719934f6ede2f26f52e80411c05b90121d722cbf8be2fa8fc51bc6b81.js integrity="sha512-szTlsAxF9XLn84pUMEbzaFS/TLtUOIBIDAknGg7+3GlNaQX3GZNPbt4vJvUugEEcBbkBIdciy/i+L6j8UbxrgQ==" crossorigin=anonymous defer></script><script src=https://koktlzz.github.io/js/vendor/katex/dist/contrib/auto-render.min.916823ec103cf367b71e28a6f01513cb9c3ac6708ccb5229402ec46b8e30a8b25003db694df35d80e9dd666a371f327c6152790617b6256390c164109a90bd4c.js integrity="sha512-kWgj7BA882e3Hiim8BUTy5w6xnCMy1IpQC7Ea44wqLJQA9tpTfNdgOndZmo3HzJ8YVJ5Bhe2JWOQwWQQmpC9TA==" crossorigin=anonymous defer></script><script src=https://koktlzz.github.io/main.min.1febbf2f6fd6a36fc2f57dd50d7935fbb640743329baeb4ef7cefcf2e7630e413371fbba976e103656b82808ee227dc4a84237edb0f8433648bef3a56900661a.js integrity="sha512-H+u/L2/Wo2/C9X3VDXk1+7ZAdDMpuutO98788udjDkEzcfu6l24QNla4KAjuIn3EqEI37bD4QzZIvvOlaQBmGg==" crossorigin=anonymous defer></script></body></html>