<!doctype html><html lang=en-us><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-D022F6NT2P"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-D022F6NT2P')</script><script>(function(b,d,e,a,g){b[a]=b[a]||[],b[a].push({'gtm.start':(new Date).getTime(),event:'gtm.js'});var f=d.getElementsByTagName(e)[0],c=d.createElement(e),h=a!='dataLayer'?'&l='+a:'';c.async=!0,c.src='https://www.googletagmanager.com/gtm.js?id='+g+h,f.parentNode.insertBefore(c,f)})(window,document,'script','dataLayer','GTM-P72R45W')</script><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://koktlzz.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://koktlzz.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://koktlzz.github.io/fonts/KaTeX_Main-Regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://koktlzz.github.io/fonts/KaTeX_Math-Italic.woff2 type=font/woff2 crossorigin><link rel=stylesheet href=https://koktlzz.github.io/main.27967119d9bfd1f18848f648c47494cdf9c8666df2bb5d54d01736bacd6e74dc5f8b9b2cbc827df0fc8e4cef4f4bae41b13b93c84017caf5272a107d6f2af5cc.css integrity="sha512-J5ZxGdm/0fGISPZIxHSUzfnIZm3yu11U0Bc2us1udNxfi5ssvIJ98PyOTO9PS65BsTuTyEAXyvUnKhB9byr1zA==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Operator 自定义配置 | KnowledgeBase</title><meta name=description content><link rel=canonical href=https://koktlzz.github.io/observability/prometheus/operator%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="Operator 自定义配置"><meta property="og:description" content="通常，我们需要对 Prometheus 的监控、告警规则和消息推送进行一些自定义的配置。对于部署在虚拟机的 Prometheus 和 Alertmanager 实例来说，上述配置分别对应以下文件：
 prometheus.yaml *-rules.yaml alertmanager.yaml  但如果使用 Operator 在 Kubernetes 或 Openshift 中部署 Prometheus，其 Prometheus 和 Alertmanager 实例由对应的 Operator 负责管理，自然无法通过修改 Pod 挂载的 ConfigMap 或 Secret 来更新配置。因此，我们只能直接修改与其有关的 CRD（Custom Resource Definition）配置。
Prometheus Operator 在集群中创建的 CRD 资源主要有：
 Prometheus：管理集群中的 Prometheus StatefulSet 实例； ServiceMonitor：通过 Label Selector 选取需要监控的 Endpoint 对象； Alertmanager：管理集群中的 Alertmanager StatefulSet 实例； PrometheusRule：将告警规则配置动态加载到 Prometheus 实例中。  接下来我们将分别讨论两者之间的对应关系。为了区分 CRD 资源和原生的 Prometheus 概念，文中的 CRD 名称均以斜体表示。
监控 prometheus.yaml的示例文件如下，其中各字段的定义详见 官方文档。
global: scrape_interval: 15s # Set the scrape interval to every 15 seconds."><meta property="og:url" content="https://koktlzz.github.io/observability/prometheus/operator%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE/"><meta property="og:site_name" content="KnowledgeBase"><meta property="article:published_time" content="2020-11-04T09:19:42+01:00"><meta property="article:modified_time" content="2020-11-04T09:19:42+01:00"><meta property="og:image" content="https://koktlzz.github.io/doks.png"><meta property="og:image:alt" content="KnowledgeBase"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@getdoks"><meta name=twitter:creator content="@henkverlinde"><meta name=twitter:title content="Operator 自定义配置"><meta name=twitter:description content><meta name=twitter:image content="https://koktlzz.github.io/doks.png"><meta name=twitter:image:alt content="Operator 自定义配置"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://koktlzz.github.io/#/schema/organization/1","name":"Doks","url":"https://koktlzz.github.io/","sameAs":["https://twitter.com/getdoks","https://github.com/h-enk/doks"],"logo":{"@type":"ImageObject","@id":"https://koktlzz.github.io/#/schema/image/1","url":"https://koktlzz.github.io/logo-doks.png","width":512,"height":512,"caption":"Doks"},"image":{"@id":"https://koktlzz.github.io/#/schema/image/1"}},{"@type":"WebSite","@id":"https://koktlzz.github.io/#/schema/website/1","url":"https://koktlzz.github.io/","name":"KnowledgeBase","description":"","publisher":{"@id":"https://koktlzz.github.io/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://koktlzz.github.io/observability/prometheus/operator%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE/","url":"https://koktlzz.github.io/observability/prometheus/operator%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE/","name":"Operator 自定义配置","description":"","isPartOf":{"@id":"https://koktlzz.github.io/#/schema/website/1"},"about":{"@id":"https://koktlzz.github.io/#/schema/organization/1"},"datePublished":"2020-11-04T09:19:42CET","dateModified":"2020-11-04T09:19:42CET","breadcrumb":{"@id":"https://koktlzz.github.io/observability/prometheus/operator%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://koktlzz.github.io/observability/prometheus/operator%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://koktlzz.github.io/observability/prometheus/operator%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE/"]}]},{"@type":"BreadcrumbList","@id":"https://koktlzz.github.io/observability/prometheus/operator%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://koktlzz.github.io/","url":"https://koktlzz.github.io/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://koktlzz.github.io/observability/","url":"https://koktlzz.github.io/observability/","name":"Observability"}},{"@type":"ListItem","position":3,"item":{"@type":"WebPage","@id":"https://koktlzz.github.io/observability/prometheus/","url":"https://koktlzz.github.io/observability/prometheus/","name":"Prometheus"}},{"@type":"ListItem","position":4,"item":{"@id":"https://koktlzz.github.io/observability/prometheus/operator%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://koktlzz.github.io/observability/prometheus/operator%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE/#/schema/image/2","url":"https://koktlzz.github.io/doks.png","contentUrl":"https://koktlzz.github.io/doks.png","caption":"Operator 自定义配置"}]}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=https://koktlzz.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://koktlzz.github.io/favicon-32x32.ico><link rel=icon type=image/png sizes=16x16 href=https://koktlzz.github.io/favicon-16x16.ico><link rel=manifest crossorigin=use-credentials href=https://koktlzz.github.io/site.webmanifest></head><body class="Observability single dark"><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-P72R45W" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container-fluid><input class="menu-btn order-0" type=checkbox id=menu-btn>
<label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label><a class="navbar-brand order-1 order-md-0 me-auto" href=https://koktlzz.github.io/>KnowledgeBase</a>
<button id=mode class="btn btn-link order-2 order-md-4" type=button aria-label="Toggle mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button><ul class="navbar-nav social-nav order-3 order-md-5"><li class=nav-item><a class=nav-link href=https://github.com/koktlzz><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><span class="ms-2 visually-hidden">GitHub</span></a></li></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav me-auto order-5 order-md-2"><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/container/docker/intro>Container</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/observability/elasticstack/intro>Observability</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/programming/go/intro>Programming</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/infrastructure/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/tcpip%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B>Infrastructure</a></li></ul><div class="break order-6 d-md-none"></div></div></div></header><div class="wrap container-fluid" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-4 col-xl-3 d-none d-xl-block"><nav class=docs-links aria-label="Main navigation"><h3>ElasticStack</h3><ul class=list-unstyled><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/intro/>Getting Started</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/%E5%8D%95%E8%8A%82%E7%82%B9%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B/>单节点部署流程</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/elasticsearchintro/>ElasticSearch 简介</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/mapping/>Mapping</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/textanalysis/>Text analysis</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/template/>Template</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/ilm/>ILM</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/snapshot/>Snapshot</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/>Elasticsearch 性能调优</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/kafkaintro/>Kafka 简介</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/hw/>Kafka 副本备份</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/transaction/>Kafka 事务</a></li></ul><h3>Prometheus</h3><ul class=list-unstyled><li><a class=docs-link href=https://koktlzz.github.io/observability/prometheus/intro/>Getting Started</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/prometheus/operator%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE/>Operator 自定义配置</a></li></ul><h3>Opentelemetry</h3><ul class=list-unstyled><li><a class=docs-link href=https://koktlzz.github.io/observability/opentelemetry/intro/>Getting Started</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/opentelemetry/collectorexample/>Collector Example</a></li></ul></nav></div><main class="docs-content col-lg-12 col-xl-10"><h1>Operator 自定义配置</h1><p class=lead></p><p>通常，我们需要对 Prometheus 的监控、告警规则和消息推送进行一些自定义的配置。对于部署在虚拟机的 Prometheus 和 Alertmanager 实例来说，上述配置分别对应以下文件：</p><ul><li><code>prometheus.yaml</code></li><li><code>*-rules.yaml</code></li><li><code>alertmanager.yaml</code></li></ul><p>但如果使用 Operator 在 Kubernetes 或 Openshift 中部署 Prometheus，其 Prometheus 和 Alertmanager 实例由对应的 Operator 负责管理，自然无法通过修改 Pod 挂载的 ConfigMap 或 Secret 来更新配置。因此，我们只能直接修改与其有关的 CRD（Custom Resource Definition）配置。</p><p>Prometheus Operator 在集群中创建的 CRD 资源主要有：</p><ul><li><em>Prometheus</em>：管理集群中的 Prometheus StatefulSet 实例；</li><li><em>ServiceMonitor</em>：通过 Label Selector 选取需要监控的 Endpoint 对象；</li><li><em>Alertmanager</em>：管理集群中的 Alertmanager StatefulSet 实例；</li><li><em>PrometheusRule</em>：将告警规则配置动态加载到 Prometheus 实例中。</li></ul><p>接下来我们将分别讨论两者之间的对应关系。为了区分 CRD 资源和原生的 Prometheus 概念，文中的 CRD 名称均以斜体表示。</p><h2 id=监控>监控<a href=#监控 class=anchor aria-hidden=true>#</a></h2><p><code>prometheus.yaml</code>的示例文件如下，其中各字段的定义详见 <a href=https://prometheus.io/docs/prometheus/latest/configuration/configuration/#configuration>官方文档</a>。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#ff79c6>global</span>:
  <span style=color:#ff79c6>scrape_interval</span>:     15s <span style=color:#6272a4># Set the scrape interval to every 15 seconds. Default is every 1 minute.</span>
  <span style=color:#ff79c6>evaluation_interval</span>: 15s <span style=color:#6272a4># Evaluate rules every 15 seconds. The default is every 1 minute.</span>
  <span style=color:#ff79c6>externalLabels</span>:          <span style=color:#6272a4># The labels to add to any time series or alerts when communicating with external systems (federation, remote storage, Alertmanager).</span>
    <span style=color:#ff79c6>cluster</span>: my-k8s
<span style=color:#ff79c6>alerting</span>:
  <span style=color:#ff79c6>alertmanagers</span>:
  - <span style=color:#ff79c6>static_configs</span>:
    - <span style=color:#ff79c6>targets</span>:
      <span style=color:#6272a4># - alertmanager:9093</span>
<span style=color:#ff79c6>rule_files</span>:
  <span style=color:#6272a4># - &#34;first_rules.yml&#34;</span>
  <span style=color:#6272a4># - &#34;second_rules.yml&#34;</span>
<span style=color:#ff79c6>scrape_configs</span>:
  <span style=color:#6272a4># The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span>
  - <span style=color:#ff79c6>job_name</span>: <span style=color:#f1fa8c>&#39;prometheus&#39;</span>
    <span style=color:#ff79c6>static_configs</span>:
    - <span style=color:#ff79c6>targets</span>: [<span style=color:#f1fa8c>&#39;localhost:9090&#39;</span>]
</code></pre></div><p>与之对应的 <em>Prometheus</em> 对象配置则为：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#ff79c6>apiVersion</span>: monitoring.coreos.com/v1
<span style=color:#ff79c6>kind</span>: Prometheus
<span style=color:#ff79c6>metadata</span>:
  <span style=color:#ff79c6>labels</span>:
    <span style=color:#ff79c6>prometheus</span>: k8s
  <span style=color:#ff79c6>name</span>: k8s
  <span style=color:#ff79c6>namespace</span>: openshift-monitoring
<span style=color:#ff79c6>spec</span>:
  <span style=color:#6272a4># global</span>
  <span style=color:#ff79c6>scrapeInterval</span>: 15s
  <span style=color:#ff79c6>evaluationInterval</span>: 15s
  <span style=color:#ff79c6>externalLabels</span>:
    <span style=color:#ff79c6>cluster</span>: my-k8s
  <span style=color:#6272a4># alerting</span>
  <span style=color:#ff79c6>alerting</span>:
    <span style=color:#ff79c6>alertmanagers</span>:
    - <span style=color:#ff79c6>bearerTokenFile</span>: /var/run/secrets/kubernetes.io/serviceaccount/token
      <span style=color:#ff79c6>name</span>: alertmanager-main
      <span style=color:#ff79c6>namespace</span>: openshift-monitoring
      <span style=color:#ff79c6>port</span>: web
      <span style=color:#ff79c6>scheme</span>: https
      <span style=color:#ff79c6>tlsConfig</span>:
        <span style=color:#ff79c6>ca</span>: {}
        <span style=color:#ff79c6>caFile</span>: /etc/prometheus/configmaps/serving-certs-ca-bundle/service-ca.crt
        <span style=color:#ff79c6>cert</span>: {}
        <span style=color:#ff79c6>serverName</span>: alertmanager-main.openshift-monitoring.svc
  <span style=color:#6272a4># rule_file</span>
  <span style=color:#ff79c6>ruleNamespaceSelector</span>: {}
  <span style=color:#ff79c6>ruleSelector</span>:
    <span style=color:#ff79c6>matchLabels</span>:
      <span style=color:#ff79c6>prometheus</span>: k8s
      <span style=color:#ff79c6>role</span>: alert-rules
  <span style=color:#6272a4># scrape_configs</span>
  <span style=color:#ff79c6>serviceMonitorNamespaceSelector</span>: {}
  <span style=color:#ff79c6>serviceMonitorSelector</span>:
    <span style=color:#ff79c6>matchLabels</span>:
      <span style=color:#ff79c6>k8s-app</span>: node-exporter
</code></pre></div><p>其中，<code>global</code>下属的子字段（如<code>scrape_interval</code>、<code>evaluation_interval</code>和<code>externalLabels</code>）可以在 <em>Prometheus</em> 的<code>spec</code>中直接定义，不过写法有所差异。全部的字段对应关系可以查看 Prometheus Operator 官方给出的 <a href=https://github.com/prometheus-operator/prometheus-operator/blob/master/Documentation/api.md#prometheusspec>API 文档</a>。</p><p>值得注意的是，如果是在 Openshift 而非原生的 Kubernetes 集群中，使用<code>oc edit prometheus</code>来修改<code>spec</code>会在一段时间后回退为默认配置。我们需要在 openshift-monitoring 的 project 中创建一个名为 cluster-monitoring-config 的 ConfigMap，只有在其中定义全局配置才会生效：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#ff79c6>apiVersion</span>: v1
<span style=color:#ff79c6>data</span>:
  <span style=color:#ff79c6>config.yaml</span>: |<span style=color:#f1fa8c>
</span><span style=color:#f1fa8c>    prometheusK8s:
</span><span style=color:#f1fa8c>      scrapeInterval: 15s
</span><span style=color:#f1fa8c>      evaluationInterval: 15s
</span><span style=color:#f1fa8c>      externalLabels:
</span><span style=color:#f1fa8c>        cluster: my-k8s</span>    
<span style=color:#ff79c6>kind</span>: ConfigMap
<span style=color:#ff79c6>metadata</span>:
  <span style=color:#ff79c6>name</span>: cluster-monitoring-config
  <span style=color:#ff79c6>namespace</span>: openshift-monitoring
</code></pre></div><p>由于 Alertmanger 实例是由其对应的 CRD 对象管理的，因此<code>alerting</code>下属的子字段不再是静态配置（static_configs），而是 <em>Alertmanager</em> 对象及其证书信息。</p><p><code>scrape_configs</code>和<code>rule_file</code>下属的配置则需要在与该 <em>Prometheus</em> 关联的 <em>ServiceMonitor</em> 和 <em>PrometheusRule</em> 对象中声明，它们分别由对应的 Selector 字段（<code>serviceMonitorNamespaceSelector</code>、<code>serviceMonitorSelector</code>、<code>ruleNamespaceSelector</code>和<code>ruleSelector</code>）所指定。Selector 字段值类型均为 Kubernetes 中的 *<a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.17/#labelselector-v1-meta>metav1.LabelSelector</a>，因此一个空的 Label Selector 将选取所有对象。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#ff79c6>apiVersion</span>: monitoring.coreos.com/v1
<span style=color:#ff79c6>kind</span>: ServiceMonitor
<span style=color:#ff79c6>metadata</span>:
  <span style=color:#ff79c6>labels</span>:
    <span style=color:#ff79c6>k8s-app</span>: node-exporter
  <span style=color:#ff79c6>name</span>: node-exporter
  <span style=color:#ff79c6>namespace</span>: openshift-monitoring
<span style=color:#ff79c6>spec</span>:
  <span style=color:#ff79c6>endpoints</span>:
  - <span style=color:#ff79c6>bearerTokenFile</span>: /var/run/secrets/kubernetes.io/serviceaccount/token
    <span style=color:#ff79c6>bearerTokenSecret</span>:
      <span style=color:#ff79c6>key</span>: <span style=color:#f1fa8c>&#34;&#34;</span>
    <span style=color:#ff79c6>interval</span>: 30s
    <span style=color:#ff79c6>port</span>: https
    <span style=color:#ff79c6>relabelings</span>:
    - <span style=color:#ff79c6>action</span>: replace
      <span style=color:#ff79c6>regex</span>: (.*)
      <span style=color:#ff79c6>replacement</span>: $1
      <span style=color:#ff79c6>sourceLabels</span>:
      - __meta_kubernetes_pod_node_name
      <span style=color:#ff79c6>targetLabel</span>: instance
    <span style=color:#ff79c6>scheme</span>: https
    <span style=color:#ff79c6>tlsConfig</span>:
      <span style=color:#ff79c6>ca</span>: {}
      <span style=color:#ff79c6>caFile</span>: /etc/prometheus/configmaps/serving-certs-ca-bundle/service-ca.crt
      <span style=color:#ff79c6>cert</span>: {}
      <span style=color:#ff79c6>serverName</span>: node-exporter.openshift-monitoring.svc
  <span style=color:#ff79c6>jobLabel</span>: k8s-app
  <span style=color:#ff79c6>namespaceSelector</span>: {}
  <span style=color:#ff79c6>selector</span>:
    <span style=color:#ff79c6>matchLabels</span>:
      <span style=color:#ff79c6>k8s-app</span>: node-exporter
</code></pre></div><p>该 <em>ServiceMonitor</em> 的 Label 为<code>k8s-app: node-exporter</code>，因此会被示例的 <em>Prometheus</em> 对象选取。<em>ServiceMonitor</em> 的详细字段定义同样可以在 <a href=https://github.com/prometheus-operator/prometheus-operator/blob/master/Documentation/api.md#servicemonitorspec>API 文档</a> 中查阅，此处简单介绍几个常用的字段：</p><ul><li><code>endpoint.interval</code>：与全局的<code>scrapeInterval</code>相比，该字段只对选取的 Endpoint 对象有效；</li><li><code>endpoint.port</code>：Endpoint 暴露的 metrics 端口，即 Service 中的<code>targetPort</code>；</li><li><code>endpoint.relabeling</code>：等效于<code>prometheus.yaml</code>文件中的<code>relabel_config</code>字段；</li><li><code>jobLabel</code>：该字段值 k8s-app 将从<code>selector.matchLabels</code>中选取 node-exporter 作为数据的 job 标签，相当于在<code>prometheus.yaml</code>文件中指定<code>job_name</code>为node-exporter；</li><li><code>namespaceSelector</code>： 指定 Endpoint 对象所在的 Namespace，若设置<code>any: true</code>则将选取所有的 Namespace；</li><li><code>selector</code>：通过 Label Selector 选取需要监控的 Endpoint 对象。</li></ul><p>对 <em>Prometheus</em> 和 <em>ServiceMonitor</em> 配置完毕后，我们可以在 Prometheus 容器中的<code>/etc/prometheus/config_out</code>目录下找到文件<code>prometheus.env.yaml</code>，它将代替<code>/etc/prometheus/prometheus.yaml</code>作为 Prometheus 实例的配置文件。</p><h2 id=告警规则>告警规则<a href=#告警规则 class=anchor aria-hidden=true>#</a></h2><p>告警规则的配置应在 <em>PrometheusRule</em> 对象中进行声明，其形式与<code>*-rules.yaml</code>完全相同：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#ff79c6>apiVersion</span>: monitoring.coreos.com/v1
<span style=color:#ff79c6>kind</span>: PrometheusRule
<span style=color:#ff79c6>metadata</span>:
  <span style=color:#ff79c6>labels</span>:
    <span style=color:#ff79c6>prometheus</span>: k8s
    <span style=color:#ff79c6>role</span>: alert-rules
  <span style=color:#ff79c6>name</span>: app-rules
  <span style=color:#ff79c6>namespace</span>: openshift-monitoring
<span style=color:#ff79c6>spec</span>:
  <span style=color:#ff79c6>groups</span>:
  - <span style=color:#ff79c6>name</span>: app-rules
    <span style=color:#ff79c6>rules</span>:
    - <span style=color:#ff79c6>alert</span>: APP_NotReady
      <span style=color:#ff79c6>annotations</span>:
        <span style=color:#ff79c6>description</span>: <span style=color:#ff79c6>No</span> any pod is ready for app {{ $labels.container}} .
        <span style=color:#ff79c6>summary</span>: App Not Ready
      <span style=color:#ff79c6>expr</span>: sum(kube_pod_container_status_ready{namespace=&#34;app&#34;,container != &#34;deployment&#34;})
        by (container) &lt; 1
      <span style=color:#ff79c6>for</span>: 1m
      <span style=color:#ff79c6>labels</span>:
        <span style=color:#ff79c6>severity</span>: critical
        <span style=color:#ff79c6>user</span>: app-admin
</code></pre></div><p>该对象的 Label 为<code>prometheus: k8s</code>和<code>role: alert-rules</code>，因此会被示例的 <em>Prometheus</em> 对象选取。同样，我们可以在 Prometheus 容器中的<code>/etc/prometheus/rules</code>目录下找到对应的<code>*-rules.yaml</code>文件。</p><h2 id=消息推送>消息推送<a href=#消息推送 class=anchor aria-hidden=true>#</a></h2><p>告警消息推送的配置在 Alertmanager StatefulSet 挂载的 Secret 中，我们将其中的内容使用 Base64 解码：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#ff79c6>[</span>root@bastion ~<span style=color:#ff79c6>]</span><span style=color:#6272a4># oc -n openshift-monitoring get secret alertmanager-main --template=&#39;{{ index .data &#34;alertmanager.yaml&#34; }}&#39; |base64 -d &gt; alertmanager.yaml</span>
<span style=color:#ff79c6>[</span>root@bastion ~<span style=color:#ff79c6>]</span><span style=color:#6272a4># cat alertmanager.yaml </span>
global:
  smtp_smarthost: <span style=color:#f1fa8c>&#34;******&#34;</span>
  smtp_from: <span style=color:#f1fa8c>&#34;prometheus@me.com&#34;</span>
route:
  group_by: <span style=color:#ff79c6>[</span>alertname<span style=color:#ff79c6>]</span>
  receiver: default
receivers:
  - name: default
    email_configs:
      - to: <span style=color:#f1fa8c>&#34;app@me.com&#34;</span>
        send_resolved: <span style=color:#8be9fd;font-style:italic>true</span>
</code></pre></div><p>因此，我们可以直接修改名为 alertmanager-main 的 Secret 来修改 Alertmanager 的告警消息推送配置。</p><h2 id=参考文献>参考文献<a href=#参考文献 class=anchor aria-hidden=true>#</a></h2><p><a href=https://prometheus.io/docs/prometheus/latest/configuration/configuration/#configuration>Prometheus Configuration</a></p><p><a href=https://github.com/prometheus-operator/prometheus-operator/blob/master/Documentation/api.md>Prometheus Operator API</a></p><p><a href=https://access.redhat.com/solutions/4931911>How to configure prometheus remote_write / remoteWrite in OpenShift Container Platform 4.x</a></p><p><a href=https://v1-17.docs.kubernetes.io/docs/reference/generated/kubernetes-api/v1.17/#-strong-api-overview-strong->Kubernetes API Reference Docs</a></p><p class=edit-page><a href=https://github.com/koktlzz/koktlzz.github.io/blob/master/content/Observability/Prometheus/Operator%e8%87%aa%e5%ae%9a%e4%b9%89%e9%85%8d%e7%bd%ae.md><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2"><path d="M17 3a2.828 2.828.0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>Edit this page on GitHub</a></p><div class="docs-navigation d-flex justify-content-between"><a href=https://koktlzz.github.io/observability/prometheus/intro/><div class="card my-1"><div class="card-body py-2">&larr; Getting Started</div></div></a><a class=ms-auto href=https://koktlzz.github.io/observability/opentelemetry/intro/><div class="card my-1"><div class="card-body py-2">Getting Started &rarr;</div></div></a></div><script src=https://utteranc.es/client.js repo=koktlzz/koktlzz.github.io issue-term=pathname theme=photon-dark crossorigin=anonymous async></script></main><nav class="docs-toc d-none d-xl-block col-lg-3 col-xl-2" aria-label="Secondary navigation"><div class=page-links><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=#监控>监控</a></li><li><a href=#告警规则>告警规则</a></li><li><a href=#消息推送>消息推送</a></li><li><a href=#参考文献>参考文献</a></li></ul></nav></div></nav></div></div></div><script src=https://koktlzz.github.io/js/bootstrap.min.d67050adf5d370668aede4201f82af781b16970934804995a1ca37c1ee9222c2fc530972aa6d5d2b6124caf1fe318f139aac99df2c1e89af65504fc1185c7972.js integrity="sha512-1nBQrfXTcGaK7eQgH4KveBsWlwk0gEmVoco3we6SIsL8Uwlyqm1dK2EkyvH+MY8TmqyZ3yweia9lUE/BGFx5cg==" crossorigin=anonymous defer></script><script src=https://koktlzz.github.io/js/vendor/katex/dist/katex.min.b334e5b00c45f572e7f38a543046f36854bf4cbb543880480c09271a0efedc694d6905f719934f6ede2f26f52e80411c05b90121d722cbf8be2fa8fc51bc6b81.js integrity="sha512-szTlsAxF9XLn84pUMEbzaFS/TLtUOIBIDAknGg7+3GlNaQX3GZNPbt4vJvUugEEcBbkBIdciy/i+L6j8UbxrgQ==" crossorigin=anonymous defer></script><script src=https://koktlzz.github.io/js/vendor/katex/dist/contrib/auto-render.min.916823ec103cf367b71e28a6f01513cb9c3ac6708ccb5229402ec46b8e30a8b25003db694df35d80e9dd666a371f327c6152790617b6256390c164109a90bd4c.js integrity="sha512-kWgj7BA882e3Hiim8BUTy5w6xnCMy1IpQC7Ea44wqLJQA9tpTfNdgOndZmo3HzJ8YVJ5Bhe2JWOQwWQQmpC9TA==" crossorigin=anonymous defer></script><script src=https://koktlzz.github.io/main.min.1febbf2f6fd6a36fc2f57dd50d7935fbb640743329baeb4ef7cefcf2e7630e413371fbba976e103656b82808ee227dc4a84237edb0f8433648bef3a56900661a.js integrity="sha512-H+u/L2/Wo2/C9X3VDXk1+7ZAdDMpuutO98788udjDkEzcfu6l24QNla4KAjuIn3EqEI37bD4QzZIvvOlaQBmGg==" crossorigin=anonymous defer></script></body></html>