<!doctype html><html lang=en-us><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-D022F6NT2P"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-D022F6NT2P')</script><script>(function(b,d,e,a,g){b[a]=b[a]||[],b[a].push({'gtm.start':(new Date).getTime(),event:'gtm.js'});var f=d.getElementsByTagName(e)[0],c=d.createElement(e),h=a!='dataLayer'?'&l='+a:'';c.async=!0,c.src='https://www.googletagmanager.com/gtm.js?id='+g+h,f.parentNode.insertBefore(c,f)})(window,document,'script','dataLayer','GTM-P72R45W')</script><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://koktlzz.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://koktlzz.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://koktlzz.github.io/fonts/KaTeX_Main-Regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://koktlzz.github.io/fonts/KaTeX_Math-Italic.woff2 type=font/woff2 crossorigin><link rel=stylesheet href=https://koktlzz.github.io/main.c0a326aac8520a62438538689a1c0d4f407d29cb8008a79181cc47b1abf30dabb964d49559fe59ca12ab3bd551bf41abb29c58bbcdbf661bcf690afb189fd2e6.css integrity="sha512-wKMmqshSCmJDhThomhwNT0B9KcuACKeRgcxHsavzDau5ZNSVWf5ZyhKrO9VRv0GrspxYu82/ZhvPaQr7GJ/S5g==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Snapshot | Inspire Hub</title><meta name=description content><link rel=canonical href=https://koktlzz.github.io/elastic/elasticsearch/snapshot/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="Snapshot"><meta property="og:description" content="我们可以对整个 Elasticsearch 集群或集群中的部分索引/数据流拍摄快照，从而实现数据的备份。
快照仓库 在创建快照前，我们必须注册一个可以存放快照的仓库 snapshot repository。snapshot repository 既可以是本地仓库，也可以是云服务商通过 对象存储技术（Object-based Storage）提供的远程仓库，如 Amazon S3, HDFS, Microsoft Azure, 和 Google Cloud Storage 等。如果在多个集群中注册同一快照存储库，则应当只有一个集群具有对该仓库的读写权限，仓库对其他集群应设置为只读。
我们可以通过 Snapshot and restore APIs 创建、查看或删除快照仓库，也可以在 Elastic Cloud 的管理界面直接手动操作。
快照生命周期管理 当我们创建了一个快照仓库后，便可以通过 Snapshot and restore APIs 手动为集群中的索引或数据流创建快照了。但在实际应用中，我们往往需要 Elasticsearch 能够每隔一段时间便自动拍摄快照，这便是快照生命周期管理 SLM（Snapshot Lifecycle Management）策略的作用。
PUT /_slm/policy/nightly-snapshots { &#34;schedule&#34;: &#34;0 30 1 * * ?&#34;, // 每天的 1:30 分拍摄快照（UTC 时间） &#34;name&#34;: &#34;<nightly-snap-{now/d}>&#34;, // 快照名称以 nightly-snap-开头，以拍摄日期结尾 &#34;repository&#34;: &#34;my_repository&#34;, // 快照存放于名为 my_repository 的快照仓库中 &#34;config&#34;: { &#34;indices&#34;: [&#34;*&#34;] // 对所有索引/数据流拍摄快照 }, &#34;retention&#34;: { // 快照的保留策略与上方快照创建任务的执行无关，但仅对 SLM 创建的快照有效，不会作用于手动创建的快照上 &#34;expire_after&#34;: &#34;30d&#34;, // 每个快照保留 30 天 &#34;min_count&#34;: 5, // 快照最少保留 5 个（若不足 5 个，则即使超过 30 天也不会删除） &#34;max_count&#34;: 50 // 快照最多保留 50 个（若超过 50 个，则即使不足 30 天也会删除） } } 在 Elastic Cloud 创建 SLM 策略则更加方便："><meta property="og:url" content="https://koktlzz.github.io/elastic/elasticsearch/snapshot/"><meta property="og:site_name" content="Inspire Hub"><meta property="article:published_time" content="2020-11-04T09:19:42+01:00"><meta property="article:modified_time" content="2020-11-04T09:19:42+01:00"><meta property="og:image" content="https://koktlzz.github.io/doks.png"><meta property="og:image:alt" content="Inspire Hub"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@getdoks"><meta name=twitter:creator content="@henkverlinde"><meta name=twitter:title content="Snapshot"><meta name=twitter:description content><meta name=twitter:image content="https://koktlzz.github.io/doks.png"><meta name=twitter:image:alt content="Snapshot"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://koktlzz.github.io/#/schema/organization/1","name":"Doks","url":"https://koktlzz.github.io/","sameAs":["https://twitter.com/getdoks","https://github.com/h-enk/doks"],"logo":{"@type":"ImageObject","@id":"https://koktlzz.github.io/#/schema/image/1","url":"https://koktlzz.github.io/logo-doks.png","width":512,"height":512,"caption":"Doks"},"image":{"@id":"https://koktlzz.github.io/#/schema/image/1"}},{"@type":"WebSite","@id":"https://koktlzz.github.io/#/schema/website/1","url":"https://koktlzz.github.io/","name":"Inspire Hub","description":"","publisher":{"@id":"https://koktlzz.github.io/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://koktlzz.github.io/elastic/elasticsearch/snapshot/","url":"https://koktlzz.github.io/elastic/elasticsearch/snapshot/","name":"Snapshot","description":"","isPartOf":{"@id":"https://koktlzz.github.io/#/schema/website/1"},"about":{"@id":"https://koktlzz.github.io/#/schema/organization/1"},"datePublished":"2020-11-04T09:19:42CET","dateModified":"2020-11-04T09:19:42CET","breadcrumb":{"@id":"https://koktlzz.github.io/elastic/elasticsearch/snapshot/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://koktlzz.github.io/elastic/elasticsearch/snapshot/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://koktlzz.github.io/elastic/elasticsearch/snapshot/"]}]},{"@type":"BreadcrumbList","@id":"https://koktlzz.github.io/elastic/elasticsearch/snapshot/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://koktlzz.github.io/","url":"https://koktlzz.github.io/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://koktlzz.github.io/elastic/","url":"https://koktlzz.github.io/elastic/","name":"Elastic"}},{"@type":"ListItem","position":3,"item":{"@type":"WebPage","@id":"https://koktlzz.github.io/elastic/elasticsearch/","url":"https://koktlzz.github.io/elastic/elasticsearch/","name":"Elasticsearch"}},{"@type":"ListItem","position":4,"item":{"@id":"https://koktlzz.github.io/elastic/elasticsearch/snapshot/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://koktlzz.github.io/elastic/elasticsearch/snapshot/#/schema/image/2","url":"https://koktlzz.github.io/doks.png","contentUrl":"https://koktlzz.github.io/doks.png","caption":"Snapshot"}]}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=https://koktlzz.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://koktlzz.github.io/favicon-32x32.ico><link rel=icon type=image/png sizes=16x16 href=https://koktlzz.github.io/favicon-16x16.ico><link rel=manifest crossorigin=use-credentials href=https://koktlzz.github.io/site.webmanifest></head><body class="Elastic single dark"><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-P72R45W" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container-fluid><input class="menu-btn order-0" type=checkbox id=menu-btn>
<label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label><a class="navbar-brand order-1 order-md-0 me-auto" href=https://koktlzz.github.io/>Inspire Hub</a>
<button id=mode class="btn btn-link order-2 order-md-4" type=button aria-label="Toggle mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button><ul class="navbar-nav social-nav order-3 order-md-5"><li class=nav-item><a class=nav-link href=https://github.com/koktlzz><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><span class="ms-2 visually-hidden">GitHub</span></a></li></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav me-auto order-5 order-md-2"><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/docker/docker%E5%9F%BA%E7%A1%80/intro>Docker</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/kubernetes/kubernetes%E5%9F%BA%E7%A1%80/intro>Kubernetes</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/elastic/elasticstack/intro>Elastic</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/go/go%E5%9F%BA%E7%A1%80/intro>Go</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/infra/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/tcpip%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B>Infra</a></li></ul><div class="break order-6 d-md-none"></div></div></div></header><div class="wrap container-fluid" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-3 col-xl-2 d-none d-xl-block"><nav class=docs-links aria-label="Main navigation"><h3>ElasticStack</h3><ul class=list-unstyled><li><a class=docs-link href=https://koktlzz.github.io/elastic/elasticstack/intro/>Get Started</a></li><li><a class=docs-link href=https://koktlzz.github.io/elastic/elasticstack/%E5%8D%95%E8%8A%82%E7%82%B9%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B/>单节点部署流程</a></li></ul><h3>Elasticsearch</h3><ul class=list-unstyled><li><a class=docs-link href=https://koktlzz.github.io/elastic/elasticsearch/infrastructure/>Infrastructure</a></li><li><a class=docs-link href=https://koktlzz.github.io/elastic/elasticsearch/mapping/>Mapping</a></li><li><a class=docs-link href=https://koktlzz.github.io/elastic/elasticsearch/textanalysis/>Text analysis</a></li><li><a class=docs-link href=https://koktlzz.github.io/elastic/elasticsearch/template/>Template</a></li><li><a class=docs-link href=https://koktlzz.github.io/elastic/elasticsearch/ilm/>ILM</a></li><li><a class=docs-link href=https://koktlzz.github.io/elastic/elasticsearch/snapshot/>Snapshot</a></li><li><a class=docs-link href=https://koktlzz.github.io/elastic/elasticsearch/%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/>性能调优</a></li></ul><h3>Kafka</h3><ul class=list-unstyled><li><a class=docs-link href=https://koktlzz.github.io/elastic/kafka/intro/>Intro</a></li><li><a class=docs-link href=https://koktlzz.github.io/elastic/kafka/hw/>副本备份机制</a></li><li><a class=docs-link href=https://koktlzz.github.io/elastic/kafka/transaction/>事务</a></li></ul></nav></div><main class="docs-content col-lg-13 col-xl-11"><h1>Snapshot</h1><p class=lead></p><p>我们可以对整个 Elasticsearch 集群或集群中的部分索引/数据流拍摄快照，从而实现数据的备份。</p><h2 id=快照仓库>快照仓库<a href=#快照仓库 class=anchor aria-hidden=true>#</a></h2><p>在创建快照前，我们必须注册一个可以存放快照的仓库 snapshot repository。snapshot repository 既可以是本地仓库，也可以是云服务商通过 <a href=https://www.zhihu.com/question/21536660>对象存储技术</a>（Object-based Storage）提供的远程仓库，如 Amazon S3, HDFS, Microsoft Azure, 和 Google Cloud Storage 等。如果在多个集群中注册同一快照存储库，则应当只有一个集群具有对该仓库的读写权限，仓库对其他集群应设置为只读。</p><p>我们可以通过 <a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshot-restore-apis.html>Snapshot and restore APIs</a> 创建、查看或删除快照仓库，也可以在 Elastic Cloud 的管理界面直接手动操作。</p><p><img src=https://cdn.jsdelivr.net/gh/koktlzz/NoteImg@main/20210308145624.png alt=20210308145624></p><h2 id=快照生命周期管理>快照生命周期管理<a href=#快照生命周期管理 class=anchor aria-hidden=true>#</a></h2><p>当我们创建了一个快照仓库后，便可以通过 <a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshot-restore-apis.html>Snapshot and restore APIs</a> 手动为集群中的索引或数据流创建快照了。但在实际应用中，我们往往需要 Elasticsearch 能够每隔一段时间便自动拍摄快照，这便是快照生命周期管理 SLM（Snapshot Lifecycle Management）策略的作用。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>PUT /_slm/policy/nightly-snapshots
{
  <span style=color:#ff79c6>&#34;schedule&#34;</span>: <span style=color:#f1fa8c>&#34;0 30 1 * * ?&#34;</span>,          // 每天的 1:30 分拍摄快照（UTC 时间）
  <span style=color:#ff79c6>&#34;name&#34;</span>: <span style=color:#f1fa8c>&#34;&lt;nightly-snap-{now/d}&gt;&#34;</span>,    // 快照名称以 nightly-snap-开头，以拍摄日期结尾
  <span style=color:#ff79c6>&#34;repository&#34;</span>: <span style=color:#f1fa8c>&#34;my_repository&#34;</span>,       // 快照存放于名为 my_repository 的快照仓库中
  <span style=color:#ff79c6>&#34;config&#34;</span>: { 
    <span style=color:#ff79c6>&#34;indices&#34;</span>: [<span style=color:#f1fa8c>&#34;*&#34;</span>]                   // 对所有索引/数据流拍摄快照
  },
  <span style=color:#ff79c6>&#34;retention&#34;</span>: {                       // 快照的保留策略与上方快照创建任务的执行无关，但仅对 SLM 创建的快照有效，不会作用于手动创建的快照上
    <span style=color:#ff79c6>&#34;expire_after&#34;</span>: <span style=color:#f1fa8c>&#34;30d&#34;</span>,             // 每个快照保留 30 天
    <span style=color:#ff79c6>&#34;min_count&#34;</span>: <span style=color:#bd93f9>5</span>,                    // 快照最少保留 5 个（若不足 5 个，则即使超过 30 天也不会删除）
    <span style=color:#ff79c6>&#34;max_count&#34;</span>: <span style=color:#bd93f9>50</span>                    // 快照最多保留 <span style=color:#bd93f9>50</span> 个（若超过 <span style=color:#bd93f9>50</span> 个，则即使不足 <span style=color:#bd93f9>30</span> 天也会删除）
  }
}
</code></pre></div><p>在 Elastic Cloud 创建 SLM 策略则更加方便：</p><p><img src=https://cdn.jsdelivr.net/gh/koktlzz/NoteImg@main/20210308145949.png alt=20210308145949></p><p><img src=https://cdn.jsdelivr.net/gh/koktlzz/NoteImg@main/20210308150115.png alt=20210308150115></p><p>当集群中索引的写入量很大时，SLM 通常与 ILM 搭配使用。想象一个场景：需要保留索引中近三年的数据，但大多数情况下只需查询近两个月的数据。针对这种情况，我们可以将索引 ILM 策略中的 Delete 动作设置为每隔 60 天执行一次，同时 SLM 策略为每隔 55 天（小于 60 即可）拍摄一次快照，保留快照的最大数量为<code>365*3/55</code>，即 20 个。这样的话，近 60 天内的索引都将保存在集群中可供搜索。而一旦我们需要查询更久远的数据，只需恢复对应时间的快照即可。</p><p>同样，我们可以使用 API 查看 SLM 策略的执行情况：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>GET /_slm/stats

// 返回
{
  <span style=color:#ff79c6>&#34;retention_runs&#34;</span>: <span style=color:#bd93f9>13</span>,                           // 快照保留策略执行的次数
  <span style=color:#ff79c6>&#34;retention_failed&#34;</span>: <span style=color:#bd93f9>0</span>,                       
  <span style=color:#ff79c6>&#34;retention_timed_out&#34;</span>: <span style=color:#bd93f9>0</span>, 
  <span style=color:#ff79c6>&#34;retention_deletion_time&#34;</span>: <span style=color:#f1fa8c>&#34;1.4s&#34;</span>,              // 执行快照保留策略时删除快照的总用时
  <span style=color:#ff79c6>&#34;retention_deletion_time_millis&#34;</span>: <span style=color:#bd93f9>1404</span>,
  <span style=color:#ff79c6>&#34;policy_stats&#34;</span>: [
    {
      <span style=color:#ff79c6>&#34;policy&#34;</span>: <span style=color:#f1fa8c>&#34;daily-snapshots&#34;</span>,
      <span style=color:#ff79c6>&#34;snapshots_taken&#34;</span>: <span style=color:#bd93f9>1</span>,                       // daily-snapshots 策略下创建的快照数
      <span style=color:#ff79c6>&#34;snapshots_failed&#34;</span>: <span style=color:#bd93f9>1</span>,
      <span style=color:#ff79c6>&#34;snapshots_deleted&#34;</span>: <span style=color:#bd93f9>0</span>, 
      <span style=color:#ff79c6>&#34;snapshot_deletion_failures&#34;</span>: <span style=color:#bd93f9>0</span> 
    }
  ],
  <span style=color:#ff79c6>&#34;total_snapshots_taken&#34;</span>: <span style=color:#bd93f9>1</span>,                     // 所有策略创建的总快照数
  <span style=color:#ff79c6>&#34;total_snapshots_failed&#34;</span>: <span style=color:#bd93f9>1</span>,
  <span style=color:#ff79c6>&#34;total_snapshots_deleted&#34;</span>: <span style=color:#bd93f9>0</span>, 
  <span style=color:#ff79c6>&#34;total_snapshot_deletion_failures&#34;</span>: <span style=color:#bd93f9>0</span> 
}
</code></pre></div><h2 id=可搜索快照>可搜索快照<a href=#可搜索快照 class=anchor aria-hidden=true>#</a></h2><h3 id=创建>创建<a href=#创建 class=anchor aria-hidden=true>#</a></h3><p>为不经常被搜索的索引创建可搜索快照，可以节省维护分片副本所消耗的资源，同时也能确保搜索性能不会太差。可以通过 <a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/searchable-snapshots-api-mount-snapshot.html>Mount snapshot API</a> 创建一个与可搜索快照相关联（mount）的索引，例如：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>POST /_snapshot/&lt;repository&gt;/&lt;snapshot&gt;/_mount
{
  <span style=color:#ff79c6>&#34;index&#34;</span>: <span style=color:#f1fa8c>&#34;my_docs&#34;</span>,                // 快照中被关联的索引
  <span style=color:#ff79c6>&#34;renamed_index&#34;</span>: <span style=color:#f1fa8c>&#34;docs&#34;</span>,           // 新创建的集群中的索引
  <span style=color:#ff79c6>&#34;index_settings&#34;</span>: { 
    <span style=color:#ff79c6>&#34;index.number_of_replicas&#34;</span>: <span style=color:#bd93f9>0</span>    // 对新索引的设置
  }
}
</code></pre></div><p>当新索引创建成功后，其分片所在节点会开始从快照仓库中同步数据。当数据同步完毕后，节点无需再次访问快照仓库而是使用本地的数据来响应搜索请求，因此索引的搜索性能并不会降低太多。默认情况下，与可搜索快照关联的索引副本数为 0。如果为了提高搜索性能，可以修改索引设置中的<code>index.number_of_replicas</code>参数来增加副本数。</p><h3 id=恢复>恢复<a href=#恢复 class=anchor aria-hidden=true>#</a></h3><p>当存放与可搜索快照关联的索引的节点故障后，索引将被 Elasticsearch 重新分配到其他健康节点上。与创建索引时相同，节点可以直接从存储快照的仓库中恢复数据，这便是该类索引不需要副本也能保持高可用的原因。</p><h3 id=使用>使用<a href=#使用 class=anchor aria-hidden=true>#</a></h3><p>通常，可搜索快照的应用场景有以下两种：</p><ul><li>手动使用 Mount snapshot API 创建一个新索引，从而让快照中被关联的索引可搜索；</li><li>对于已存在的索引，配置 ILM 策略使其进入 Cold 阶段时，自动执行 Searchable Snapshot 动作。该动作将为该索引创建一个可搜索快照，并与之相关联。</li></ul><p>如果可搜索快照中包含了多个索引，那么在将快照与索引关联前，最好先 clone 一个只包含需要搜索的索引的快照，然后再进行关联操作。这样做的好处是每个索引都关联了一份独立的快照，方便分别对其进行生命周期管理。否则，只要快照被删除，那么所有与之关联的索引都会失去高可用性。</p><p>另外，建议在关联操作前，将索引每个分片都强制合并（<a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-forcemerge.html>force-merge</a>）为一个 segment，这样节点同步快照中的数据时会减少许多资源消耗。</p><p class=edit-page><a href=https://github.com/koktlzz/koktlzz.github.io/blob/master/content/Elastic/Elasticsearch/Snapshot.md><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2"><path d="M17 3a2.828 2.828.0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>Edit this page on GitHub</a></p><div class="docs-navigation d-flex justify-content-between"><a href=https://koktlzz.github.io/elastic/elasticsearch/ilm/><div class="card my-1"><div class="card-body py-2">&larr; ILM</div></div></a><a class=ms-auto href=https://koktlzz.github.io/elastic/elasticsearch/%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/><div class="card my-1"><div class="card-body py-2">性能调优 &rarr;</div></div></a></div><script src=https://utteranc.es/client.js repo=koktlzz/koktlzz.github.io issue-term=pathname theme=photon-dark crossorigin=anonymous async></script></main><nav class="docs-toc d-none d-xl-block col-lg-3 col-xl-2" aria-label="Secondary navigation"><div class=page-links><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=#快照仓库>快照仓库</a></li><li><a href=#快照生命周期管理>快照生命周期管理</a></li><li><a href=#可搜索快照>可搜索快照</a><ul><li><a href=#创建>创建</a></li><li><a href=#恢复>恢复</a></li><li><a href=#使用>使用</a></li></ul></li></ul></nav></div></nav></div></div></div><footer class="footer text-muted"><div class=container><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline></ul></div></div></div></footer><script src=https://koktlzz.github.io/js/bootstrap.min.d67050adf5d370668aede4201f82af781b16970934804995a1ca37c1ee9222c2fc530972aa6d5d2b6124caf1fe318f139aac99df2c1e89af65504fc1185c7972.js integrity="sha512-1nBQrfXTcGaK7eQgH4KveBsWlwk0gEmVoco3we6SIsL8Uwlyqm1dK2EkyvH+MY8TmqyZ3yweia9lUE/BGFx5cg==" crossorigin=anonymous defer></script><script src=https://koktlzz.github.io/js/vendor/katex/dist/katex.min.b334e5b00c45f572e7f38a543046f36854bf4cbb543880480c09271a0efedc694d6905f719934f6ede2f26f52e80411c05b90121d722cbf8be2fa8fc51bc6b81.js integrity="sha512-szTlsAxF9XLn84pUMEbzaFS/TLtUOIBIDAknGg7+3GlNaQX3GZNPbt4vJvUugEEcBbkBIdciy/i+L6j8UbxrgQ==" crossorigin=anonymous defer></script><script src=https://koktlzz.github.io/js/vendor/katex/dist/contrib/auto-render.min.916823ec103cf367b71e28a6f01513cb9c3ac6708ccb5229402ec46b8e30a8b25003db694df35d80e9dd666a371f327c6152790617b6256390c164109a90bd4c.js integrity="sha512-kWgj7BA882e3Hiim8BUTy5w6xnCMy1IpQC7Ea44wqLJQA9tpTfNdgOndZmo3HzJ8YVJ5Bhe2JWOQwWQQmpC9TA==" crossorigin=anonymous defer></script><script src=https://koktlzz.github.io/main.min.1febbf2f6fd6a36fc2f57dd50d7935fbb640743329baeb4ef7cefcf2e7630e413371fbba976e103656b82808ee227dc4a84237edb0f8433648bef3a56900661a.js integrity="sha512-H+u/L2/Wo2/C9X3VDXk1+7ZAdDMpuutO98788udjDkEzcfu6l24QNla4KAjuIn3EqEI37bD4QzZIvvOlaQBmGg==" crossorigin=anonymous defer></script></body></html>