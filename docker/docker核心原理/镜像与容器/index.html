<!doctype html><html lang=en-us><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-D022F6NT2P"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-D022F6NT2P')</script><script>(function(b,d,e,a,g){b[a]=b[a]||[],b[a].push({'gtm.start':(new Date).getTime(),event:'gtm.js'});var f=d.getElementsByTagName(e)[0],c=d.createElement(e),h=a!='dataLayer'?'&l='+a:'';c.async=!0,c.src='https://www.googletagmanager.com/gtm.js?id='+g+h,f.parentNode.insertBefore(c,f)})(window,document,'script','dataLayer','GTM-P72R45W')</script><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://koktlzz.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://koktlzz.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://koktlzz.github.io/fonts/KaTeX_Main-Regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://koktlzz.github.io/fonts/KaTeX_Math-Italic.woff2 type=font/woff2 crossorigin><link rel=stylesheet href=https://koktlzz.github.io/main.0ae7165cfeda76c765ab05aa408a696be65779f1e277afd078efecc543cc00bb72be873f087e148ccf7ac1016b22c2d2586f058c7ee5d92dcca60206eae2dd99.css integrity="sha512-CucWXP7adsdlqwWqQIppa+ZXefHid6/QeO/sxUPMALtyvoc/CH4UjM96wQFrIsLSWG8FjH7l2S3MpgIG6uLdmQ==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>镜像与容器 | Inspire Hub</title><meta name=description content><link rel=canonical href=https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/%E9%95%9C%E5%83%8F%E4%B8%8E%E5%AE%B9%E5%99%A8/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="镜像与容器"><meta property="og:description" content="镜像  Docker 镜像是一个只读的容器模板，含有启动 Docker 容器所需的文件系统。Docker 镜像的文件内容和一些运行容器的配置文件组成了 Docker 容器的文件系统运行环境——rootfs。
 当我们使用 docker pull 下载一个 nginx 镜像后，可以在 Docker 的工作目录 /var/lib/docker/image/overlay2 下找到它的相关信息（路径中的 overlay2 是 Docker 目前使用的一种存储驱动，我们后面会详细讲解这项技术）：
[root@localhost ~]# docker images REPOSITORY TAG IMAGE ID CREATED SIZE nginx latest f6d0b4767a6c 3 weeks ago 133MB [root@localhost ~]# ls /var/lib/docker/image/overlay2 distribution imagedb layerdb repositories.json Repository 在 Docker 的镜像管理系统中，registry 代表镜像仓库，如官方的 Docker Hub。而 repository 则代表镜像组，即包含了不同版本的镜像集合。repositories.json 文件中描述了宿主机上所有镜像的 repository 元数据，主要包括镜像名、tag 和镜像 ID。而镜像 ID 是 Docker 采用 SHA256 算法，根据镜像元数据配置文件计算得出的。
[root@localhost ~]# cat /var/lib/docker/image/overlay2/repositories."><meta property="og:url" content="https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/%E9%95%9C%E5%83%8F%E4%B8%8E%E5%AE%B9%E5%99%A8/"><meta property="og:site_name" content="Inspire Hub"><meta property="article:published_time" content="2021-02-24T22:05:45+08:00"><meta property="article:modified_time" content="2021-02-24T22:05:45+08:00"><meta property="og:image" content="https://koktlzz.github.io/doks.png"><meta property="og:image:alt" content="Inspire Hub"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@getdoks"><meta name=twitter:creator content="@henkverlinde"><meta name=twitter:title content="镜像与容器"><meta name=twitter:description content><meta name=twitter:image content="https://koktlzz.github.io/doks.png"><meta name=twitter:image:alt content="镜像与容器"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://koktlzz.github.io/#/schema/organization/1","name":"Doks","url":"https://koktlzz.github.io/","sameAs":["https://twitter.com/getdoks","https://github.com/h-enk/doks"],"logo":{"@type":"ImageObject","@id":"https://koktlzz.github.io/#/schema/image/1","url":"https://koktlzz.github.io/logo-doks.png","width":512,"height":512,"caption":"Doks"},"image":{"@id":"https://koktlzz.github.io/#/schema/image/1"}},{"@type":"WebSite","@id":"https://koktlzz.github.io/#/schema/website/1","url":"https://koktlzz.github.io/","name":"Inspire Hub","description":"","publisher":{"@id":"https://koktlzz.github.io/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/%E9%95%9C%E5%83%8F%E4%B8%8E%E5%AE%B9%E5%99%A8/","url":"https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/%E9%95%9C%E5%83%8F%E4%B8%8E%E5%AE%B9%E5%99%A8/","name":"镜像与容器","description":"","isPartOf":{"@id":"https://koktlzz.github.io/#/schema/website/1"},"about":{"@id":"https://koktlzz.github.io/#/schema/organization/1"},"datePublished":"2021-02-24T22:05:45CET","dateModified":"2021-02-24T22:05:45CET","breadcrumb":{"@id":"https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/%E9%95%9C%E5%83%8F%E4%B8%8E%E5%AE%B9%E5%99%A8/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/%E9%95%9C%E5%83%8F%E4%B8%8E%E5%AE%B9%E5%99%A8/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/%E9%95%9C%E5%83%8F%E4%B8%8E%E5%AE%B9%E5%99%A8/"]}]},{"@type":"BreadcrumbList","@id":"https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/%E9%95%9C%E5%83%8F%E4%B8%8E%E5%AE%B9%E5%99%A8/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://koktlzz.github.io/","url":"https://koktlzz.github.io/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://koktlzz.github.io/docker/","url":"https://koktlzz.github.io/docker/","name":"Docker"}},{"@type":"ListItem","position":3,"item":{"@type":"WebPage","@id":"https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/","url":"https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/","name":"Docker% E6% A0% B8% E5% Bf%83% E5%8 E%9 F% E7%90%86"}},{"@type":"ListItem","position":4,"item":{"@id":"https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/%E9%95%9C%E5%83%8F%E4%B8%8E%E5%AE%B9%E5%99%A8/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/%E9%95%9C%E5%83%8F%E4%B8%8E%E5%AE%B9%E5%99%A8/#/schema/image/2","url":"https://koktlzz.github.io/doks.png","contentUrl":"https://koktlzz.github.io/doks.png","caption":"镜像与容器"}]}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=https://koktlzz.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://koktlzz.github.io/favicon-32x32.ico><link rel=icon type=image/png sizes=16x16 href=https://koktlzz.github.io/favicon-16x16.ico><link rel=manifest crossorigin=use-credentials href=https://koktlzz.github.io/site.webmanifest></head><body class="Docker single dark"><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-P72R45W" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container-fluid><input class="menu-btn order-0" type=checkbox id=menu-btn>
<label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label><a class="navbar-brand order-1 order-md-0 me-auto" href=https://koktlzz.github.io/>Inspire Hub</a>
<button id=mode class="btn btn-link order-2 order-md-4" type=button aria-label="Toggle mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button><ul class="navbar-nav social-nav order-3 order-md-5"><li class=nav-item><a class=nav-link href=https://github.com/koktlzz><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><span class="ms-2 visually-hidden">GitHub</span></a></li></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav me-auto order-5 order-md-2"><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/docker/docker%E5%9F%BA%E7%A1%80/intro>Docker</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/kubernetes/kubernetes%E5%9F%BA%E7%A1%80/intro>Kubernetes</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/elastic/elasticstack/intro>Elastic</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/go/go%E5%9F%BA%E7%A1%80/intro>Go</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/infra/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/tcpip%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B>Infra</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/prometheus/prometheus/intro>Prometheus</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/opentelemetry/opentelemetry/intro>Opentelemetry</a></li></ul><div class="break order-6 d-md-none"></div></div></div></header><div class="wrap container-fluid" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-3 col-xl-2 d-none d-xl-block"><nav class=docs-links aria-label="Main navigation"><h3>Docker 基础</h3><ul class=list-unstyled><li><a class=docs-link href=https://koktlzz.github.io/docker/docker%E5%9F%BA%E7%A1%80/intro/>Getting Started</a></li><li><a class=docs-link href=https://koktlzz.github.io/docker/docker%E5%9F%BA%E7%A1%80/%E7%8B%82%E7%A5%9Edocker%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/>狂神 Docker 课程笔记</a></li><li><a class=docs-link href=https://koktlzz.github.io/docker/docker%E5%9F%BA%E7%A1%80/dockercompose/>Docker Compose</a></li></ul><h3>Docker 核心原理</h3><ul class=list-unstyled><li><a class=docs-link href=https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/namespace%E9%9A%94%E7%A6%BB/>Namespace 隔离</a></li><li><a class=docs-link href=https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/cgroups%E9%9A%94%E7%A6%BB/>cgroups 隔离</a></li><li><a class=docs-link href=https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/%E9%95%9C%E5%83%8F%E4%B8%8E%E5%AE%B9%E5%99%A8/>镜像与容器</a></li></ul></nav></div><main class="docs-content col-lg-13 col-xl-11"><h1>镜像与容器</h1><p class=lead></p><h2 id=镜像>镜像<a href=#镜像 class=anchor aria-hidden=true>#</a></h2><blockquote><p>Docker 镜像是一个只读的容器模板，含有启动 Docker 容器所需的文件系统。Docker 镜像的文件内容和一些运行容器的配置文件组成了 Docker 容器的文件系统运行环境——rootfs。</p></blockquote><p>当我们使用 <strong>docker pull</strong> 下载一个 nginx 镜像后，可以在 Docker 的工作目录 <strong>/var/lib/docker/image/overlay2</strong> 下找到它的相关信息（路径中的 overlay2 是 Docker 目前使用的一种存储驱动，我们后面会详细讲解这项技术）：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ff79c6>[</span>root@localhost ~<span style=color:#ff79c6>]</span><span style=color:#6272a4># docker images</span>
REPOSITORY   TAG       IMAGE ID       CREATED       SIZE
nginx        latest    f6d0b4767a6c   <span style=color:#bd93f9>3</span> weeks ago   133MB
<span style=color:#ff79c6>[</span>root@localhost ~<span style=color:#ff79c6>]</span><span style=color:#6272a4># ls /var/lib/docker/image/overlay2</span>
distribution  imagedb  layerdb  repositories.json
</code></pre></div><h3 id=repository>Repository<a href=#repository class=anchor aria-hidden=true>#</a></h3><p>在 Docker 的镜像管理系统中，registry 代表镜像仓库，如官方的 Docker Hub。而 repository 则代表镜像组，即包含了不同版本的镜像集合。repositories.json 文件中描述了宿主机上所有镜像的 repository 元数据，主要包括镜像名、tag 和镜像 ID。而镜像 ID 是 Docker 采用 SHA256 算法，根据镜像元数据配置文件计算得出的。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ff79c6>[</span>root@localhost ~<span style=color:#ff79c6>]</span><span style=color:#6272a4># cat /var/lib/docker/image/overlay2/repositories.json | python -mjson.tool</span>
<span style=color:#ff79c6>{</span>
    <span style=color:#f1fa8c>&#34;Repositories&#34;</span>: <span style=color:#ff79c6>{</span>
        <span style=color:#f1fa8c>&#34;nginx&#34;</span>: <span style=color:#ff79c6>{</span>
            <span style=color:#f1fa8c>&#34;nginx:latest&#34;</span>: <span style=color:#f1fa8c>&#34;sha256:f6d0b4767a6c466c178bf718f99bea0d3742b26679081e52dbf8e0c7c4c42d74&#34;</span>,
            <span style=color:#f1fa8c>&#34;nginx@sha256:10b8cc432d56da8b61b070f4c7d2543a9ed17c2b23010b43af434fd40e2ca4aa&#34;</span>: <span style=color:#f1fa8c>&#34;sha256:f6d0b4767a6c466c178bf718f99bea0d3742b26679081e52dbf8e0c7c4c42d74&#34;</span>
        <span style=color:#ff79c6>}</span>
    <span style=color:#ff79c6>}</span>
<span style=color:#ff79c6>}</span>
</code></pre></div><h3 id=image>Image<a href=#image class=anchor aria-hidden=true>#</a></h3><p>镜像的元数据信息保存在 imagedb 目录中，其文件结构如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ff79c6>[</span>root@localhost ~<span style=color:#ff79c6>]</span><span style=color:#6272a4># tree  /var/lib/docker/image/overlay2/imagedb</span>
/var/lib/docker/image/overlay2/imagedb
├── content
│   └── sha256
│       └── f6d0b4767a6c466c178bf718f99bea0d3742b26679081e52dbf8e0c7c4c42d74
└── metadata
    └── sha256

<span style=color:#bd93f9>4</span> directories, <span style=color:#bd93f9>1</span> file
</code></pre></div><p>打开 <strong>content/sha256</strong> 目录下以镜像 ID 命名的文件，我们可以看到镜像的元数据信息，包括了镜像架构、操作系统 、默认配置、创建时间、历史信息和 rootfs 等：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ff79c6>[</span>root@localhost ~<span style=color:#ff79c6>]</span><span style=color:#6272a4># cat /var/lib/docker/image/overlay2/imagedb/content/sha256/f6d0b4* | python -mjson.tool</span>
<span style=color:#ff79c6>{</span>
    <span style=color:#f1fa8c>&#34;architecture&#34;</span>: <span style=color:#f1fa8c>&#34;amd64&#34;</span>,
    ...
    <span style=color:#f1fa8c>&#34;created&#34;</span>: <span style=color:#f1fa8c>&#34;2021-01-12T10:17:41.649267496Z&#34;</span>,
    <span style=color:#f1fa8c>&#34;docker_version&#34;</span>: <span style=color:#f1fa8c>&#34;19.03.12&#34;</span>,
    ...
    <span style=color:#f1fa8c>&#34;os&#34;</span>: <span style=color:#f1fa8c>&#34;linux&#34;</span>,
    <span style=color:#f1fa8c>&#34;rootfs&#34;</span>: <span style=color:#ff79c6>{</span>
        <span style=color:#f1fa8c>&#34;diff_ids&#34;</span>: <span style=color:#ff79c6>[</span>
            <span style=color:#f1fa8c>&#34;sha256:cb42413394c4059335228c137fe884ff3ab8946a014014309676c25e3ac86864&#34;</span>,
            <span style=color:#f1fa8c>&#34;sha256:1c91bf69a08b515a1f9c36893d01bd3123d896b38b082e7c21b4b7cc7023525a&#34;</span>,
            <span style=color:#f1fa8c>&#34;sha256:56bc37de0858bc2a5c94db9d69b85b4ded4e0d03684bb44da77e0fe93a829292&#34;</span>,
            <span style=color:#f1fa8c>&#34;sha256:3e5288f7a70f526d6bceb54b3568d13c72952936cebfe28ddcb3386fe3a236ba&#34;</span>,
            <span style=color:#f1fa8c>&#34;sha256:85fcec7ef3efbf3b4e76a0f5fb8ea14eca6a6c7cbc0c52a1d401ad5548a29ba5&#34;</span>
        <span style=color:#ff79c6>]</span>,
        <span style=color:#f1fa8c>&#34;type&#34;</span>: <span style=color:#f1fa8c>&#34;layers&#34;</span>
    <span style=color:#ff79c6>}</span>
</code></pre></div><p>在这些信息中，我们最关心的是 rootfs。上文提到，rootfs 是容器运行的文件系统环境。而从上面的元数据信息中我们发现，rootfs 是由多个 layer 文件组成的。元数据记录了这些 layer 的 diffID，它们是 Docker 使用 SHA256 算法根据 layer 文件内容计算得到的。这样做的好处是可以在用户进行 docker pull、push、load、save 等操作时根据 diffID 检查 layer 文件的完整性，并且可以让相同 diffID 的 layer 文件被不同镜像共享。</p><h3 id=layer>Layer<a href=#layer class=anchor aria-hidden=true>#</a></h3><p><strong>layerdb/sha256</strong> 下的目录名称是以每层 layer 的 chainID 来命名的，它是 Docker 内容寻址机制所使用的存储索引。其计算方式为：</p><ul><li>如果 layer 是最底层，没有任何父 layer，那么 <strong>diffID = chainID</strong>;</li><li>否则，<strong>chainID(n)=sha256sum(chainID(n-1)) diffID(n))</strong></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ff79c6>[</span>root@localhost ~<span style=color:#ff79c6>]</span><span style=color:#6272a4># tree  /var/lib/docker/image/overlay2/layerdb -L 2</span>
/var/lib/docker/image/overlay2/layerdb
├── sha256
│   ├── 3c90a0917c79b758d74b7040f62d17a7680cd14077f734330b1994a2985283b8
│   ├── 4dfe71c4470c5920135f00af483556b09911b72547113512d36dc29bfc5f7445
│   ├── a1c538085c6f891424160d8db120ea093d4dda393e94cd4713e3fff3c82299b5
│   ├── a3ee2510dcf02c980d7aff635909612006fd1662084d6225e52e769b984abeb5
│   └── cb42413394c4059335228c137fe884ff3ab8946a014014309676c25e3ac86864
└── tmp
</code></pre></div><p>我们可以发现只有 layercb42413394c *的 diffID 和 chainID 相等，因为它就是镜像的最底层。实际上 image 元数据中 layer 的 diffID 是以低层到高层的顺序记录的，我们可以根据公式计算出倒数第二层的 chainID：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ff79c6>[</span>root@localhost ~<span style=color:#ff79c6>]</span><span style=color:#6272a4># echo -n &#34;sha256:cb42413394c4059335228c137fe884ff3ab8946a014014309676c25e3ac86864 sha256:1c91bf69a08b515a1f9c36893d01bd3123d896b38b082e7c21b4b7cc7023525a&#34; | sha256sum -</span>
a3ee2510dcf02c980d7aff635909612006fd1662084d6225e52e769b984abeb5  -
<span style=color:#ff79c6>[</span>root@localhost ~<span style=color:#ff79c6>]</span><span style=color:#6272a4># ls /var/lib/docker/image/overlay2/layerdb/sha256 | grep a3ee2510dcf0*</span>
a3ee2510dcf02c980d7aff635909612006fd1662084d6225e52e769b984abeb5
</code></pre></div><p>每一个以 layer 的 chainID 命名的目录下都保存了镜像层 layer 的元数据信息：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ff79c6>[</span>root@localhost ~<span style=color:#ff79c6>]</span><span style=color:#6272a4># ls  /var/lib/docker/image/overlay2/layerdb/sha256/a3ee2510dcf02c980d7*</span>
cache-id  diff  parent  size  tar-split.json.gz
</code></pre></div><ul><li>parent：父 layer 的 chainID</li><li>size：layer 文件的大小</li><li>cache-id：存储驱动通过 cache-id 索引到 layer 的实际文件内容</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ff79c6>[</span>root@localhost ~<span style=color:#ff79c6>]</span><span style=color:#6272a4># cat /var/lib/docker/image/overlay2/layerdb/sha256/a3ee2510dcf02c980d7*/parent</span>
sha256:cb42413394c4059335228c137fe884ff3ab8946a014014309676c25e3ac86864
<span style=color:#ff79c6>[</span>root@localhost ~<span style=color:#ff79c6>]</span><span style=color:#6272a4># cat /var/lib/docker/image/overlay2/layerdb/sha256/a3ee2510dcf02c980d7*/size</span>
<span style=color:#bd93f9>63704232</span>
<span style=color:#ff79c6>[</span>root@localhost ~<span style=color:#ff79c6>]</span><span style=color:#6272a4># cat /var/lib/docker/image/overlay2/layerdb/sha256/a3ee2510dcf02c980d7*/cache-id</span>
0363fcae3b4410c394b8a99e0a24d1ec01eb5198c82d3422f9c411ceaad98286
</code></pre></div><p>如果我们启动一个容器，便可以发现 Docker 会在 layerdb 目录下新生成一个 mounts 目录：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ff79c6>[</span>root@localhost ~<span style=color:#ff79c6>]</span><span style=color:#6272a4># docker run -d --name=nginx -v /home:/home nginx</span>
45f30cb6a063a7251db4388f17f85c1226d96277cb74693c1f38bef1d17b6193
<span style=color:#ff79c6>[</span>root@localhost ~<span style=color:#ff79c6>]</span><span style=color:#6272a4>#  tree  /var/lib/docker/image/overlay2/layerdb -L 2</span>
/var/lib/docker/image/overlay2/layerdb
├── mounts
│   └── 45f30cb6a063a7251db4388f17f85c1226d96277cb74693c1f38bef1d17b6193
├── sha256
│   ├── 3c90a0917c79b758d74b7040f62d17a7680cd14077f734330b1994a2985283b8
│   ├── 4dfe71c4470c5920135f00af483556b09911b72547113512d36dc29bfc5f7445
│   ├── a1c538085c6f891424160d8db120ea093d4dda393e94cd4713e3fff3c82299b5
│   ├── a3ee2510dcf02c980d7aff635909612006fd1662084d6225e52e769b984abeb5
│   └── cb42413394c4059335228c137fe884ff3ab8946a014014309676c25e3ac86864
└── tmp

<span style=color:#bd93f9>9</span> directories, <span style=color:#bd93f9>0</span> files
</code></pre></div><p>mounts 目录下有着以容器 ID 命名的文件，其内部记录了容器层 layer 的元数据信息：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ff79c6>[</span>root@localhost ~<span style=color:#ff79c6>]</span><span style=color:#6272a4># ls /var/lib/docker/image/overlay2/layerdb/mounts/45f30cb6a063*</span>
init-id  mount-id  parent
</code></pre></div><p>那么容器到底是什么呢？</p><h2 id=容器>容器<a href=#容器 class=anchor aria-hidden=true>#</a></h2><p>通过上面的一些探索，我们已经知道了镜像是由多个 layer 组成的文件，并在容器启动时成为容器文件系统的运行环境——只读的 rootfs。而容器其实就是 Dokcer 利用存储驱动在只读 rootfs 上挂载一个可读写层后的结果。</p><h3 id=联合挂载>联合挂载<a href=#联合挂载 class=anchor aria-hidden=true>#</a></h3><blockquote><p>联合挂载技术可以在一个挂载点同时挂载多个文件系统，将挂载点的原目录与被挂载内容进行整合，使得最终可见的文件系统将会包含整合之后的各层的文件和目录。</p></blockquote><p>Overlay2 是 Docker 目前使用的一种联合挂载技术，它主要通过四类目录完成工作：</p><ul><li>lower：底层文件系统。对于 Docker 来说，就是只读的镜像层；</li><li>upper：上层文件系统。对于 Docker 来说，就是可读写的容器层；</li><li>merged：作为统一视图的联合挂载点。对于 Docker 来说，就是用户视角下的文件系统；</li><li>work：提供辅助功能。</li></ul><p>我们启动一个容器，观察系统中 overlay2 类型的挂载情况：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ff79c6>[</span>root@localhost ~<span style=color:#ff79c6>]</span><span style=color:#6272a4># docker run -d --name=nginx -v /home:/home nginx</span>
45f30cb6a063a7251db4388f17f85c1226d96277cb74693c1f38bef1d17b6193
<span style=color:#ff79c6>[</span>root@localhost ~<span style=color:#ff79c6>]</span><span style=color:#6272a4># mount -t overlay</span>
overlay on /var/lib/docker/overlay2/dabd31fb6ad636b16b6f01f2332d068888de1e3e41a53751a35206e266b5dad4/merged <span style=color:#8be9fd;font-style:italic>type</span> overlay <span style=color:#ff79c6>(</span>rw,relatime,seclabel,lowerdir<span style=color:#ff79c6>=</span>/var/lib/docker/overlay2/l/U7ZXQ4ZL7TLD6XEBUVLR77LKS4:/var/lib/docker/overlay2/l/BXVB3Q7277EPHJEMMHKEOR6YS5:/var/lib/docker/overlay2/l/5K76AX5UNX35LFXZKLATNWHOIK:/var/lib/docker/overlay2/l/QTGJLTLBMEML5OGHHZUYM3GHTR:/var/lib/docker/overlay2/l/55T5LSGE3C2NFFQ54FHM7YDNKY:/var/lib/docker/overlay2/l/R2AW2LUWRDIV7DLJFYMS67LB3L,upperdir<span style=color:#ff79c6>=</span>/var/lib/docker/overlay2/dabd31fb6ad636b16b6f01f2332d068888de1e3e41a53751a35206e266b5dad4/diff,workdir<span style=color:#ff79c6>=</span>/var/lib/docker/overlay2/dabd31fb6ad636b16b6f01f2332d068888de1e3e41a53751a35206e266b5dad4/work<span style=color:#ff79c6>)</span>
</code></pre></div><p>根据输出结果我们可以找到 overlay2 的挂载点位置：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ff79c6>[</span>root@localhost ~<span style=color:#ff79c6>]</span><span style=color:#6272a4># ll /var/lib/docker/overlay2/l</span>
总用量 <span style=color:#bd93f9>0</span>
lrwxrwxrwx. <span style=color:#bd93f9>1</span> root root <span style=color:#bd93f9>72</span> <span style=color:#bd93f9>2</span> 月   <span style=color:#bd93f9>2</span> 07:37 55T5LSGE3C2NFFQ54FHM7YDNKY -&gt; ../0363fcae3b4410c394b8a99e0a24d1ec01eb5198c82d3422f9c411ceaad98286/diff
lrwxrwxrwx. <span style=color:#bd93f9>1</span> root root <span style=color:#bd93f9>72</span> <span style=color:#bd93f9>2</span> 月   <span style=color:#bd93f9>2</span> 07:37 5K76AX5UNX35LFXZKLATNWHOIK -&gt; ../14faccdb685b520f09148aaafec45dd31d2e6aa96516b60deaf59228ae9dbe66/diff
lrwxrwxrwx. <span style=color:#bd93f9>1</span> root root <span style=color:#bd93f9>72</span> <span style=color:#bd93f9>2</span> 月   <span style=color:#bd93f9>2</span> 07:37 BXVB3Q7277EPHJEMMHKEOR6YS5 -&gt; ../82a99d340893301cf33c79588042cd7d5db55cbcf34ca4b7a6ade609b6d28c96/diff
lrwxrwxrwx. <span style=color:#bd93f9>1</span> root root <span style=color:#bd93f9>72</span> <span style=color:#bd93f9>2</span> 月   <span style=color:#bd93f9>2</span> 10:02 M5NBJHQ4ICWANIEYBYMJ5FLCZO -&gt; ../dabd31fb6ad636b16b6f01f2332d068888de1e3e41a53751a35206e266b5dad4/diff
lrwxrwxrwx. <span style=color:#bd93f9>1</span> root root <span style=color:#bd93f9>72</span> <span style=color:#bd93f9>2</span> 月   <span style=color:#bd93f9>2</span> 07:37 QTGJLTLBMEML5OGHHZUYM3GHTR -&gt; ../5b75a3d9c3881dd8041cdc3fa73679a9f1e4f1052d4548e22b5f4e4ccce7c2d0/diff
lrwxrwxrwx. <span style=color:#bd93f9>1</span> root root <span style=color:#bd93f9>72</span> <span style=color:#bd93f9>2</span> 月   <span style=color:#bd93f9>2</span> 07:37 R2AW2LUWRDIV7DLJFYMS67LB3L -&gt; ../bd47b78b55e951d504c6e70c0e7af451b020a5741f71ed0e91cb8f8dc77a8664/diff
lrwxrwxrwx. <span style=color:#bd93f9>1</span> root root <span style=color:#bd93f9>77</span> <span style=color:#bd93f9>2</span> 月   <span style=color:#bd93f9>2</span> 10:02 U7ZXQ4ZL7TLD6XEBUVLR77LKS4 -&gt; ../dabd31fb6ad636b16b6f01f2332d068888de1e3e41a53751a35206e266b5dad4-init/diff
</code></pre></div><ul><li><strong>/var/lib/docker/overlay2/l</strong> 目录下保存的均是软链接文件，其文件名是避免使用 mount 命令时输出结果达到页面大小限制而生成的短名称；</li><li>在 lowerdir 中的软链接，除 U7ZXQ4ZL7TLD6XEBUVLR77LKS4 外，均指向了只读镜像层文件的挂载点，分别对应了我们下载的 ngingx 镜像的五层 layer；</li><li>上文提到，layer 元数据中的 cache-id 会索引到 layer 的实际文件，其路径为：<strong>/var/lib/docker/overlay2/&lt;cache-id>/diff</strong>；</li><li>U7ZXQ4ZL7TLD6XEBUVLR77LKS4 指向的是容器启动时自动生成一层的以读写层 cache-id-init 命名的 init-layer，其中的文件配置了容器的主机名，DNS 服务等。</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ff79c6>[</span>root@localhost ~<span style=color:#ff79c6>]</span><span style=color:#6272a4># cd /var/lib/docker/overlay2/l</span>
<span style=color:#ff79c6>[</span>root@localhost l<span style=color:#ff79c6>]</span><span style=color:#6272a4># ls ../bd47b78b55e951d504c6e70c0e7af451b020a5741f71ed0e91cb8f8dc77a8664/diff</span>
bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
<span style=color:#ff79c6>[</span>root@localhost l<span style=color:#ff79c6>]</span><span style=color:#6272a4># ls ../0363fcae3b4410c394b8a99e0a24d1ec01eb5198c82d3422f9c411ceaad98286/diff</span>
docker-entrypoint.d  etc  lib  tmp  usr  var
<span style=color:#ff79c6>[</span>root@localhost l<span style=color:#ff79c6>]</span><span style=color:#6272a4># ls ../dabd31fb6ad636b16b6f01f2332d068888de1e3e41a53751a35206e266b5dad4-init/diff</span>
dev  etc
<span style=color:#ff79c6>[</span>root@localhost l<span style=color:#ff79c6>]</span><span style=color:#6272a4># ls ../dabd31fb6ad636b16b6f01f2332d068888de1e3e41a53751a35206e266b5dad4-init/diff/etc</span>
hostname  hosts  mtab  resolv.conf
...
</code></pre></div><p>我们更加深刻地意识到，镜像层就是多个 layer 文件经过联合挂载后得到的文件系统。而 M5NBJHQ4ICWANIEYBYMJ5FLCZO 指向的目录（<strong>mount -t overlay</strong> 命令输出的 upperdir）便是读写层，也就是容器层的文件系统：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ff79c6>[</span>root@localhost l<span style=color:#ff79c6>]</span><span style=color:#6272a4># ls ../dabd31fb6ad636b16b6f01f2332d068888de1e3e41a53751a35206e266b5dad4/diff</span>
etc  run  var
</code></pre></div><p>overlay2 将 upper 和 lower 的文件系统联合挂载，就得到了用户视角下的文件系统：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ff79c6>[</span>root@localhost l<span style=color:#ff79c6>]</span><span style=color:#6272a4># ls ../dabd31fb6ad636b16b6f01f2332d068888de1e3e41a53751a35206e266b5dad4/merged</span>
bin   dev                  docker-entrypoint.sh  home  lib64  mnt  proc  run   srv  tmp  var
boot  docker-entrypoint.d  etc
</code></pre></div><p><img src=https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/20210203011643.png alt=20210203011643></p><p>用户在容器中修改文件，其实只对读写层进行了变动，不会覆盖下层只读层的文件系统。读写层会把只读层的原始版本文件隐藏，所以用户发现文件系统已改变。而如果我们使用 <strong>docker commit</strong> 命令生成新镜像，保存内容仅为读写层更新的文件。</p><h3 id=容器信息>容器信息<a href=#容器信息 class=anchor aria-hidden=true>#</a></h3><p>可以在 <strong>/var/lib/docker/containers/容器 ID</strong> 目录下看到容器的相关信息：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ff79c6>[</span>root@localhost ~<span style=color:#ff79c6>]</span><span style=color:#6272a4># tree /var/lib/docker/containers</span>
/var/lib/docker/containers
└── 45f30cb6a063a7251db4388f17f85c1226d96277cb74693c1f38bef1d17b6193
    ├── 45f30cb6a063a7251db4388f17f85c1226d96277cb74693c1f38bef1d17b6193-json.log
    ├── checkpoints
    ├── config.v2.json
    ├── hostconfig.json
    ├── hostname
    ├── hosts
    ├── mounts
    ├── resolv.conf
    └── resolv.conf.hash

<span style=color:#bd93f9>3</span> directories, <span style=color:#bd93f9>7</span> files
</code></pre></div><p>目录下的 config.v2.json 文件描述了容器的详细配置信息，和使用 <strong>docker inspect &lt;container></strong> 命令对容器的查看结果是基本一致的：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cat /var/lib/docker/containers/45f30cb6a063a7*/config.v2.json | python -mjson.tool
</code></pre></div><p>还可以在 hostname、hosts 和 resolv.conf 文件中看到容器的主机名，DNS 配置等，它们和 init-layer 文件系统中的内容一致。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ff79c6>[</span>root@localhost ~<span style=color:#ff79c6>]</span><span style=color:#6272a4># cat /var/lib/docker/containers/45f30cb6a063a7*/hostname</span>
45f30cb6a063
<span style=color:#ff79c6>[</span>root@localhost ~<span style=color:#ff79c6>]</span><span style=color:#6272a4># cat /var/lib/docker/containers/45f30cb6a063a7*/hosts</span>
127.0.0.1 localhost
::1 localhost ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
172.17.0.2 45f30cb6a063
<span style=color:#ff79c6>[</span>root@localhost ~<span style=color:#ff79c6>]</span><span style=color:#6272a4># cat /var/lib/docker/containers/45f30cb6a063a7*/resolv.conf</span>
<span style=color:#6272a4># Generated by NetworkManager</span>
nameserver 192.168.1.1
nameserver 192.168.0.1
</code></pre></div><p class=edit-page><a href=https://github.com/koktlzz/koktlzz.github.io/blob/master/content/Docker/Docker%e6%a0%b8%e5%bf%83%e5%8e%9f%e7%90%86/%e9%95%9c%e5%83%8f%e4%b8%8e%e5%ae%b9%e5%99%a8.md><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2"><path d="M17 3a2.828 2.828.0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>Edit this page on GitHub</a></p><div class="docs-navigation d-flex justify-content-between"><a href=https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/cgroups%E9%9A%94%E7%A6%BB/><div class="card my-1"><div class="card-body py-2">&larr; cgroups 隔离</div></div></a></div><script src=https://utteranc.es/client.js repo=koktlzz/koktlzz.github.io issue-term=pathname theme=photon-dark crossorigin=anonymous async></script></main><nav class="docs-toc d-none d-xl-block col-lg-3 col-xl-2" aria-label="Secondary navigation"><div class=page-links><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=#镜像>镜像</a><ul><li><a href=#repository>Repository</a></li><li><a href=#image>Image</a></li><li><a href=#layer>Layer</a></li></ul></li><li><a href=#容器>容器</a><ul><li><a href=#联合挂载>联合挂载</a></li><li><a href=#容器信息>容器信息</a></li></ul></li></ul></nav></div></nav></div></div></div><footer class="footer text-muted"><div class=container><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline></ul></div></div></div></footer><script src=https://koktlzz.github.io/js/bootstrap.min.d67050adf5d370668aede4201f82af781b16970934804995a1ca37c1ee9222c2fc530972aa6d5d2b6124caf1fe318f139aac99df2c1e89af65504fc1185c7972.js integrity="sha512-1nBQrfXTcGaK7eQgH4KveBsWlwk0gEmVoco3we6SIsL8Uwlyqm1dK2EkyvH+MY8TmqyZ3yweia9lUE/BGFx5cg==" crossorigin=anonymous defer></script><script src=https://koktlzz.github.io/js/vendor/katex/dist/katex.min.b334e5b00c45f572e7f38a543046f36854bf4cbb543880480c09271a0efedc694d6905f719934f6ede2f26f52e80411c05b90121d722cbf8be2fa8fc51bc6b81.js integrity="sha512-szTlsAxF9XLn84pUMEbzaFS/TLtUOIBIDAknGg7+3GlNaQX3GZNPbt4vJvUugEEcBbkBIdciy/i+L6j8UbxrgQ==" crossorigin=anonymous defer></script><script src=https://koktlzz.github.io/js/vendor/katex/dist/contrib/auto-render.min.916823ec103cf367b71e28a6f01513cb9c3ac6708ccb5229402ec46b8e30a8b25003db694df35d80e9dd666a371f327c6152790617b6256390c164109a90bd4c.js integrity="sha512-kWgj7BA882e3Hiim8BUTy5w6xnCMy1IpQC7Ea44wqLJQA9tpTfNdgOndZmo3HzJ8YVJ5Bhe2JWOQwWQQmpC9TA==" crossorigin=anonymous defer></script><script src=https://koktlzz.github.io/main.min.1febbf2f6fd6a36fc2f57dd50d7935fbb640743329baeb4ef7cefcf2e7630e413371fbba976e103656b82808ee227dc4a84237edb0f8433648bef3a56900661a.js integrity="sha512-H+u/L2/Wo2/C9X3VDXk1+7ZAdDMpuutO98788udjDkEzcfu6l24QNla4KAjuIn3EqEI37bD4QzZIvvOlaQBmGg==" crossorigin=anonymous defer></script></body></html>