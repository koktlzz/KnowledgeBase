<!doctype html><html lang=en-us><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-D022F6NT2P"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-D022F6NT2P')</script><script>(function(b,d,e,a,g){b[a]=b[a]||[],b[a].push({'gtm.start':(new Date).getTime(),event:'gtm.js'});var f=d.getElementsByTagName(e)[0],c=d.createElement(e),h=a!='dataLayer'?'&l='+a:'';c.async=!0,c.src='https://www.googletagmanager.com/gtm.js?id='+g+h,f.parentNode.insertBefore(c,f)})(window,document,'script','dataLayer','GTM-P72R45W')</script><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://koktlzz.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://koktlzz.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://koktlzz.github.io/fonts/KaTeX_Main-Regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://koktlzz.github.io/fonts/KaTeX_Math-Italic.woff2 type=font/woff2 crossorigin><link rel=stylesheet href=https://koktlzz.github.io/main.6fd70af9369bef8ad98be8ac549b09d4cc31a7751f59f66dd296a20fd0fa4ae07ec51aee16a7e125439572da86f49095224d7d27d5f3dab10a0fa43783ecd2e2.css integrity="sha512-b9cK+Tab74rZi+isVJsJ1Mwxp3UfWfZt0paiD9D6SuB+xRruFqfhJUOVctqG9JCVIk19J9Xz2rEKD6Q3g+zS4g==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>cgroups 隔离 | Inspire Hub</title><meta name=description content><link rel=canonical href=https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/cgroups%E9%9A%94%E7%A6%BB/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="cgroups 隔离"><meta property="og:description" content="作用 cgroups(controll groups) 可以把一系列系统任务及其子任务（线程/进程）划分为等级不同的组，从而对任务组使用的物理资源（CPU、内存、IO 等）进行限制和记录。
 资源限制：对任务使用的资源总额进行限制，一旦超过这个配额就发出相关提示； 优先级分配：通过分配的 CPU 时间片数量及磁盘 IO 带宽大小，实际上就相当于控制了任务运行的优先级； 资源统计：cgroups 可以统计系统的资源使用量，如 CPU 使用时长，内存用量等； 任务控制：cgroups 可以对任务执行挂起、恢复等操作。  组织结构 cgroups 的组织结构中有以下几种元素：
  任务（task）：系统的一个进程或线程；
  控制组（cgroup）：按某种资源控制标准划分而成的任务组，一个任务可以加入某个 cgroup，也可以在不同 cgroup 中迁移；
  子系统（subsystem）：即资源调度器，如 CPU 子系统可以控制 CPU 时间分配；
  层级（hierarchy）：由一系列控制组以一个树状结构排列而成，每个层级通过绑定对应的子系统进行资源控制。
  它们之间的关系需要遵循一定的规则：
 同一个层级可以绑定多个子系统； 一个已经有层级绑定的子系统，不能附加到其他含有别的子系统的层级之上； 一个任务不能存在于同一层级的不同控制组中； 调用 fork() 或 clone() 方法后，父子任务（进程）的控制组互不影响。  在上图的 cgroups 结构中，左侧的层级同时绑定了 CPU 子系统和 Memory 子系统；由于此时 Memory 子系统已经有层级绑定，因此无法附加到一个已经绑定了 Net_ls 子系统的层级上；如果任务 task1 处于左侧层级下的 cg1 控制组中，那么便无法加入同一层级下的 cg2 控制组，但是可以加入右侧层级的 cg3 控制中。"><meta property="og:url" content="https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/cgroups%E9%9A%94%E7%A6%BB/"><meta property="og:site_name" content="Inspire Hub"><meta property="article:published_time" content="2021-02-24T22:05:45+08:00"><meta property="article:modified_time" content="2021-02-24T22:05:45+08:00"><meta property="og:image" content="https://koktlzz.github.io/doks.png"><meta property="og:image:alt" content="Inspire Hub"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@getdoks"><meta name=twitter:creator content="@henkverlinde"><meta name=twitter:title content="cgroups 隔离"><meta name=twitter:description content><meta name=twitter:image content="https://koktlzz.github.io/doks.png"><meta name=twitter:image:alt content="cgroups 隔离"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://koktlzz.github.io/#/schema/organization/1","name":"Doks","url":"https://koktlzz.github.io/","sameAs":["https://twitter.com/getdoks","https://github.com/h-enk/doks"],"logo":{"@type":"ImageObject","@id":"https://koktlzz.github.io/#/schema/image/1","url":"https://koktlzz.github.io/logo-doks.png","width":512,"height":512,"caption":"Doks"},"image":{"@id":"https://koktlzz.github.io/#/schema/image/1"}},{"@type":"WebSite","@id":"https://koktlzz.github.io/#/schema/website/1","url":"https://koktlzz.github.io/","name":"Inspire Hub","description":"","publisher":{"@id":"https://koktlzz.github.io/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/cgroups%E9%9A%94%E7%A6%BB/","url":"https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/cgroups%E9%9A%94%E7%A6%BB/","name":"cgroups 隔离","description":"","isPartOf":{"@id":"https://koktlzz.github.io/#/schema/website/1"},"about":{"@id":"https://koktlzz.github.io/#/schema/organization/1"},"datePublished":"2021-02-24T22:05:45CET","dateModified":"2021-02-24T22:05:45CET","breadcrumb":{"@id":"https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/cgroups%E9%9A%94%E7%A6%BB/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/cgroups%E9%9A%94%E7%A6%BB/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/cgroups%E9%9A%94%E7%A6%BB/"]}]},{"@type":"BreadcrumbList","@id":"https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/cgroups%E9%9A%94%E7%A6%BB/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://koktlzz.github.io/","url":"https://koktlzz.github.io/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://koktlzz.github.io/docker/","url":"https://koktlzz.github.io/docker/","name":"Docker"}},{"@type":"ListItem","position":3,"item":{"@type":"WebPage","@id":"https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/","url":"https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/","name":"Docker% E6% A0% B8% E5% Bf%83% E5%8 E%9 F% E7%90%86"}},{"@type":"ListItem","position":4,"item":{"@id":"https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/cgroups%E9%9A%94%E7%A6%BB/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/cgroups%E9%9A%94%E7%A6%BB/#/schema/image/2","url":"https://koktlzz.github.io/doks.png","contentUrl":"https://koktlzz.github.io/doks.png","caption":"cgroups 隔离"}]}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=https://koktlzz.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://koktlzz.github.io/favicon-32x32.ico><link rel=icon type=image/png sizes=16x16 href=https://koktlzz.github.io/favicon-16x16.ico><link rel=manifest crossorigin=use-credentials href=https://koktlzz.github.io/site.webmanifest></head><body class="Docker single dark"><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-P72R45W" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container-fluid><input class="menu-btn order-0" type=checkbox id=menu-btn>
<label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label><a class="navbar-brand order-1 order-md-0 me-auto" href=https://koktlzz.github.io/>Inspire Hub</a>
<button id=mode class="btn btn-link order-2 order-md-4" type=button aria-label="Toggle mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button><ul class="navbar-nav social-nav order-3 order-md-5"><li class=nav-item><a class=nav-link href=https://github.com/koktlzz><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><span class="ms-2 visually-hidden">GitHub</span></a></li></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav me-auto order-5 order-md-2"><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/docker/docker%E5%9F%BA%E7%A1%80/intro>Docker</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/kubernetes/kubernetes%E5%9F%BA%E7%A1%80/intro>Kubernetes</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/elastic/elasticstack/intro>Elastic</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/go/go%E5%9F%BA%E7%A1%80/intro>Go</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/infra/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/tcpip%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B>Infra</a></li></ul><div class="break order-6 d-md-none"></div></div></div></header><div class="wrap container-fluid" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-3 col-xl-2 d-none d-xl-block"><nav class=docs-links aria-label="Main navigation"><h3>Docker 基础</h3><ul class=list-unstyled><li><a class=docs-link href=https://koktlzz.github.io/docker/docker%E5%9F%BA%E7%A1%80/intro/>Get Started</a></li><li><a class=docs-link href=https://koktlzz.github.io/docker/docker%E5%9F%BA%E7%A1%80/%E7%8B%82%E7%A5%9Edocker%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/>狂神 Docker 课程笔记</a></li><li><a class=docs-link href=https://koktlzz.github.io/docker/docker%E5%9F%BA%E7%A1%80/dockercompose/>Docker Compose</a></li></ul><h3>Docker 核心原理</h3><ul class=list-unstyled><li><a class=docs-link href=https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/namespace%E9%9A%94%E7%A6%BB/>Namespace 隔离</a></li><li><a class=docs-link href=https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/cgroups%E9%9A%94%E7%A6%BB/>cgroups 隔离</a></li><li><a class=docs-link href=https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/%E9%95%9C%E5%83%8F%E4%B8%8E%E5%AE%B9%E5%99%A8/>镜像与容器</a></li></ul></nav></div><main class="docs-content col-lg-13 col-xl-11"><h1>cgroups 隔离</h1><p class=lead></p><h2 id=作用>作用<a href=#作用 class=anchor aria-hidden=true>#</a></h2><p>cgroups(controll groups) 可以把一系列系统任务及其子任务（线程/进程）划分为等级不同的组，从而对任务组使用的物理资源（CPU、内存、IO 等）进行限制和记录。</p><ul><li>资源限制：对任务使用的资源总额进行限制，一旦超过这个配额就发出相关提示；</li><li>优先级分配：通过分配的 CPU 时间片数量及磁盘 IO 带宽大小，实际上就相当于控制了任务运行的优先级；</li><li>资源统计：cgroups 可以统计系统的资源使用量，如 CPU 使用时长，内存用量等；</li><li>任务控制：cgroups 可以对任务执行挂起、恢复等操作。</li></ul><h2 id=组织结构>组织结构<a href=#组织结构 class=anchor aria-hidden=true>#</a></h2><p>cgroups 的组织结构中有以下几种元素：</p><ul><li><p>任务（task）：系统的一个进程或线程；</p></li><li><p>控制组（cgroup）：按某种资源控制标准划分而成的任务组，一个任务可以加入某个 cgroup，也可以在不同 cgroup 中迁移；</p></li><li><p>子系统（subsystem）：即资源调度器，如 CPU 子系统可以控制 CPU 时间分配；</p></li><li><p>层级（hierarchy）：由一系列控制组以一个树状结构排列而成，每个层级通过绑定对应的子系统进行资源控制。</p></li></ul><p>它们之间的关系需要遵循一定的规则：</p><ul><li>同一个层级可以绑定多个子系统；</li><li>一个已经有层级绑定的子系统，不能附加到其他含有别的子系统的层级之上；</li><li>一个任务不能存在于同一层级的不同控制组中；</li><li>调用 fork() 或 clone() 方法后，父子任务（进程）的控制组互不影响。</li></ul><p><img src=https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/20210201012614.png alt=20210201012614></p><p>在上图的 cgroups 结构中，左侧的层级同时绑定了 CPU 子系统和 Memory 子系统；由于此时 Memory 子系统已经有层级绑定，因此无法附加到一个已经绑定了 Net_ls 子系统的层级上；如果任务 task1 处于左侧层级下的 cg1 控制组中，那么便无法加入同一层级下的 cg2 控制组，但是可以加入右侧层级的 cg3 控制中。</p><h2 id=实现>实现<a href=#实现 class=anchor aria-hidden=true>#</a></h2><p>cgroup 的实现形式表现为一个文件系统，可以通过 <strong>mount -t cgroup</strong> 命令查看各种子系统的挂载情况：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ff79c6>[</span>root@koktlzz ~<span style=color:#ff79c6>]</span><span style=color:#6272a4># mount -t cgroup</span>
cgroup on /sys/fs/cgroup/systemd <span style=color:#8be9fd;font-style:italic>type</span> cgroup <span style=color:#ff79c6>(</span>rw,nosuid,nodev,noexec,relatime,xattr,release_agent<span style=color:#ff79c6>=</span>/usr/lib/systemd/systemd-cgroups-agent,name<span style=color:#ff79c6>=</span>systemd<span style=color:#ff79c6>)</span>
cgroup on /sys/fs/cgroup/hugetlb <span style=color:#8be9fd;font-style:italic>type</span> cgroup <span style=color:#ff79c6>(</span>rw,nosuid,nodev,noexec,relatime,hugetlb<span style=color:#ff79c6>)</span>
cgroup on /sys/fs/cgroup/net_cls,net_prio <span style=color:#8be9fd;font-style:italic>type</span> cgroup <span style=color:#ff79c6>(</span>rw,nosuid,nodev,noexec,relatime,net_cls,net_prio<span style=color:#ff79c6>)</span>
cgroup on /sys/fs/cgroup/devices <span style=color:#8be9fd;font-style:italic>type</span> cgroup <span style=color:#ff79c6>(</span>rw,nosuid,nodev,noexec,relatime,devices<span style=color:#ff79c6>)</span>
cgroup on /sys/fs/cgroup/blkio <span style=color:#8be9fd;font-style:italic>type</span> cgroup <span style=color:#ff79c6>(</span>rw,nosuid,nodev,noexec,relatime,blkio<span style=color:#ff79c6>)</span>
cgroup on /sys/fs/cgroup/freezer <span style=color:#8be9fd;font-style:italic>type</span> cgroup <span style=color:#ff79c6>(</span>rw,nosuid,nodev,noexec,relatime,freezer<span style=color:#ff79c6>)</span>
cgroup on /sys/fs/cgroup/perf_event <span style=color:#8be9fd;font-style:italic>type</span> cgroup <span style=color:#ff79c6>(</span>rw,nosuid,nodev,noexec,relatime,perf_event<span style=color:#ff79c6>)</span>
cgroup on /sys/fs/cgroup/memory <span style=color:#8be9fd;font-style:italic>type</span> cgroup <span style=color:#ff79c6>(</span>rw,nosuid,nodev,noexec,relatime,memory<span style=color:#ff79c6>)</span>
cgroup on /sys/fs/cgroup/cpu,cpuacct <span style=color:#8be9fd;font-style:italic>type</span> cgroup <span style=color:#ff79c6>(</span>rw,nosuid,nodev,noexec,relatime,cpu,cpuacct<span style=color:#ff79c6>)</span>
cgroup on /sys/fs/cgroup/cpuset <span style=color:#8be9fd;font-style:italic>type</span> cgroup <span style=color:#ff79c6>(</span>rw,nosuid,nodev,noexec,relatime,cpuset<span style=color:#ff79c6>)</span>
cgroup on /sys/fs/cgroup/pids <span style=color:#8be9fd;font-style:italic>type</span> cgroup <span style=color:#ff79c6>(</span>rw,nosuid,nodev,noexec,relatime,pids<span style=color:#ff79c6>)</span>
cgroup on /sys/fs/cgroup/rdma <span style=color:#8be9fd;font-style:italic>type</span> cgroup <span style=color:#ff79c6>(</span>rw,nosuid,nodev,noexec,relatime,rdma<span style=color:#ff79c6>)</span>
</code></pre></div><p>以 CPU 子系统为例，若在其挂载的目录下创建一个目录 newcg，那么便创建了一个新的控制组且系统会自动在其中生成一些的控制组文件：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ff79c6>[</span>root@koktlzz ~<span style=color:#ff79c6>]</span><span style=color:#6272a4># cd /sys/fs/cgroup/cpu</span>
<span style=color:#ff79c6>[</span>root@koktlzz cpu<span style=color:#ff79c6>]</span><span style=color:#6272a4># mkdir newcg</span>
<span style=color:#ff79c6>[</span>root@koktlzz cpu<span style=color:#ff79c6>]</span><span style=color:#6272a4># ls newcg</span>
cgroup.clone_children  cpuacct.usage_all          cpuacct.usage_sys   cpu.rt_period_us   notify_on_release
cgroup.procs           cpuacct.usage_percpu       cpuacct.usage_user  cpu.rt_runtime_us  tasks
cpuacct.stat           cpuacct.usage_percpu_sys   cpu.cfs_period_us   cpu.shares
cpuacct.usage          cpuacct.usage_percpu_user  cpu.cfs_quota_us    cpu.stat
</code></pre></div><p>而 CPU 子系统的挂载目录中，本身就包含了这类文件。同时还有一些控制组目录，如 docker：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ff79c6>[</span>root@koktlzz cpu<span style=color:#ff79c6>]</span><span style=color:#6272a4># ls /sys/fs/cgroup/cpu</span>
assist                 cpuacct.usage              cpuacct.usage_sys   cpu.rt_runtime_us  newcg              user.slice
cgroup.clone_children  cpuacct.usage_all          cpuacct.usage_user  cpu.shares         notify_on_release
cgroup.procs           cpuacct.usage_percpu       cpu.cfs_period_us   cpu.stat           release_agent
cgroup.sane_behavior   cpuacct.usage_percpu_sys   cpu.cfs_quota_us    docker             system.slice
cpuacct.stat           cpuacct.usage_percpu_user  cpu.rt_period_us    init.scope         tasks
</code></pre></div><p>Docker daemon 首先会在子系统的挂载目录下创建一个名为 docker 的控制组，然后在 docker 控制组中再为每个容器创建一个以容器 id 命名的子控制组。即使上层控制组的文件系统被卸载，下层的子控制组配置依然有效。docker 控制组的层级结构如下所示：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ff79c6>[</span>root@koktlzz docker<span style=color:#ff79c6>]</span><span style=color:#6272a4># tree /sys/fs/cgroup/cpu/docker</span>
/sys/fs/cgroup/cpu/docker
├── cgroup.clone_children
├── cgroup.procs
├── cpuacct.stat
├── cpuacct.usage
├── cpuacct.usage_all
├── cpuacct.usage_percpu
├── cpuacct.usage_percpu_sys
├── cpuacct.usage_percpu_user
├── cpuacct.usage_sys
├── cpuacct.usage_user
├── cpu.cfs_period_us
├── cpu.cfs_quota_us
├── cpu.rt_period_us
├── cpu.rt_runtime_us
├── cpu.shares
├── cpu.stat
├── d682e9c84e04ebe41461fdf3aa6d22903c68cf2260218d1051af13e2bb1a0edd
│   ├── cgroup.clone_children
│   ├── cgroup.procs
│   ├── cpuacct.stat
│   ├── cpuacct.usage
│   ├── cpuacct.usage_all
│   ├── cpuacct.usage_percpu
│   ├── cpuacct.usage_percpu_sys
│   ├── cpuacct.usage_percpu_user
│   ├── cpuacct.usage_sys
│   ├── cpuacct.usage_user
│   ├── cpu.cfs_period_us
│   ├── cpu.cfs_quota_us
│   ├── cpu.rt_period_us
│   ├── cpu.rt_runtime_us
│   ├── cpu.shares
│   ├── cpu.stat
│   ├── notify_on_release
│   └── tasks
├── notify_on_release
└── tasks
</code></pre></div><p>其中的 d682e9c84e04ebe41461fdf3aa6d22903c68cf2260218d1051af13e2bb1a0edd 控制组是一个正在运行的 nginx 容器 id：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ff79c6>[</span>root@koktlzz docker<span style=color:#ff79c6>]</span><span style=color:#6272a4># docker ps</span>
CONTAINER ID   IMAGE     COMMAND                  CREATED      STATUS      PORTS                NAMES
d682e9c84e04   nginx     <span style=color:#f1fa8c>&#34;/docker-entrypoint.…&#34;</span>   <span style=color:#bd93f9>2</span> days ago   Up <span style=color:#bd93f9>2</span> days   0.0.0.0:80-&gt;80/tcp   nginx
</code></pre></div><p>这个容器内的进程 pid 都会写入到该控制组的 tasks 目录中，把任务的 TID（即线程或进程的 id）写入到这个文件就意味着将这个任务加入到该控制组中：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ff79c6>[</span>root@koktlzz docker<span style=color:#ff79c6>]</span><span style=color:#6272a4># cat d682e9c84e04ebe41461fdf3aa6d22903c68cf2260218d1051af13e2bb1a0edd/tasks</span>
<span style=color:#bd93f9>2452208</span>
<span style=color:#bd93f9>2452318</span>
<span style=color:#ff79c6>[</span>root@koktlzz docker<span style=color:#ff79c6>]</span><span style=color:#6272a4># ps -ef | grep 2452208</span>
UID          PID    PPID  C STIME TTY          TIME CMD
root     <span style=color:#bd93f9>2452208</span> <span style=color:#bd93f9>2452188</span>  <span style=color:#bd93f9>0</span> <span style=color:#bd93f9>1</span> 月 <span style=color:#bd93f9>29</span> ?       00:00:00 nginx: master process nginx -g daemon off;
<span style=color:#bd93f9>101</span>      <span style=color:#bd93f9>2452318</span> <span style=color:#bd93f9>2452208</span>  <span style=color:#bd93f9>0</span> <span style=color:#bd93f9>1</span> 月 <span style=color:#bd93f9>29</span> ?       00:00:00 nginx: worker process
root     <span style=color:#bd93f9>2689799</span> <span style=color:#bd93f9>2687314</span>  <span style=color:#bd93f9>0</span> 02:29 pts/0    00:00:00 grep --color<span style=color:#ff79c6>=</span>auto <span style=color:#bd93f9>2452208</span>
</code></pre></div><p>Docker daemon 通过在控制文件（如 cpu.cfs_quata_us）中写入预设的资源配额实现 cgroups 的限制功能，其中 5000 代表限制 CPU 的最高使用率为 50%：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ff79c6>[</span>root@koktlzz docker<span style=color:#ff79c6>]</span><span style=color:#6272a4># docker run -d --cpu-quota=50000 nginx</span>
85ff8f8f779067c4938a011420d9afdb76baa3f69b17d76c0cfe9b8f716b228f
<span style=color:#ff79c6>[</span>root@koktlzz docker<span style=color:#ff79c6>]</span><span style=color:#6272a4># cat 85ff8f8f779067c4938a011420d9afdb76baa3f69b17d76c0cfe9b8f716b228f/cpu.cfs_quota_us</span>
<span style=color:#bd93f9>50000</span>
</code></pre></div><p class=edit-page><a href=https://github.com/koktlzz/koktlzz.github.io/blob/master/content/Docker/Docker%e6%a0%b8%e5%bf%83%e5%8e%9f%e7%90%86/cgroups%e9%9a%94%e7%a6%bb.md><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2"><path d="M17 3a2.828 2.828.0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>Edit this page on GitHub</a></p><div class="docs-navigation d-flex justify-content-between"><a href=https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/namespace%E9%9A%94%E7%A6%BB/><div class="card my-1"><div class="card-body py-2">&larr; Namespace 隔离</div></div></a><a class=ms-auto href=https://koktlzz.github.io/docker/docker%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/%E9%95%9C%E5%83%8F%E4%B8%8E%E5%AE%B9%E5%99%A8/><div class="card my-1"><div class="card-body py-2">镜像与容器 &rarr;</div></div></a></div><script src=https://utteranc.es/client.js repo=koktlzz/koktlzz.github.io issue-term=pathname theme=photon-dark crossorigin=anonymous async></script></main><nav class="docs-toc d-none d-xl-block col-lg-3 col-xl-2" aria-label="Secondary navigation"><div class=page-links><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=#作用>作用</a></li><li><a href=#组织结构>组织结构</a></li><li><a href=#实现>实现</a></li></ul></nav></div></nav></div></div></div><footer class="footer text-muted"><div class=container><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline></ul></div></div></div></footer><script src=https://koktlzz.github.io/js/bootstrap.min.d67050adf5d370668aede4201f82af781b16970934804995a1ca37c1ee9222c2fc530972aa6d5d2b6124caf1fe318f139aac99df2c1e89af65504fc1185c7972.js integrity="sha512-1nBQrfXTcGaK7eQgH4KveBsWlwk0gEmVoco3we6SIsL8Uwlyqm1dK2EkyvH+MY8TmqyZ3yweia9lUE/BGFx5cg==" crossorigin=anonymous defer></script><script src=https://koktlzz.github.io/js/vendor/katex/dist/katex.min.b334e5b00c45f572e7f38a543046f36854bf4cbb543880480c09271a0efedc694d6905f719934f6ede2f26f52e80411c05b90121d722cbf8be2fa8fc51bc6b81.js integrity="sha512-szTlsAxF9XLn84pUMEbzaFS/TLtUOIBIDAknGg7+3GlNaQX3GZNPbt4vJvUugEEcBbkBIdciy/i+L6j8UbxrgQ==" crossorigin=anonymous defer></script><script src=https://koktlzz.github.io/js/vendor/katex/dist/contrib/auto-render.min.916823ec103cf367b71e28a6f01513cb9c3ac6708ccb5229402ec46b8e30a8b25003db694df35d80e9dd666a371f327c6152790617b6256390c164109a90bd4c.js integrity="sha512-kWgj7BA882e3Hiim8BUTy5w6xnCMy1IpQC7Ea44wqLJQA9tpTfNdgOndZmo3HzJ8YVJ5Bhe2JWOQwWQQmpC9TA==" crossorigin=anonymous defer></script><script src=https://koktlzz.github.io/main.min.1febbf2f6fd6a36fc2f57dd50d7935fbb640743329baeb4ef7cefcf2e7630e413371fbba976e103656b82808ee227dc4a84237edb0f8433648bef3a56900661a.js integrity="sha512-H+u/L2/Wo2/C9X3VDXk1+7ZAdDMpuutO98788udjDkEzcfu6l24QNla4KAjuIn3EqEI37bD4QzZIvvOlaQBmGg==" crossorigin=anonymous defer></script></body></html>