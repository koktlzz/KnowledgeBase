<!doctype html><html lang=en-us><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-D022F6NT2P"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-D022F6NT2P')</script><script>(function(b,d,e,a,g){b[a]=b[a]||[],b[a].push({'gtm.start':(new Date).getTime(),event:'gtm.js'});var f=d.getElementsByTagName(e)[0],c=d.createElement(e),h=a!='dataLayer'?'&l='+a:'';c.async=!0,c.src='https://www.googletagmanager.com/gtm.js?id='+g+h,f.parentNode.insertBefore(c,f)})(window,document,'script','dataLayer','GTM-P72R45W')</script><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://koktlzz.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://koktlzz.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://koktlzz.github.io/fonts/KaTeX_Main-Regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://koktlzz.github.io/fonts/KaTeX_Math-Italic.woff2 type=font/woff2 crossorigin><link rel=stylesheet href=https://koktlzz.github.io/main.27967119d9bfd1f18848f648c47494cdf9c8666df2bb5d54d01736bacd6e74dc5f8b9b2cbc827df0fc8e4cef4f4bae41b13b93c84017caf5272a107d6f2af5cc.css integrity="sha512-J5ZxGdm/0fGISPZIxHSUzfnIZm3yu11U0Bc2us1udNxfi5ssvIJ98PyOTO9PS65BsTuTyEAXyvUnKhB9byr1zA==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Docker Compose | KnowledgeBase</title><meta name=description content><link rel=canonical href=https://koktlzz.github.io/container/docker/dockercompose/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="Docker Compose"><meta property="og:description" content="简介 学习了 Docker 基础知识 后，我们已经可以使用 Dockerfile 和 docker build 命令创建一个镜像，并使用 docker run 命令运行一个容器。但如果想要同时运行多个容器，并建立容器之间的依赖关系，仅仅依靠上述的命令就显得十分复杂。因此，我们需要一个新的工具能够高效地对多个容器进行运行管理（批量容器编排），这便是 Docker Compose。
官方文档：
 Compose is a tool for defining and running multi-container Docker applications. With Compose, you use a YAML file to configure your application’s services. Then, with a single command, you create and start all the services from your configuration. To learn more about all the features of Compose, see the list of features. Compose works in all environments: production, staging, development, testing, as well as CI workflows."><meta property="og:url" content="https://koktlzz.github.io/container/docker/dockercompose/"><meta property="og:site_name" content="KnowledgeBase"><meta property="article:published_time" content="2021-02-24T22:05:45+08:00"><meta property="article:modified_time" content="2021-02-24T22:05:45+08:00"><meta property="og:image" content="https://koktlzz.github.io/doks.png"><meta property="og:image:alt" content="KnowledgeBase"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@getdoks"><meta name=twitter:creator content="@henkverlinde"><meta name=twitter:title content="Docker Compose"><meta name=twitter:description content><meta name=twitter:image content="https://koktlzz.github.io/doks.png"><meta name=twitter:image:alt content="Docker Compose"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://koktlzz.github.io/#/schema/organization/1","name":"Doks","url":"https://koktlzz.github.io/","sameAs":["https://twitter.com/getdoks","https://github.com/h-enk/doks"],"logo":{"@type":"ImageObject","@id":"https://koktlzz.github.io/#/schema/image/1","url":"https://koktlzz.github.io/logo-doks.png","width":512,"height":512,"caption":"Doks"},"image":{"@id":"https://koktlzz.github.io/#/schema/image/1"}},{"@type":"WebSite","@id":"https://koktlzz.github.io/#/schema/website/1","url":"https://koktlzz.github.io/","name":"KnowledgeBase","description":"","publisher":{"@id":"https://koktlzz.github.io/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://koktlzz.github.io/container/docker/dockercompose/","url":"https://koktlzz.github.io/container/docker/dockercompose/","name":"Docker Compose","description":"","isPartOf":{"@id":"https://koktlzz.github.io/#/schema/website/1"},"about":{"@id":"https://koktlzz.github.io/#/schema/organization/1"},"datePublished":"2021-02-24T22:05:45CET","dateModified":"2021-02-24T22:05:45CET","breadcrumb":{"@id":"https://koktlzz.github.io/container/docker/dockercompose/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://koktlzz.github.io/container/docker/dockercompose/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://koktlzz.github.io/container/docker/dockercompose/"]}]},{"@type":"BreadcrumbList","@id":"https://koktlzz.github.io/container/docker/dockercompose/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://koktlzz.github.io/","url":"https://koktlzz.github.io/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://koktlzz.github.io/container/","url":"https://koktlzz.github.io/container/","name":"Container"}},{"@type":"ListItem","position":3,"item":{"@type":"WebPage","@id":"https://koktlzz.github.io/container/docker/","url":"https://koktlzz.github.io/container/docker/","name":"Docker"}},{"@type":"ListItem","position":4,"item":{"@id":"https://koktlzz.github.io/container/docker/dockercompose/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://koktlzz.github.io/container/docker/dockercompose/#/schema/image/2","url":"https://koktlzz.github.io/doks.png","contentUrl":"https://koktlzz.github.io/doks.png","caption":"Docker Compose"}]}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=https://koktlzz.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://koktlzz.github.io/favicon-32x32.ico><link rel=icon type=image/png sizes=16x16 href=https://koktlzz.github.io/favicon-16x16.ico><link rel=manifest crossorigin=use-credentials href=https://koktlzz.github.io/site.webmanifest></head><body class="Container single dark"><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-P72R45W" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container-fluid><input class="menu-btn order-0" type=checkbox id=menu-btn>
<label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label><a class="navbar-brand order-1 order-md-0 me-auto" href=https://koktlzz.github.io/>KnowledgeBase</a>
<button id=mode class="btn btn-link order-2 order-md-4" type=button aria-label="Toggle mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button><ul class="navbar-nav social-nav order-3 order-md-5"><li class=nav-item><a class=nav-link href=https://github.com/koktlzz><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><span class="ms-2 visually-hidden">GitHub</span></a></li></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav me-auto order-5 order-md-2"><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/container/docker/intro>Container</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/observability/elasticstack/intro>Observability</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/programming/go/intro>Programming</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/infrastructure/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/tcpip%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B>Infrastructure</a></li></ul><div class="break order-6 d-md-none"></div></div></div></header><div class="wrap container-fluid" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-4 col-xl-3 d-none d-xl-block"><nav class=docs-links aria-label="Main navigation"><h3>Docker</h3><ul class=list-unstyled><li><a class=docs-link href=https://koktlzz.github.io/container/docker/intro/>Getting Started</a></li><li><a class=docs-link href=https://koktlzz.github.io/container/docker/%E7%8B%82%E7%A5%9Edocker%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/>狂神 Docker 课程笔记</a></li><li><a class=docs-link href=https://koktlzz.github.io/container/docker/dockercompose/>Docker Compose</a></li><li><a class=docs-link href=https://koktlzz.github.io/container/docker/namespace%E9%9A%94%E7%A6%BB/>Namespace 隔离</a></li><li><a class=docs-link href=https://koktlzz.github.io/container/docker/cgroups%E9%9A%94%E7%A6%BB/>CGroups 隔离</a></li><li><a class=docs-link href=https://koktlzz.github.io/container/docker/%E9%95%9C%E5%83%8F%E4%B8%8E%E5%AE%B9%E5%99%A8/>镜像与容器</a></li></ul><h3>Kubernetes</h3><ul class=list-unstyled><li><a class=docs-link href=https://koktlzz.github.io/container/kubernetes/intro/>Getting Started</a></li><li><a class=docs-link href=https://koktlzz.github.io/container/kubernetes/infrastructure/>Infrastructure</a></li><li><a class=docs-link href=https://koktlzz.github.io/container/kubernetes/pod%E4%B8%8Enamespace/>Pod 与 Namespace</a></li><li><a class=docs-link href=https://koktlzz.github.io/container/kubernetes/service/>Service</a></li><li><a class=docs-link href=https://koktlzz.github.io/container/kubernetes/volume/>Volume</a></li><li><a class=docs-link href=https://koktlzz.github.io/container/kubernetes/workloads/>Workloads</a></li><li><a class=docs-link href=https://koktlzz.github.io/container/kubernetes/ingress/>Ingress</a></li><li><a class=docs-link href=https://koktlzz.github.io/container/kubernetes/networkpolicy/>Network Policy</a></li><li><a class=docs-link href=https://koktlzz.github.io/container/kubernetes/sdn/>SDN</a></li><li><a class=docs-link href=https://koktlzz.github.io/container/kubernetes/openvswitch/>Open vSwitch</a></li></ul></nav></div><main class="docs-content col-lg-12 col-xl-10"><h1>Docker Compose</h1><p class=lead></p><h2 id=简介>简介<a href=#简介 class=anchor aria-hidden=true>#</a></h2><p>学习了 <a href=https://koktlzz.github.io/docker/docker%E5%9F%BA%E7%A1%80/%E7%8B%82%E7%A5%9Edocker%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/>Docker 基础知识</a> 后，我们已经可以使用 Dockerfile 和 <strong>docker build</strong> 命令创建一个镜像，并使用 <strong>docker run</strong> 命令运行一个容器。但如果想要同时运行多个容器，并建立容器之间的依赖关系，仅仅依靠上述的命令就显得十分复杂。因此，我们需要一个新的工具能够高效地对多个容器进行运行管理（批量容器编排），这便是 Docker Compose。</p><p><a href=https://docs.docker.com/compose/>官方文档：</a></p><blockquote><p>Compose is a tool for defining and running multi-container Docker applications. With Compose, you use a YAML file to configure your application’s services. Then, with a single command, you create and start all the services from your configuration. To learn more about all the features of Compose, see <a href=https://docs.docker.com/compose/#features>the list of features</a>.
Compose works in all environments: production, staging, development, testing, as well as CI workflows. You can learn more about each case in <a href=https://docs.docker.com/compose/#common-use-cases>Common Use Cases</a>.
Using Compose is basically a three-step process:</p><ol><li>Define your app’s environment with a <strong>Dockerfile</strong> so it can be reproduced anywhere.</li><li>Define the services that make up your app in <strong>docker-compose.yml</strong> so they can be run together in an isolated environment.</li><li>Run <strong>docker-compose up</strong> and Compose starts and runs your entire app.</li></ol></blockquote><h2 id=安装>安装<a href=#安装 class=anchor aria-hidden=true>#</a></h2><h3 id=下载>下载<a href=#下载 class=anchor aria-hidden=true>#</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#6272a4># 通过项目源地址下载</span>
sudo curl -L <span style=color:#f1fa8c>&#34;https://github.com/docker/compose/releases/download/1.27.4/docker-compose-</span><span style=color:#ff79c6>$(</span>uname -s<span style=color:#ff79c6>)</span><span style=color:#f1fa8c>-</span><span style=color:#ff79c6>$(</span>uname -m<span style=color:#ff79c6>)</span><span style=color:#f1fa8c>&#34;</span> -o /usr/local/bin/docker-compose
<span style=color:#6272a4># 国内镜像地址</span>
https://get.daocloud.io/docker/compose/releases/download/1.25.5/docker-compose
</code></pre></div><h3 id=修改可执行权限>修改可执行权限<a href=#修改可执行权限 class=anchor aria-hidden=true>#</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo chmod +x /usr/local/bin/docker-compose
</code></pre></div><h3 id=安装成功确认>安装成功确认<a href=#安装成功确认 class=anchor aria-hidden=true>#</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose --version
</code></pre></div><h2 id=getting-started>Getting Started<a href=#getting-started class=anchor aria-hidden=true>#</a></h2><h3 id=官方文档>官方文档<a href=#官方文档 class=anchor aria-hidden=true>#</a></h3><blockquote><p><a href=https://docs.docker.com/compose/gettingstarted/>https://docs.docker.com/compose/gettingstarted/</a></p></blockquote><h3 id=环境配置>环境配置<a href=#环境配置 class=anchor aria-hidden=true>#</a></h3><ul><li><p>创建项目目录</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mkdir composetest
<span style=color:#8be9fd;font-style:italic>cd</span> composetest
</code></pre></div></li><li><p>创建一个 python 应用 app.py，并将下列代码复制进去：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#ff79c6>import</span> time

<span style=color:#ff79c6>import</span> redis
<span style=color:#ff79c6>from</span> flask <span style=color:#ff79c6>import</span> Flask

app <span style=color:#ff79c6>=</span> Flask(__name__)
cache <span style=color:#ff79c6>=</span> redis<span style=color:#ff79c6>.</span>Redis(host<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;redis&#39;</span>, port<span style=color:#ff79c6>=</span><span style=color:#bd93f9>6379</span>)

<span style=color:#ff79c6>def</span> <span style=color:#50fa7b>get_hit_count</span>():
    retries <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>5</span>
    <span style=color:#ff79c6>while</span> <span style=color:#ff79c6>True</span>:
        <span style=color:#ff79c6>try</span>:
            <span style=color:#ff79c6>return</span> cache<span style=color:#ff79c6>.</span>incr(<span style=color:#f1fa8c>&#39;hits&#39;</span>)
        <span style=color:#ff79c6>except</span> redis<span style=color:#ff79c6>.</span>exceptions<span style=color:#ff79c6>.</span>ConnectionError <span style=color:#ff79c6>as</span> exc:
            <span style=color:#ff79c6>if</span> retries <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>:
                <span style=color:#ff79c6>raise</span> exc
            retries <span style=color:#ff79c6>-=</span> <span style=color:#bd93f9>1</span>
            time<span style=color:#ff79c6>.</span>sleep(<span style=color:#bd93f9>0.5</span>)

@app<span style=color:#ff79c6>.</span>route(<span style=color:#f1fa8c>&#39;/&#39;</span>)
<span style=color:#ff79c6>def</span> <span style=color:#50fa7b>hello</span>():
    count <span style=color:#ff79c6>=</span> get_hit_count()
    <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#39;Hello World! I have been seen </span><span style=color:#f1fa8c>{}</span><span style=color:#f1fa8c> times.</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#39;</span><span style=color:#ff79c6>.</span>format(count)
</code></pre></div></li><li><p>创建一个文本文档 requirements.txt，并添加相应依赖</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>flask
redis
</code></pre></div></li></ul><h3 id=创建-dockerfile-文件>创建 Dockerfile 文件<a href=#创建-dockerfile-文件 class=anchor aria-hidden=true>#</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>FROM python:3.7-alpine
WORKDIR /code
ENV <span style=color:#8be9fd;font-style:italic>FLASK_APP</span><span style=color:#ff79c6>=</span>app.py
ENV <span style=color:#8be9fd;font-style:italic>FLASK_RUN_HOST</span><span style=color:#ff79c6>=</span>0.0.0.0
RUN apk add --no-cache gcc musl-dev linux-headers
COPY requirements.txt requirements.txt
RUN pip install -r requirements.txt
EXPOSE <span style=color:#bd93f9>5000</span>
COPY . .
CMD <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;flask&#34;</span>, <span style=color:#f1fa8c>&#34;run&#34;</span><span style=color:#ff79c6>]</span>
</code></pre></div><p>Dcokerfile 文件中每一行地作用已在相应章节有过阐述，官方文档也对此进行了详细说明：</p><blockquote><ul><li>Build an image starting with the Python 3.7 image.</li><li>Set the working directory to <strong>/code</strong>.</li><li>Set environment variables used by the <strong>flask</strong> command.</li><li>Install gcc and other dependencies</li><li>Copy <strong>requirements.txt</strong> and install the Python dependencies.</li><li>Add metadata to the image to describe that the container is listening on port 5000</li><li>Copy the current directory <code>.</code> in the project to the workdir <code>.</code> in the image.</li><li>Set the default command for the container to <strong>flask run</strong>.</li></ul></blockquote><h3 id=定义服务>定义服务<a href=#定义服务 class=anchor aria-hidden=true>#</a></h3><p>在项目目录下，建立一个 docker-compose.yml 文件，并添加如下代码：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#ff79c6>version</span>: <span style=color:#f1fa8c>&#34;3.9&#34;</span>
<span style=color:#ff79c6>services</span>:
  <span style=color:#ff79c6>web</span>:
    <span style=color:#ff79c6>build</span>: .
    <span style=color:#ff79c6>ports</span>:
      - <span style=color:#f1fa8c>&#34;5000:5000&#34;</span>
  <span style=color:#ff79c6>redis</span>:
    <span style=color:#ff79c6>image</span>: <span style=color:#f1fa8c>&#34;redis:alpine&#34;</span>
</code></pre></div><p>该文件定义了两个服务：web 和 redis。其中 web 服务使用 Dockerfile 和 <strong>build .</strong> 命令在当前文件夹下构建，redis 服务则直接使用官方镜像"redis:alpine"。</p><h3 id=构建并运行应用>构建并运行应用<a href=#构建并运行应用 class=anchor aria-hidden=true>#</a></h3><p>在当前文件夹下运行命令 <strong>docker-compose up</strong>，系统开始根据我们写好的 Dockerfile 构建了一个新镜像，并下载了一个 redis 镜像。这时出现了一个 <strong>Warning</strong>：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>WARNING: Image <span style=color:#ff79c6>for</span> service web was built because it did not already exist. To rebuild this image you must use <span style=color:#f1fa8c>`</span>docker-compose build<span style=color:#f1fa8c>`</span> or <span style=color:#f1fa8c>`</span>docker-compose up --build<span style=color:#f1fa8c>`</span>.
Pulling redis <span style=color:#ff79c6>(</span>redis:alpine<span style=color:#ff79c6>)</span>...
</code></pre></div><p>根据提示重新构建镜像：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose build
</code></pre></div><p>当提示构建成功之后，我们再次运行命令 <strong>docker-compose up</strong>：</p><p><img src=https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/20201213171656.png alt=20201213171656></p><p>可以发现应用已经重新启动了。如果我们在另一个终端中使用 <strong>docker ps</strong> 命令，即可看到正在运行的两个服务：</p><p><img src=https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/20201213171715.png alt=20201213171715></p><p>也可以使用 <strong>docker images</strong> 命令查看到新增的镜像：</p><p><img src=https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/20201213171921.png alt=20201213171921></p><p>还可以使用 <strong>docker network ls</strong> 命令查看到新增的网络 <strong>composetest_default</strong>：</p><p><img src=https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/20201213171948.png alt=20201213171948></p><p>接着使用 <strong>docker network inspect</strong> 命令查看该网络的详细信息，发现 web 和 redis 服务均在该网络下运行。因此一个应用下的多个服务均可以通过容器名访问而无需使用 ip 地址：</p><p><img src=https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/20201213172013.png alt=20201213172013></p><p><img src=https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/20201213172201.png alt=20201213172201></p><p>另外，在 app.py 中我们已经定义了 redis 服务的服务名：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>cache <span style=color:#ff79c6>=</span> redis<span style=color:#ff79c6>.</span>Redis(host<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;redis&#39;</span>, port<span style=color:#ff79c6>=</span><span style=color:#bd93f9>6379</span>)
</code></pre></div><p>因此通过服务名来访问 redis 服务也是可以的：</p><p><img src=https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/20201213172039.png alt=20201213172039></p><p>最后，我们只要打开 web 服务暴露的端口 5000，即可看到 app.py 脚本的实现：</p><p><img src=https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/20201213172059.png alt=20201213172059></p><p>服务的名称（composetest_web_1 和 composetest_redis_1 ）是有其命名规则的，第一项是我们的项目目录 composetest，第二项是具体的服务名（web 和 redis），第三项是一个编号。由于我们是单机启动，编号自然为 1。而如果是在一个集群中同时运行这项服务，那么编号便可以将这个集群中的不同服务器上运行的服务加以区分。</p><h3 id=为服务添加挂载>为服务添加挂载<a href=#为服务添加挂载 class=anchor aria-hidden=true>#</a></h3><p>修改我们之前创建的 yml 文件：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#ff79c6>version</span>: <span style=color:#f1fa8c>&#34;3.9&#34;</span>
<span style=color:#ff79c6>services</span>:
  <span style=color:#ff79c6>web</span>:
    <span style=color:#ff79c6>build</span>: .
    <span style=color:#ff79c6>ports</span>:
      - <span style=color:#f1fa8c>&#34;5000:5000&#34;</span>
    <span style=color:#ff79c6>volumes</span>:
      - .:/code
    <span style=color:#ff79c6>environment</span>:
      <span style=color:#ff79c6>FLASK_ENV</span>: development
  <span style=color:#ff79c6>redis</span>:
    <span style=color:#ff79c6>image</span>: <span style=color:#f1fa8c>&#34;redis:alpine&#34;</span>
</code></pre></div><p><strong>volume</strong> 键值对使得项目目录与 web 服务的工作目录/code 进行挂载，因此我们可以即时修改代码而不用重建镜像。另外，<strong>environment</strong> 键规定了 flask 在开发模式下运行，并在更改后重载代码。
随后使用命令 <strong>docker-compose up</strong> 重启应用，这时如果我们修改项目目录里的 app.py 中的输出语句：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#39;Hello from Docker! I have been seen </span><span style=color:#f1fa8c>{}</span><span style=color:#f1fa8c> times.</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#39;</span><span style=color:#ff79c6>.</span>format(count)
</code></pre></div><p>就会发现 <strong>localhost:5000</strong> 显示的网页发生了改变：</p><p><img src=https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/20201213172300.png alt=20201213172300></p><h2 id=yml-文件编写规则>yml 文件编写规则<a href=#yml-文件编写规则 class=anchor aria-hidden=true>#</a></h2><p>官方文档：</p><blockquote><p><a href=https://docs.docker.com/compose/compose-file/>https://docs.docker.com/compose/compose-file/</a></p></blockquote><p>配置文件的编写总共分为三层：</p><ol><li><p>版本</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#ff79c6>version</span>: <span style=color:#f1fa8c>&#34;3.x&#34;</span>
</code></pre></div></li><li><p>服务</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#ff79c6>services</span>: <span style=color:#6272a4>#服务</span>

  <span style=color:#ff79c6>redis</span>:  <span style=color:#6272a4># 服务 1</span>
    <span style=color:#6272a4># 服务配置与 docker 容器配置相同</span>
    <span style=color:#ff79c6>image</span>: redis:alpine
    <span style=color:#ff79c6>ports</span>:
      - <span style=color:#f1fa8c>&#34;6379&#34;</span>
    <span style=color:#ff79c6>networks</span>:
      - frontend
  ......
  <span style=color:#ff79c6>db</span>:  <span style=color:#6272a4># 服务 2</span>
    <span style=color:#ff79c6>image</span>: postgres:9.4
    <span style=color:#ff79c6>volumes</span>:
      - db-data:/var/lib/postgresql/data
    <span style=color:#ff79c6>networks</span>:
      - backend
    ......
</code></pre></div></li><li><p>其他配置</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#ff79c6>networks</span>:   <span style=color:#6272a4># 网络</span>
  <span style=color:#ff79c6>frontend</span>:
  <span style=color:#ff79c6>backend</span>:

<span style=color:#ff79c6>volumes</span>:    <span style=color:#6272a4># 挂载</span>
  <span style=color:#ff79c6>db-data</span>:
<span style=color:#ff79c6>configs</span>:    <span style=color:#6272a4># 配置</span>
  <span style=color:#ff79c6>my_config</span>:
    <span style=color:#ff79c6>file</span>: ./my_config.txt    
......
</code></pre></div></li></ol><h2 id=部署-wordpress-博客>部署 Wordpress 博客<a href=#部署-wordpress-博客 class=anchor aria-hidden=true>#</a></h2><p>官方文档：</p><blockquote><p><a href=https://docs.docker.com/compose/wordpress/>https://docs.docker.com/compose/wordpress/</a></p></blockquote><p class=edit-page><a href=https://github.com/koktlzz/koktlzz.github.io/blob/master/content/Container/Docker/DockerCompose.md><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2"><path d="M17 3a2.828 2.828.0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>Edit this page on GitHub</a></p><div class="docs-navigation d-flex justify-content-between"><a href=https://koktlzz.github.io/container/docker/%E7%8B%82%E7%A5%9Edocker%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/><div class="card my-1"><div class="card-body py-2">&larr; 狂神 Docker 课程笔记</div></div></a><a class=ms-auto href=https://koktlzz.github.io/container/docker/namespace%E9%9A%94%E7%A6%BB/><div class="card my-1"><div class="card-body py-2">Namespace 隔离 &rarr;</div></div></a></div><script src=https://utteranc.es/client.js repo=koktlzz/koktlzz.github.io issue-term=pathname theme=photon-dark crossorigin=anonymous async></script></main><nav class="docs-toc d-none d-xl-block col-lg-3 col-xl-2" aria-label="Secondary navigation"><div class=page-links><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=#简介>简介</a></li><li><a href=#安装>安装</a><ul><li><a href=#下载>下载</a></li><li><a href=#修改可执行权限>修改可执行权限</a></li><li><a href=#安装成功确认>安装成功确认</a></li></ul></li><li><a href=#getting-started>Getting Started</a><ul><li><a href=#官方文档>官方文档</a></li><li><a href=#环境配置>环境配置</a></li><li><a href=#创建-dockerfile-文件>创建 Dockerfile 文件</a></li><li><a href=#定义服务>定义服务</a></li><li><a href=#构建并运行应用>构建并运行应用</a></li><li><a href=#为服务添加挂载>为服务添加挂载</a></li></ul></li><li><a href=#yml-文件编写规则>yml 文件编写规则</a></li><li><a href=#部署-wordpress-博客>部署 Wordpress 博客</a></li></ul></nav></div></nav></div></div></div><script src=https://koktlzz.github.io/js/bootstrap.min.d67050adf5d370668aede4201f82af781b16970934804995a1ca37c1ee9222c2fc530972aa6d5d2b6124caf1fe318f139aac99df2c1e89af65504fc1185c7972.js integrity="sha512-1nBQrfXTcGaK7eQgH4KveBsWlwk0gEmVoco3we6SIsL8Uwlyqm1dK2EkyvH+MY8TmqyZ3yweia9lUE/BGFx5cg==" crossorigin=anonymous defer></script><script src=https://koktlzz.github.io/js/vendor/katex/dist/katex.min.b334e5b00c45f572e7f38a543046f36854bf4cbb543880480c09271a0efedc694d6905f719934f6ede2f26f52e80411c05b90121d722cbf8be2fa8fc51bc6b81.js integrity="sha512-szTlsAxF9XLn84pUMEbzaFS/TLtUOIBIDAknGg7+3GlNaQX3GZNPbt4vJvUugEEcBbkBIdciy/i+L6j8UbxrgQ==" crossorigin=anonymous defer></script><script src=https://koktlzz.github.io/js/vendor/katex/dist/contrib/auto-render.min.916823ec103cf367b71e28a6f01513cb9c3ac6708ccb5229402ec46b8e30a8b25003db694df35d80e9dd666a371f327c6152790617b6256390c164109a90bd4c.js integrity="sha512-kWgj7BA882e3Hiim8BUTy5w6xnCMy1IpQC7Ea44wqLJQA9tpTfNdgOndZmo3HzJ8YVJ5Bhe2JWOQwWQQmpC9TA==" crossorigin=anonymous defer></script><script src=https://koktlzz.github.io/main.min.1febbf2f6fd6a36fc2f57dd50d7935fbb640743329baeb4ef7cefcf2e7630e413371fbba976e103656b82808ee227dc4a84237edb0f8433648bef3a56900661a.js integrity="sha512-H+u/L2/Wo2/C9X3VDXk1+7ZAdDMpuutO98788udjDkEzcfu6l24QNla4KAjuIn3EqEI37bD4QzZIvvOlaQBmGg==" crossorigin=anonymous defer></script></body></html>