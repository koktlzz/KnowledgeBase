<!doctype html><html lang=en-us><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-D022F6NT2P"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-D022F6NT2P')</script><script>(function(b,d,e,a,g){b[a]=b[a]||[],b[a].push({'gtm.start':(new Date).getTime(),event:'gtm.js'});var f=d.getElementsByTagName(e)[0],c=d.createElement(e),h=a!='dataLayer'?'&l='+a:'';c.async=!0,c.src='https://www.googletagmanager.com/gtm.js?id='+g+h,f.parentNode.insertBefore(c,f)})(window,document,'script','dataLayer','GTM-P72R45W')</script><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://koktlzz.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://koktlzz.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://koktlzz.github.io/fonts/KaTeX_Main-Regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://koktlzz.github.io/fonts/KaTeX_Math-Italic.woff2 type=font/woff2 crossorigin><link rel=stylesheet href=https://koktlzz.github.io/main.27967119d9bfd1f18848f648c47494cdf9c8666df2bb5d54d01736bacd6e74dc5f8b9b2cbc827df0fc8e4cef4f4bae41b13b93c84017caf5272a107d6f2af5cc.css integrity="sha512-J5ZxGdm/0fGISPZIxHSUzfnIZm3yu11U0Bc2us1udNxfi5ssvIJ98PyOTO9PS65BsTuTyEAXyvUnKhB9byr1zA==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Ingress | KnowledgeBase</title><meta name=description content><link rel=canonical href=https://koktlzz.github.io/container/kubernetes/ingress/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="Ingress"><meta property="og:description" content="概述 在集群外部，我们可以通过 NodePort 类型的 Service 或 LoadBalancer 类型的 Service 来访问集群内部的 Pod。由于它们的实现均基于 IP 地址和端口并通常使用 TCP 协议，因此属于四层网络模型。
Ingress 则基于七层网络模型，可以向集群外部提供可访问的 URL 并将发往 Ingress 负载均衡器的外部 HTTP 或 HTTPS 请求转发到集群内部的 Service。一个将所有流量都发送到同一 Service 下 Pod 的简单 Ingress 示意图如下：
如图所示，集群外的客户端向 Ingress 负载均衡器发送 HTTP(s) 请求，流量将被转发到节点的 80(443) 端口上。同时，集群内部的 Ingress 对象监听节点的 80(443) 端口，因此流量将被其接收。Ingress 对象将请求的 URL 和目标主机名与其配置的规则进行匹配，并将流量转发到对应的 Service。最后由 Service 将流量转发到后端的 Pod。
在 Openshift 中，提供 Ingress 功能的组件被称为 Router。它以 Pod 的形式部署在集群的 Infra 或 Router 节点上，通过 hostnetwork 对外暴露 80（443）端口，其内部则运行着 HAProxy 服务。Router 会从 etcd 中查询 Route 对象绑定的 Service 的后端 Pod Endpoint 信息，并将其写入到 HAProxy 的路由规则中。这样当 Router 接收到发往其所在节点 80（443）端口的流量时，HAProxy 就可以直接将其转发到对应的 Pod 而无需经过 Service。"><meta property="og:url" content="https://koktlzz.github.io/container/kubernetes/ingress/"><meta property="og:site_name" content="KnowledgeBase"><meta property="article:published_time" content="2020-11-04T09:19:42+01:00"><meta property="article:modified_time" content="2020-11-04T09:19:42+01:00"><meta property="og:image" content="https://koktlzz.github.io/doks.png"><meta property="og:image:alt" content="KnowledgeBase"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@getdoks"><meta name=twitter:creator content="@henkverlinde"><meta name=twitter:title content="Ingress"><meta name=twitter:description content><meta name=twitter:image content="https://koktlzz.github.io/doks.png"><meta name=twitter:image:alt content="Ingress"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://koktlzz.github.io/#/schema/organization/1","name":"Doks","url":"https://koktlzz.github.io/","sameAs":["https://twitter.com/getdoks","https://github.com/h-enk/doks"],"logo":{"@type":"ImageObject","@id":"https://koktlzz.github.io/#/schema/image/1","url":"https://koktlzz.github.io/logo-doks.png","width":512,"height":512,"caption":"Doks"},"image":{"@id":"https://koktlzz.github.io/#/schema/image/1"}},{"@type":"WebSite","@id":"https://koktlzz.github.io/#/schema/website/1","url":"https://koktlzz.github.io/","name":"KnowledgeBase","description":"","publisher":{"@id":"https://koktlzz.github.io/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://koktlzz.github.io/container/kubernetes/ingress/","url":"https://koktlzz.github.io/container/kubernetes/ingress/","name":"Ingress","description":"","isPartOf":{"@id":"https://koktlzz.github.io/#/schema/website/1"},"about":{"@id":"https://koktlzz.github.io/#/schema/organization/1"},"datePublished":"2020-11-04T09:19:42CET","dateModified":"2020-11-04T09:19:42CET","breadcrumb":{"@id":"https://koktlzz.github.io/container/kubernetes/ingress/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://koktlzz.github.io/container/kubernetes/ingress/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://koktlzz.github.io/container/kubernetes/ingress/"]}]},{"@type":"BreadcrumbList","@id":"https://koktlzz.github.io/container/kubernetes/ingress/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://koktlzz.github.io/","url":"https://koktlzz.github.io/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://koktlzz.github.io/container/","url":"https://koktlzz.github.io/container/","name":"Container"}},{"@type":"ListItem","position":3,"item":{"@type":"WebPage","@id":"https://koktlzz.github.io/container/kubernetes/","url":"https://koktlzz.github.io/container/kubernetes/","name":"Kubernetes"}},{"@type":"ListItem","position":4,"item":{"@id":"https://koktlzz.github.io/container/kubernetes/ingress/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://koktlzz.github.io/container/kubernetes/ingress/#/schema/image/2","url":"https://koktlzz.github.io/doks.png","contentUrl":"https://koktlzz.github.io/doks.png","caption":"Ingress"}]}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=https://koktlzz.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://koktlzz.github.io/favicon-32x32.ico><link rel=icon type=image/png sizes=16x16 href=https://koktlzz.github.io/favicon-16x16.ico><link rel=manifest crossorigin=use-credentials href=https://koktlzz.github.io/site.webmanifest></head><body class="Container single dark"><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-P72R45W" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container-fluid><input class="menu-btn order-0" type=checkbox id=menu-btn>
<label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label><a class="navbar-brand order-1 order-md-0 me-auto" href=https://koktlzz.github.io/>KnowledgeBase</a>
<button id=mode class="btn btn-link order-2 order-md-4" type=button aria-label="Toggle mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button><ul class="navbar-nav social-nav order-3 order-md-5"><li class=nav-item><a class=nav-link href=https://github.com/koktlzz><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><span class="ms-2 visually-hidden">GitHub</span></a></li></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav me-auto order-5 order-md-2"><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/container/docker/intro>Container</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/observability/elasticstack/intro>Observability</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/programming/go/intro>Programming</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/infrastructure/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/tcpip%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B>Infrastructure</a></li></ul><div class="break order-6 d-md-none"></div></div></div></header><div class="wrap container-fluid" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-4 col-xl-3 d-none d-xl-block"><nav class=docs-links aria-label="Main navigation"><h3>Docker</h3><ul class=list-unstyled><li><a class=docs-link href=https://koktlzz.github.io/container/docker/intro/>Getting Started</a></li><li><a class=docs-link href=https://koktlzz.github.io/container/docker/%E7%8B%82%E7%A5%9Edocker%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/>狂神 Docker 课程笔记</a></li><li><a class=docs-link href=https://koktlzz.github.io/container/docker/dockercompose/>Docker Compose</a></li><li><a class=docs-link href=https://koktlzz.github.io/container/docker/namespace%E9%9A%94%E7%A6%BB/>Namespace 隔离</a></li><li><a class=docs-link href=https://koktlzz.github.io/container/docker/cgroups%E9%9A%94%E7%A6%BB/>CGroups 隔离</a></li><li><a class=docs-link href=https://koktlzz.github.io/container/docker/%E9%95%9C%E5%83%8F%E4%B8%8E%E5%AE%B9%E5%99%A8/>镜像与容器</a></li></ul><h3>Kubernetes</h3><ul class=list-unstyled><li><a class=docs-link href=https://koktlzz.github.io/container/kubernetes/intro/>Getting Started</a></li><li><a class=docs-link href=https://koktlzz.github.io/container/kubernetes/infrastructure/>Infrastructure</a></li><li><a class=docs-link href=https://koktlzz.github.io/container/kubernetes/pod%E4%B8%8Enamespace/>Pod 与 Namespace</a></li><li><a class=docs-link href=https://koktlzz.github.io/container/kubernetes/service/>Service</a></li><li><a class=docs-link href=https://koktlzz.github.io/container/kubernetes/volume/>Volume</a></li><li><a class=docs-link href=https://koktlzz.github.io/container/kubernetes/workloads/>Workloads</a></li><li><a class=docs-link href=https://koktlzz.github.io/container/kubernetes/ingress/>Ingress</a></li><li><a class=docs-link href=https://koktlzz.github.io/container/kubernetes/networkpolicy/>Network Policy</a></li><li><a class=docs-link href=https://koktlzz.github.io/container/kubernetes/sdn/>SDN</a></li><li><a class=docs-link href=https://koktlzz.github.io/container/kubernetes/openvswitch/>Open vSwitch</a></li></ul></nav></div><main class="docs-content col-lg-12 col-xl-10"><h1>Ingress</h1><p class=lead></p><h2 id=概述>概述<a href=#概述 class=anchor aria-hidden=true>#</a></h2><p>在集群外部，我们可以通过 <a href=https://koktlzz.github.io/kubernetes/kubernetes%E5%9F%BA%E7%A1%80/service/#nodeport>NodePort 类型的 Service</a> 或 <a href=https://koktlzz.github.io/kubernetes/kubernetes%E5%9F%BA%E7%A1%80/service/#loadbalancer>LoadBalancer 类型的 Service</a> 来访问集群内部的 Pod。由于它们的实现均基于 IP 地址和端口并通常使用 TCP 协议，因此属于四层网络模型。</p><p>Ingress 则基于七层网络模型，可以向集群外部提供可访问的 URL 并将发往 Ingress 负载均衡器的外部 HTTP 或 HTTPS 请求转发到集群内部的 Service。一个将所有流量都发送到同一 Service 下 Pod 的简单 Ingress 示意图如下：</p><p><img src=https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/demo.001.jpeg.001.jpeg alt=demo.001.jpeg.001></p><p>如图所示，集群外的客户端向 Ingress 负载均衡器发送 HTTP(s) 请求，流量将被转发到节点的 80(443) 端口上。同时，集群内部的 Ingress 对象监听节点的 80(443) 端口，因此流量将被其接收。Ingress 对象将请求的 URL 和目标主机名与其配置的规则进行匹配，并将流量转发到对应的 Service。最后由 Service 将流量转发到后端的 Pod。</p><p>在 Openshift 中，提供 Ingress 功能的组件被称为 Router。它以 Pod 的形式部署在集群的 Infra 或 Router 节点上，通过 <a href="https://rcarrata.com/openshift/ocp4_shard_same_node/#:~:text=This%20is%20because%20HostNetwork%20allowed%20the%20OpenShift%20Router,Balancing%20for%20an%20external%20physical%20or%20virtual%20LB.">hostnetwork</a> 对外暴露 80（443）端口，其内部则运行着 HAProxy 服务。Router 会从 etcd 中查询 Route 对象绑定的 Service 的后端 Pod Endpoint 信息，并将其写入到 HAProxy 的路由规则中。这样当 Router 接收到发往其所在节点 80（443）端口的流量时，HAProxy 就可以直接将其转发到对应的 Pod 而无需经过 Service。</p><p>通常由 Ingress Controller 负责创建 Ingress 负载均衡器，因此在创建 Ingress 对象之前，集群中必须拥有 Ingress Controller。Kubernetes 目前支持和维护 <a href=https://github.com/kubernetes-sigs/aws-load-balancer-controller#readme>AWS</a>，<a href=https://git.k8s.io/ingress-gce/README.md>GCE</a> 和 <a href=https://git.k8s.io/ingress-nginx/README.md#readme>nginx</a> 三种 Ingress Controller。</p><h2 id=配置>配置<a href=#配置 class=anchor aria-hidden=true>#</a></h2><p>一个最简单的 Ingress 对象配置如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#ff79c6>apiVersion</span>: networking.k8s.io/v1
<span style=color:#ff79c6>kind</span>: Ingress
<span style=color:#ff79c6>metadata</span>:
  <span style=color:#ff79c6>name</span>: minimal-ingress                                <span style=color:#6272a4># 必须是合法的 DNS 子域名名称</span>
  <span style=color:#ff79c6>annotations</span>:
    <span style=color:#ff79c6>nginx.ingress.kubernetes.io/rewrite-target</span>: /      <span style=color:#6272a4># 注解的配置取决于 Ingress Controller</span>
<span style=color:#ff79c6>spec</span>:
<span style=color:#ff79c6>rules</span>:
- <span style=color:#ff79c6>http</span>:
    <span style=color:#ff79c6>paths</span>:
    - <span style=color:#ff79c6>path</span>: /testpath
    <span style=color:#ff79c6>pathType</span>: Prefix
    <span style=color:#ff79c6>backend</span>:
        <span style=color:#ff79c6>service</span>:
        <span style=color:#ff79c6>name</span>: test
        <span style=color:#ff79c6>port</span>:
            <span style=color:#ff79c6>number</span>: <span style=color:#bd93f9>80</span>
</code></pre></div><p>Ingress 对象的<code>spec.rules</code>字段中规定了所有传入请求（incoming request）应匹配的规则列表，且仅支持转发 HTTP 或 HTTPS 流量的规则。每个 HTTP(s) 规则都应包含以下信息：</p><ul><li><code>host</code>：可使用通配符来指定请求的目标主机名格式。若未指定，则该规则适用于指向 Ingress IP 地址的所有入站 HTTP 流量；</li><li><code>paths</code>：路径列表，其中的每个路径都有一个与之关联的后端（<code>backend</code>）；</li><li><code>pathType</code>：每个路径必须指定其类型，Kubernetes 中支持的类型有以下三种：<ul><li><code>ImplementationSpecific</code>：匹配规则取决于 Ingress Class，可以将其视为单独的<code>pathType</code>或与<code>Prefix</code>或<code>Exact</code>路径类型相同。</li><li><code>Exact</code>：精确匹配 URL 路径，且区分大小写；</li><li><code>Prefix</code>：根据以/分隔的 URL 路径前缀进行匹配，且区分大小写。如<code>path</code>字段值为<code>/aaa/bbb</code>，则请求路径<code>/aaa/bbb/ccc</code>与之匹配，而<code>/aaa/bbbccc</code>不匹配。</li></ul></li><li><code>backend</code>：由<code>service.name</code>和<code>service.port.number</code>（或<code>service.port.name</code>）定义的 Service 对象，只有从与规则匹配的<code>host</code>和<code>path</code>发出的入站请求才会被 Ingress 转发到后段的 Service 中。通常在 Ingress Controller 中会配置<code>defaultBackend</code>（默认后端）字段，以处理任何不匹配规则列表的传入请求。</li></ul><p>另外，<code>backend</code>还可以是一个对象引用（ObjectRef），指向 Ingress 对象所处 Namespace 下的另一个 Kubernetes 资源。此时配置中的字段变为<code>backend.resource</code>，其常见用法是将入站数据通过 Ingress 导入到存放静态资产（static assets）的对象存储中：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>...
<span style=color:#ff79c6>rules</span>:
- <span style=color:#ff79c6>http</span>:
    <span style=color:#ff79c6>paths</span>:
        - <span style=color:#ff79c6>path</span>: /icons
        <span style=color:#ff79c6>pathType</span>: ImplementationSpecific
        <span style=color:#ff79c6>backend</span>:
            <span style=color:#ff79c6>resource</span>:                       <span style=color:#6272a4># resource 与 service 的配置互斥，若二者均被设置会无法通过检查</span>
            <span style=color:#ff79c6>apiGroup</span>: k8s.example.com
            <span style=color:#ff79c6>kind</span>: StorageBucket
            <span style=color:#ff79c6>name</span>: icon-assets
</code></pre></div><h2 id=ingress-class>Ingress Class<a href=#ingress-class class=anchor aria-hidden=true>#</a></h2><p>Ingress 资源可以由不同的 Ingress Controller 创建，通常使用不同的配置。因此每个 Ingress 对象通过引用一个 Ingress Class，来指定 Ingress Controller 的种类和配置。Ingress、Ingress Class 和 Ingress Controller 三者之间的关系类似于 Volume 中的 PV、Storage Class 和 Storage Class Provisioner。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#ff79c6>apiVersion</span>: networking.k8s.io/v1
<span style=color:#ff79c6>kind</span>: IngressClass
<span style=color:#ff79c6>metadata</span>:
  <span style=color:#ff79c6>name</span>: external-lb
<span style=color:#ff79c6>spec</span>:
  <span style=color:#ff79c6>controller</span>: example.com/ingress-controller    <span style=color:#6272a4># 实现 Ingress Class 的 Controller 名称</span>
  <span style=color:#ff79c6>parameters</span>:                                   <span style=color:#6272a4># 可选字段，为 Ingress Class 引用的额外配置</span>
    <span style=color:#ff79c6>apiGroup</span>: k8s.example.com
    <span style=color:#ff79c6>kind</span>: IngressParameters
    <span style=color:#ff79c6>name</span>: external-lb
</code></pre></div><h2 id=根据请求的-uri-路由>根据请求的 URI 路由<a href=#根据请求的-uri-路由 class=anchor aria-hidden=true>#</a></h2><p>配置扇出（Fanout）可以根据 HTTP(S) 请求的 URI，将来自同一 IP 地址的流量路由到多个后端 Service。我们可以配置以下 Ingress 完成这一效果：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#ff79c6>apiVersion</span>: networking.k8s.io/v1
<span style=color:#ff79c6>kind</span>: Ingress
<span style=color:#ff79c6>metadata</span>:
  <span style=color:#ff79c6>name</span>: simple-fanout-example
<span style=color:#ff79c6>spec</span>:
  <span style=color:#ff79c6>rules</span>:
  - <span style=color:#ff79c6>host</span>: foo.bar.com
    <span style=color:#ff79c6>http</span>:
      <span style=color:#ff79c6>paths</span>:
      - <span style=color:#ff79c6>path</span>: /foo
        <span style=color:#ff79c6>pathType</span>: Prefix
        <span style=color:#ff79c6>backend</span>:
          <span style=color:#ff79c6>service</span>:
            <span style=color:#ff79c6>name</span>: service1
            <span style=color:#ff79c6>port</span>:
              <span style=color:#ff79c6>number</span>: <span style=color:#bd93f9>4200</span>
      - <span style=color:#ff79c6>path</span>: /bar
        <span style=color:#ff79c6>pathType</span>: Prefix
        <span style=color:#ff79c6>backend</span>:
          <span style=color:#ff79c6>service</span>:
            <span style=color:#ff79c6>name</span>: service2
            <span style=color:#ff79c6>port</span>:
              <span style=color:#ff79c6>number</span>: <span style=color:#bd93f9>8080</span>
</code></pre></div><p>查看已创建的 Ingress 配置，可以在<code>Address</code>字段中看到 Ingress 负载均衡器的 IP 地址：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl describe ingress simple-fanout-example

Name:             simple-fanout-example
Namespace:        default
Address:          178.91.123.132
Default backend:  default-http-backend:80 <span style=color:#ff79c6>(</span>10.8.2.3:8080<span style=color:#ff79c6>)</span>
Rules:
  Host         Path  Backends
  ----         ----  --------
  foo.bar.com
               /foo   service1:4200 <span style=color:#ff79c6>(</span>10.8.0.90:4200<span style=color:#ff79c6>)</span>
               /bar   service2:8080 <span style=color:#ff79c6>(</span>10.8.0.91:8080<span style=color:#ff79c6>)</span>
Annotations:
  nginx.ingress.kubernetes.io/rewrite-target:  /
Events:
  Type     Reason  Age                From                     Message
  ----     ------  ----               ----                     -------
  Normal   ADD     22s                loadbalancer-controller  default/test
</code></pre></div><p>该 Ingress 处理入站请求的示意图如下：</p><p><img src=https://cdn.jsdelivr.net/gh/koktlzz/NoteImg@main/195698510203044522.jpg alt=195698510203044522></p><h2 id=根据请求的目标主机名路由>根据请求的目标主机名路由<a href=#根据请求的目标主机名路由 class=anchor aria-hidden=true>#</a></h2><p>配置 Ingress 实现将指向同一 IP 地址、不同主机名的 HTTP(S) 请求的流量路由到不同的多个后端 Service，不过前提条件是已将目标主机域名解析为 Ingress 的 IP 地址。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#ff79c6>apiVersion</span>: networking.k8s.io/v1
<span style=color:#ff79c6>kind</span>: Ingress
<span style=color:#ff79c6>metadata</span>:
  <span style=color:#ff79c6>name</span>: name-virtual-host-ingress-no-third-host
<span style=color:#ff79c6>spec</span>:
  <span style=color:#ff79c6>rules</span>:
  - <span style=color:#ff79c6>host</span>: first.bar.com                        <span style=color:#6272a4># 指向主机名 first.bar.com 的请求将被转发到 service1</span>
    <span style=color:#ff79c6>http</span>:
      <span style=color:#ff79c6>paths</span>:
      - <span style=color:#ff79c6>pathType</span>: Prefix
        <span style=color:#ff79c6>path</span>: <span style=color:#f1fa8c>&#34;/&#34;</span>
        <span style=color:#ff79c6>backend</span>:
          <span style=color:#ff79c6>service</span>:
            <span style=color:#ff79c6>name</span>: service1
            <span style=color:#ff79c6>port</span>:
              <span style=color:#ff79c6>number</span>: <span style=color:#bd93f9>80</span>
  - <span style=color:#ff79c6>host</span>: second.bar.com                       <span style=color:#6272a4># 指向主机名 second.bar.com 的请求将被转发到 service2</span>
    <span style=color:#ff79c6>http</span>:
      <span style=color:#ff79c6>paths</span>:
      - <span style=color:#ff79c6>pathType</span>: Prefix
        <span style=color:#ff79c6>path</span>: <span style=color:#f1fa8c>&#34;/&#34;</span>
        <span style=color:#ff79c6>backend</span>:
          <span style=color:#ff79c6>service</span>:
            <span style=color:#ff79c6>name</span>: service2
            <span style=color:#ff79c6>port</span>:
              <span style=color:#ff79c6>number</span>: <span style=color:#bd93f9>80</span>
  - <span style=color:#ff79c6>http</span>:
      <span style=color:#ff79c6>paths</span>:
      - <span style=color:#ff79c6>pathType</span>: Prefix
        <span style=color:#ff79c6>path</span>: <span style=color:#f1fa8c>&#34;/&#34;</span>
        <span style=color:#ff79c6>backend</span>:
          <span style=color:#ff79c6>service</span>:
            <span style=color:#ff79c6>name</span>: service3                     <span style=color:#6272a4># 未指定主机名但指向 Ingress IP 的请求将被转发到 servic3</span>
            <span style=color:#ff79c6>port</span>:
              <span style=color:#ff79c6>number</span>: <span style=color:#bd93f9>80</span>
</code></pre></div><p>该 Ingress 处理入站请求的示意图如下：</p><p><img src=https://cdn.jsdelivr.net/gh/koktlzz/NoteImg@main/235255507323325313.jpg alt=235255507323325313></p><h2 id=总结>总结<a href=#总结 class=anchor aria-hidden=true>#</a></h2><p>至此，Kubernetes 中的网络模型已介绍完毕，下图对此进行了一个很好的总结：</p><p><img src=https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/20210313164743.png alt=20210313164743></p><p class=edit-page><a href=https://github.com/koktlzz/koktlzz.github.io/blob/master/content/Container/Kubernetes/Ingress.md><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2"><path d="M17 3a2.828 2.828.0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>Edit this page on GitHub</a></p><div class="docs-navigation d-flex justify-content-between"><a href=https://koktlzz.github.io/container/kubernetes/workloads/><div class="card my-1"><div class="card-body py-2">&larr; Workloads</div></div></a><a class=ms-auto href=https://koktlzz.github.io/container/kubernetes/networkpolicy/><div class="card my-1"><div class="card-body py-2">Network Policy &rarr;</div></div></a></div><script src=https://utteranc.es/client.js repo=koktlzz/koktlzz.github.io issue-term=pathname theme=photon-dark crossorigin=anonymous async></script></main><nav class="docs-toc d-none d-xl-block col-lg-3 col-xl-2" aria-label="Secondary navigation"><div class=page-links><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=#概述>概述</a></li><li><a href=#配置>配置</a></li><li><a href=#ingress-class>Ingress Class</a></li><li><a href=#根据请求的-uri-路由>根据请求的 URI 路由</a></li><li><a href=#根据请求的目标主机名路由>根据请求的目标主机名路由</a></li><li><a href=#总结>总结</a></li></ul></nav></div></nav></div></div></div><script src=https://koktlzz.github.io/js/bootstrap.min.d67050adf5d370668aede4201f82af781b16970934804995a1ca37c1ee9222c2fc530972aa6d5d2b6124caf1fe318f139aac99df2c1e89af65504fc1185c7972.js integrity="sha512-1nBQrfXTcGaK7eQgH4KveBsWlwk0gEmVoco3we6SIsL8Uwlyqm1dK2EkyvH+MY8TmqyZ3yweia9lUE/BGFx5cg==" crossorigin=anonymous defer></script><script src=https://koktlzz.github.io/js/vendor/katex/dist/katex.min.b334e5b00c45f572e7f38a543046f36854bf4cbb543880480c09271a0efedc694d6905f719934f6ede2f26f52e80411c05b90121d722cbf8be2fa8fc51bc6b81.js integrity="sha512-szTlsAxF9XLn84pUMEbzaFS/TLtUOIBIDAknGg7+3GlNaQX3GZNPbt4vJvUugEEcBbkBIdciy/i+L6j8UbxrgQ==" crossorigin=anonymous defer></script><script src=https://koktlzz.github.io/js/vendor/katex/dist/contrib/auto-render.min.916823ec103cf367b71e28a6f01513cb9c3ac6708ccb5229402ec46b8e30a8b25003db694df35d80e9dd666a371f327c6152790617b6256390c164109a90bd4c.js integrity="sha512-kWgj7BA882e3Hiim8BUTy5w6xnCMy1IpQC7Ea44wqLJQA9tpTfNdgOndZmo3HzJ8YVJ5Bhe2JWOQwWQQmpC9TA==" crossorigin=anonymous defer></script><script src=https://koktlzz.github.io/main.min.1febbf2f6fd6a36fc2f57dd50d7935fbb640743329baeb4ef7cefcf2e7630e413371fbba976e103656b82808ee227dc4a84237edb0f8433648bef3a56900661a.js integrity="sha512-H+u/L2/Wo2/C9X3VDXk1+7ZAdDMpuutO98788udjDkEzcfu6l24QNla4KAjuIn3EqEI37bD4QzZIvvOlaQBmGg==" crossorigin=anonymous defer></script></body></html>