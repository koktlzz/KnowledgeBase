<!doctype html><html lang=en-us><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-D022F6NT2P"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-D022F6NT2P')</script><script>(function(b,d,e,a,g){b[a]=b[a]||[],b[a].push({'gtm.start':(new Date).getTime(),event:'gtm.js'});var f=d.getElementsByTagName(e)[0],c=d.createElement(e),h=a!='dataLayer'?'&l='+a:'';c.async=!0,c.src='https://www.googletagmanager.com/gtm.js?id='+g+h,f.parentNode.insertBefore(c,f)})(window,document,'script','dataLayer','GTM-P72R45W')</script><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://koktlzz.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://koktlzz.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://koktlzz.github.io/fonts/KaTeX_Main-Regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://koktlzz.github.io/fonts/KaTeX_Math-Italic.woff2 type=font/woff2 crossorigin><link rel=stylesheet href=https://koktlzz.github.io/main.09ec2f025fdb9f947415a273a44df08d5f3ec03e47aaa8b29ade63a14a6c9a7bc68d57acd1f4c9231d9c21a0673bb8280a543e2552346241f7c2b9c86274c6ff.css integrity="sha512-CewvAl/bn5R0FaJzpE3wjV8+wD5Hqqiymt5joUpsmnvGjVes0fTJIx2cIaBnO7goClQ+JVI0YkH3wrnIYnTG/w==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Text analysis | KnowledgeBase</title><meta name=description content><link rel=canonical href=https://koktlzz.github.io/observability/elasticstack/textanalysis/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="Text analysis"><meta property="og:description" content="概述 Text analysis（分词）使 Elasticsearch 在执行全文搜索时，不仅可以精确匹配搜索项，还能够返回与其相关的所有结果。 举例来说，如果一个索引中有以下几个文档：
 A quick brown fox jumps over the lazy dog fast fox foxes leap  当我们搜索Quick fox jumps，我们很可能希望搜索结果中包含了上述文档，因为它们都与搜索项有着密切的关系：包含、复数和同义词。这便是分词器存在的价值，它让 Elasticsearch 的搜索结果更加符合使用者的预期。
组成 在 Elasticsearch 中可以通过内置分词器实现分词，也可以按需定制分词器。 分词器由三部分组成：
Character Filters Character Filters 将原始文本作为字符流接受并进行处理，它的作用是整理字符串。例如将印度-阿拉伯数字 （٠‎١٢٣٤٥٦٧٨‎٩‎）转化为阿拉伯-拉丁数字（0123456789）、去除 HTML 元素、将&转化为 and 等。一个分词器可以有 0 个或多个 Character Filters，多个 Character Filters 的加载是有顺序的。
Tokenizer Tokenizer 将字符流按照给定的规则切分为 Token（可以看作为单词）。比如 whitespace 分词器在遇到空格和标点的时候，会将文本进行拆分。同时，Tokenizer 还会记录每个 Token 在文本中的位置（position）、占位长度（positionLength）以及首尾字符的偏移量（start_offset/end_offset）。下图中每个 Token 的 positionLength 都为 1，position 分别为 0、1 和 2：
与 Character Filters 不同的是，每个分词器有且仅有一个 Tokenizer。"><meta property="og:url" content="https://koktlzz.github.io/observability/elasticstack/textanalysis/"><meta property="og:site_name" content="KnowledgeBase"><meta property="article:published_time" content="2020-11-04T09:19:42+01:00"><meta property="article:modified_time" content="2020-11-04T09:19:42+01:00"><meta property="og:image" content="https://koktlzz.github.io/doks.png"><meta property="og:image:alt" content="KnowledgeBase"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@getdoks"><meta name=twitter:creator content="@henkverlinde"><meta name=twitter:title content="Text analysis"><meta name=twitter:description content><meta name=twitter:image content="https://koktlzz.github.io/doks.png"><meta name=twitter:image:alt content="Text analysis"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://koktlzz.github.io/#/schema/organization/1","name":"Doks","url":"https://koktlzz.github.io/","sameAs":["https://twitter.com/getdoks","https://github.com/h-enk/doks"],"logo":{"@type":"ImageObject","@id":"https://koktlzz.github.io/#/schema/image/1","url":"https://koktlzz.github.io/logo-doks.png","width":512,"height":512,"caption":"Doks"},"image":{"@id":"https://koktlzz.github.io/#/schema/image/1"}},{"@type":"WebSite","@id":"https://koktlzz.github.io/#/schema/website/1","url":"https://koktlzz.github.io/","name":"KnowledgeBase","description":"","publisher":{"@id":"https://koktlzz.github.io/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://koktlzz.github.io/observability/elasticstack/textanalysis/","url":"https://koktlzz.github.io/observability/elasticstack/textanalysis/","name":"Text analysis","description":"","isPartOf":{"@id":"https://koktlzz.github.io/#/schema/website/1"},"about":{"@id":"https://koktlzz.github.io/#/schema/organization/1"},"datePublished":"2020-11-04T09:19:42CET","dateModified":"2020-11-04T09:19:42CET","breadcrumb":{"@id":"https://koktlzz.github.io/observability/elasticstack/textanalysis/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://koktlzz.github.io/observability/elasticstack/textanalysis/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://koktlzz.github.io/observability/elasticstack/textanalysis/"]}]},{"@type":"BreadcrumbList","@id":"https://koktlzz.github.io/observability/elasticstack/textanalysis/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://koktlzz.github.io/","url":"https://koktlzz.github.io/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://koktlzz.github.io/observability/","url":"https://koktlzz.github.io/observability/","name":"Observability"}},{"@type":"ListItem","position":3,"item":{"@type":"WebPage","@id":"https://koktlzz.github.io/observability/elasticstack/","url":"https://koktlzz.github.io/observability/elasticstack/","name":"Elasticstack"}},{"@type":"ListItem","position":4,"item":{"@id":"https://koktlzz.github.io/observability/elasticstack/textanalysis/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://koktlzz.github.io/observability/elasticstack/textanalysis/#/schema/image/2","url":"https://koktlzz.github.io/doks.png","contentUrl":"https://koktlzz.github.io/doks.png","caption":"Text analysis"}]}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=https://koktlzz.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://koktlzz.github.io/favicon-32x32.ico><link rel=icon type=image/png sizes=16x16 href=https://koktlzz.github.io/favicon-16x16.ico><link rel=manifest crossorigin=use-credentials href=https://koktlzz.github.io/site.webmanifest></head><body class="Observability single dark"><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-P72R45W" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container-fluid><input class="menu-btn order-0" type=checkbox id=menu-btn>
<label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label><a class="navbar-brand order-1 order-md-0 me-auto" href=https://koktlzz.github.io/>KnowledgeBase</a>
<button id=mode class="btn btn-link order-2 order-md-4" type=button aria-label="Toggle mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button><ul class="navbar-nav social-nav order-3 order-md-5"><li class=nav-item><a class=nav-link href=https://github.com/koktlzz><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><span class="ms-2 visually-hidden">GitHub</span></a></li></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav me-auto order-5 order-md-2"><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/container/docker/intro>Container</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/observability/elasticstack/intro>Observability</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/programming/go/intro>Programming</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/infrastructure/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/tcpip%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B>Infrastructure</a></li></ul><div class="break order-6 d-md-none"></div></div></div></header><div class="wrap container-fluid" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-4 col-xl-3 d-none d-xl-block"><nav class=docs-links aria-label="Main navigation"><h3>ElasticStack</h3><ul class=list-unstyled><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/intro/>Getting Started</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/%E5%8D%95%E8%8A%82%E7%82%B9%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B/>单节点部署流程</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/elasticsearchintro/>ElasticSearch 简介</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/mapping/>Mapping</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/textanalysis/>Text analysis</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/template/>Template</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/ilm/>ILM</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/snapshot/>Snapshot</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/>Elasticsearch 性能调优</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/kafkaintro/>Kafka 简介</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/hw/>Kafka 副本备份</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/transaction/>Kafka 事务</a></li></ul><h3>Prometheus</h3><ul class=list-unstyled><li><a class=docs-link href=https://koktlzz.github.io/observability/prometheus/intro/>Getting Started</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/prometheus/operator%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE/>Operator 自定义配置</a></li></ul><h3>Opentelemetry</h3><ul class=list-unstyled><li><a class=docs-link href=https://koktlzz.github.io/observability/opentelemetry/intro/>Getting Started</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/opentelemetry/collectorexample/>Collector Example</a></li></ul></nav></div><main class="docs-content col-lg-12 col-xl-10"><h1>Text analysis</h1><p class=lead></p><h2 id=概述>概述<a href=#概述 class=anchor aria-hidden=true>#</a></h2><p>Text analysis（分词）使 Elasticsearch 在执行全文搜索时，不仅可以精确匹配搜索项，还能够返回与其相关的所有结果。 举例来说，如果一个索引中有以下几个文档：</p><ul><li>A quick brown fox jumps over the lazy dog</li><li>fast fox</li><li>foxes leap</li></ul><p>当我们搜索<code>Quick fox jumps</code>，我们很可能希望搜索结果中包含了上述文档，因为它们都与搜索项有着密切的关系：包含、复数和同义词。这便是分词器存在的价值，它让 Elasticsearch 的搜索结果更加符合使用者的预期。</p><h2 id=组成>组成<a href=#组成 class=anchor aria-hidden=true>#</a></h2><p>在 Elasticsearch 中可以通过内置分词器实现分词，也可以按需定制分词器。 分词器由三部分组成：</p><h3 id=character-filters>Character Filters<a href=#character-filters class=anchor aria-hidden=true>#</a></h3><p>Character Filters 将原始文本作为字符流接受并进行处理，它的作用是整理字符串。例如将印度-阿拉伯数字 （٠‎١٢٣٤٥٦٧٨‎٩‎）转化为阿拉伯-拉丁数字（0123456789）、去除 HTML 元素、将&转化为 and 等。一个分词器可以有 0 个或多个 Character Filters，多个 Character Filters 的加载是有顺序的。</p><h3 id=tokenizer>Tokenizer<a href=#tokenizer class=anchor aria-hidden=true>#</a></h3><p>Tokenizer 将字符流按照给定的规则切分为 Token（可以看作为单词）。比如 whitespace 分词器在遇到空格和标点的时候，会将文本进行拆分。同时，Tokenizer 还会记录每个 Token 在文本中的位置（position）、占位长度（positionLength）以及首尾字符的偏移量（start_offset/end_offset）。下图中每个 Token 的 positionLength 都为 1，position 分别为 0、1 和 2：</p><p><img src=https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/%E6%88%AA%E5%B1%8F2021-03-04%20%E4%B8%8A%E5%8D%8812.24.56.png alt="截屏 2021-03-04 上午 12.24.56"></p><p>与 Character Filters 不同的是，每个分词器有且仅有一个 Tokenizer。</p><h3 id=token-filters>Token Filters<a href=#token-filters class=anchor aria-hidden=true>#</a></h3><p>Token Filters 接收切分后的 Token 流并对 Token 进行加工，如小写（lowercase token filter），删除 a，and 和 the 等 stopwords（stop token filter），增加同义词（synonym token filter），<a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/stemming.html>词根处理 (Stemming)</a> 等。Token Filters 并不会改变 Token 的位置，也不会改变其字符的偏移量。如下图所示，quick 和它的同义词 fast 具有相同的 position 和 positionLength：</p><p><img src=https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/%E6%88%AA%E5%B1%8F2021-03-04%20%E4%B8%8A%E5%8D%8812.30.14.png alt="截屏 2021-03-04 上午 12.30.14"></p><p>而对于 domain name system 和它的的同义词 dns 来说，它们的 postion 都为 0，但 positionLength 分别为 1 和 3:</p><p><img src=https://cdn.jsdelivr.net/gh/koktlzz/ImgBed@master/%E6%88%AA%E5%B1%8F2021-03-04%20%E4%B8%8A%E5%8D%8812.50.50.png alt=1></p><p>一个分词器可以有 0 个或多个 Token Filters，多个 Token Filters 的加载是有顺序的。</p><h2 id=应用场景>应用场景<a href=#应用场景 class=anchor aria-hidden=true>#</a></h2><p>分词器的应用场景有两个：文档被索引时（Index time）和文档被搜索时（Search time）。</p><ul><li>Index time：当一个文档被索引时，所有类型为 text 的字段的值都会被分词；</li><li>Search time：当对类型为 text 的字段进行全文搜索时，搜索项将被分词。</li></ul><p>因此，我们可以根据分词器应用场景的不同，将其分为索引分词器（index analyzer）和搜索分词器（search analyzer）两种。在大多数情况下，应当在索引和搜索时使用同样的分词器。这样可以保证索引中的字段值和查询项被分词为相同形式的 Token，从而使查询结果更加符合我们的预期。</p><h2 id=配置>配置<a href=#配置 class=anchor aria-hidden=true>#</a></h2><h3 id=测试分词器>测试分词器<a href=#测试分词器 class=anchor aria-hidden=true>#</a></h3><p>可以使用 <a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-analyze.html>analyze API</a> 来测试分词器对文本的处理情况，以一个内置的分词为例：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>POST _analyze
{
  <span style=color:#ff79c6>&#34;analyzer&#34;</span>: <span style=color:#f1fa8c>&#34;whitespace&#34;</span>,
  <span style=color:#ff79c6>&#34;text&#34;</span>: <span style=color:#f1fa8c>&#34;The quick brown fox.&#34;</span>
}

// 返回
{
  <span style=color:#ff79c6>&#34;tokens&#34;</span>: [
    {
      <span style=color:#ff79c6>&#34;token&#34;</span>: <span style=color:#f1fa8c>&#34;The&#34;</span>,
      <span style=color:#ff79c6>&#34;start_offset&#34;</span>: <span style=color:#bd93f9>0</span>,
      <span style=color:#ff79c6>&#34;end_offset&#34;</span>: <span style=color:#bd93f9>3</span>,
      <span style=color:#ff79c6>&#34;type&#34;</span>: <span style=color:#f1fa8c>&#34;word&#34;</span>,
      <span style=color:#ff79c6>&#34;position&#34;</span>: <span style=color:#bd93f9>0</span>
    },
    {
      <span style=color:#ff79c6>&#34;token&#34;</span>: <span style=color:#f1fa8c>&#34;quick&#34;</span>,
      <span style=color:#ff79c6>&#34;start_offset&#34;</span>: <span style=color:#bd93f9>4</span>,
      <span style=color:#ff79c6>&#34;end_offset&#34;</span>: <span style=color:#bd93f9>9</span>,
      <span style=color:#ff79c6>&#34;type&#34;</span>: <span style=color:#f1fa8c>&#34;word&#34;</span>,
      <span style=color:#ff79c6>&#34;position&#34;</span>: <span style=color:#bd93f9>1</span>
    },
    {
      <span style=color:#ff79c6>&#34;token&#34;</span>: <span style=color:#f1fa8c>&#34;brown&#34;</span>,
      <span style=color:#ff79c6>&#34;start_offset&#34;</span>: <span style=color:#bd93f9>10</span>,
      <span style=color:#ff79c6>&#34;end_offset&#34;</span>: <span style=color:#bd93f9>15</span>,
      <span style=color:#ff79c6>&#34;type&#34;</span>: <span style=color:#f1fa8c>&#34;word&#34;</span>,
      <span style=color:#ff79c6>&#34;position&#34;</span>: <span style=color:#bd93f9>2</span>
    },
    {
      <span style=color:#ff79c6>&#34;token&#34;</span>: <span style=color:#f1fa8c>&#34;fox.&#34;</span>,
      <span style=color:#ff79c6>&#34;start_offset&#34;</span>: <span style=color:#bd93f9>16</span>,
      <span style=color:#ff79c6>&#34;end_offset&#34;</span>: <span style=color:#bd93f9>20</span>,
      <span style=color:#ff79c6>&#34;type&#34;</span>: <span style=color:#f1fa8c>&#34;word&#34;</span>,
      <span style=color:#ff79c6>&#34;position&#34;</span>: <span style=color:#bd93f9>3</span>
    }
  ]
}
</code></pre></div><p>当然也可以测试 0 个或多个 Character Filters、一个 Tokenizer 和 0 个或多个 Token Filters 的组合效果：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>POST _analyze
{
  <span style=color:#ff79c6>&#34;tokenizer&#34;</span>: <span style=color:#f1fa8c>&#34;standard&#34;</span>,
  <span style=color:#ff79c6>&#34;filter&#34;</span>:  [ <span style=color:#f1fa8c>&#34;lowercase&#34;</span>, <span style=color:#f1fa8c>&#34;asciifolding&#34;</span> ],
  <span style=color:#ff79c6>&#34;text&#34;</span>:      <span style=color:#f1fa8c>&#34;Is this déja vu?&#34;</span>
}
</code></pre></div><h3 id=配置内置分词器>配置内置分词器<a href=#配置内置分词器 class=anchor aria-hidden=true>#</a></h3><p>我们可以对内置分词进行修改，从而让其实现我们想要的分词效果。例如，创建一个基于 <a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-standard-analyzer.html>standard analyzer</a> 的分词器 std_english，它可以在分词时删除英文中的 a，and 和 the 等 stopwords：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>PUT my-index<span style=color:#bd93f9>-000001</span>
{
  <span style=color:#ff79c6>&#34;settings&#34;</span>: {
    <span style=color:#ff79c6>&#34;analysis&#34;</span>: {
      <span style=color:#ff79c6>&#34;analyzer&#34;</span>: {
        <span style=color:#ff79c6>&#34;std_english&#34;</span>: { 
          <span style=color:#ff79c6>&#34;type&#34;</span>:      <span style=color:#f1fa8c>&#34;standard&#34;</span>,   // type 为 standard（或 simple、Whitespace 等）表示基于内置的分词器
          <span style=color:#ff79c6>&#34;stopwords&#34;</span>: <span style=color:#f1fa8c>&#34;_english_&#34;</span>
        }
      }
    }
  },
  <span style=color:#ff79c6>&#34;mappings&#34;</span>: {
    <span style=color:#ff79c6>&#34;properties&#34;</span>: {
      <span style=color:#ff79c6>&#34;my_text&#34;</span>: {
        <span style=color:#ff79c6>&#34;type&#34;</span>:     <span style=color:#f1fa8c>&#34;text&#34;</span>,
        <span style=color:#ff79c6>&#34;analyzer&#34;</span>: <span style=color:#f1fa8c>&#34;standard&#34;</span>, 
        <span style=color:#ff79c6>&#34;fields&#34;</span>: {
          <span style=color:#ff79c6>&#34;english&#34;</span>: {
            <span style=color:#ff79c6>&#34;type&#34;</span>:     <span style=color:#f1fa8c>&#34;text&#34;</span>,
            <span style=color:#ff79c6>&#34;analyzer&#34;</span>: <span style=color:#f1fa8c>&#34;std_english&#34;</span> 
          }
        }
      }
    }
  }
}
</code></pre></div><p>索引的 Mapping 中规定，对<code>my_text</code>字段使用 standard analyzer 分词，而<code>my_text.english</code>字段则使用 std_english。通过 analyze API 进行测试：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>POST my-index<span style=color:#bd93f9>-000001</span>/_analyze
{
  <span style=color:#ff79c6>&#34;field&#34;</span>: <span style=color:#f1fa8c>&#34;my_text&#34;</span>, 
  <span style=color:#ff79c6>&#34;text&#34;</span>: <span style=color:#f1fa8c>&#34;The old brown cow&#34;</span>
}

POST my-index<span style=color:#bd93f9>-000001</span>/_analyze
{
  <span style=color:#ff79c6>&#34;field&#34;</span>: <span style=color:#f1fa8c>&#34;my_text.english&#34;</span>, 
  <span style=color:#ff79c6>&#34;text&#34;</span>: <span style=color:#f1fa8c>&#34;The old brown cow&#34;</span>
}
</code></pre></div><h3 id=创建自定义分词器>创建自定义分词器<a href=#创建自定义分词器 class=anchor aria-hidden=true>#</a></h3><p>自定义分词器和所有分词器一样，都拥有一个 Tokenizer，0 个或多个 Character Filters 和 0 个或多个 Token Filters，对应的字段分别为<code>tokenizer</code>、<code>char_filter</code>和<code>filter</code>。除此之外，还可以通过定义 <a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/position-increment-gap.html><code>position_increment_gap</code></a> 字段来确保查询项是一个词组时不会与不同数组中的两个元素发生匹配。例如：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>PUT my-index<span style=color:#bd93f9>-000001</span>
{
  <span style=color:#ff79c6>&#34;settings&#34;</span>: {
    <span style=color:#ff79c6>&#34;analysis&#34;</span>: {
      <span style=color:#ff79c6>&#34;analyzer&#34;</span>: {
        <span style=color:#ff79c6>&#34;my_custom_analyzer&#34;</span>: {
          <span style=color:#ff79c6>&#34;type&#34;</span>: <span style=color:#f1fa8c>&#34;custom&#34;</span>, 
          <span style=color:#ff79c6>&#34;tokenizer&#34;</span>: <span style=color:#f1fa8c>&#34;standard&#34;</span>,
          <span style=color:#ff79c6>&#34;char_filter&#34;</span>: [
            <span style=color:#f1fa8c>&#34;html_strip&#34;</span>
          ],
          <span style=color:#ff79c6>&#34;filter&#34;</span>: [
            <span style=color:#f1fa8c>&#34;lowercase&#34;</span>,
            <span style=color:#f1fa8c>&#34;asciifolding&#34;</span>
          ]
        }
      }
    }
  }
}

POST my-index<span style=color:#bd93f9>-000001</span>/_analyze
{
  <span style=color:#ff79c6>&#34;analyzer&#34;</span>: <span style=color:#f1fa8c>&#34;my_custom_analyzer&#34;</span>,
  <span style=color:#ff79c6>&#34;text&#34;</span>: <span style=color:#f1fa8c>&#34;Is this &lt;b&gt;déjà vu&lt;/b&gt;?&#34;</span>
}
</code></pre></div><p>文本<code>Is this &lt;b>déjà vu&lt;/b>?</code>在索引到文档中后将会变成：<code>[ is, this, deja, vu ]</code>。</p><h3 id=指定分词器>指定分词器<a href=#指定分词器 class=anchor aria-hidden=true>#</a></h3><p>上文提到，根据应用场景的不同，我们将分词器分为了索引分词器（index analyzer）和搜索分词器（search analyzer）。Elasticsearch 在确定需要使用的索引分词器前会依次检查以下参数，</p><ul><li>索引中某一 text 字段的 <a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/analyzer.html><code>analyzer</code></a> 参数</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>PUT my-index<span style=color:#bd93f9>-000001</span>
{
  <span style=color:#ff79c6>&#34;mappings&#34;</span>: {
    <span style=color:#ff79c6>&#34;properties&#34;</span>: {
      <span style=color:#ff79c6>&#34;title&#34;</span>: {
        <span style=color:#ff79c6>&#34;type&#34;</span>: <span style=color:#f1fa8c>&#34;text&#34;</span>,
        <span style=color:#ff79c6>&#34;analyzer&#34;</span>: <span style=color:#f1fa8c>&#34;whitespace&#34;</span>
      }
    }
  }
}
</code></pre></div><ul><li>索引的<code>settings.analysis.analyzer.default</code>参数</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>PUT my-index<span style=color:#bd93f9>-000001</span>
{
  <span style=color:#ff79c6>&#34;settings&#34;</span>: {
    <span style=color:#ff79c6>&#34;analysis&#34;</span>: {
      <span style=color:#ff79c6>&#34;analyzer&#34;</span>: {
        <span style=color:#ff79c6>&#34;default&#34;</span>: {
          <span style=color:#ff79c6>&#34;type&#34;</span>: <span style=color:#f1fa8c>&#34;simple&#34;</span>
        }
      }
    }
  }
}
</code></pre></div><ul><li>若上述参数均未指定，则使用内置的 standard analyzer。</li></ul><p>而对于搜索分词器的指定，Elasticsearch 则需要依次检查这些参数：</p><ul><li>搜索请求中的<code>analyzer</code>参数</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>GET my-index<span style=color:#bd93f9>-000001</span>/_search
{
  <span style=color:#ff79c6>&#34;query&#34;</span>: {
    <span style=color:#ff79c6>&#34;match&#34;</span>: {
      <span style=color:#ff79c6>&#34;message&#34;</span>: {
        <span style=color:#ff79c6>&#34;query&#34;</span>: <span style=color:#f1fa8c>&#34;Quick foxes&#34;</span>,
        <span style=color:#ff79c6>&#34;analyzer&#34;</span>: <span style=color:#f1fa8c>&#34;stop&#34;</span>
      }
    }
  }
}
</code></pre></div><ul><li>索引中某一 text 字段的<code>search_analyzer</code>参数</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>PUT my-index<span style=color:#bd93f9>-000001</span>
{
  <span style=color:#ff79c6>&#34;mappings&#34;</span>: {
    <span style=color:#ff79c6>&#34;properties&#34;</span>: {
      <span style=color:#ff79c6>&#34;title&#34;</span>: {
        <span style=color:#ff79c6>&#34;type&#34;</span>: <span style=color:#f1fa8c>&#34;text&#34;</span>,
        <span style=color:#ff79c6>&#34;analyzer&#34;</span>: <span style=color:#f1fa8c>&#34;whitespace&#34;</span>,      // 索引时使用 whitespace 分词
        <span style=color:#ff79c6>&#34;search_analyzer&#34;</span>: <span style=color:#f1fa8c>&#34;simple&#34;</span>    // 搜索时使用 simple 分词
      }
    }
  }
}
</code></pre></div><ul><li>索引的<code>settings.analysis.analyzer.default_search</code>参数：</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>PUT my-index<span style=color:#bd93f9>-000001</span>
{
  <span style=color:#ff79c6>&#34;settings&#34;</span>: {
    <span style=color:#ff79c6>&#34;analysis&#34;</span>: {
      <span style=color:#ff79c6>&#34;analyzer&#34;</span>: {
        <span style=color:#ff79c6>&#34;default&#34;</span>: {
          <span style=color:#ff79c6>&#34;type&#34;</span>: <span style=color:#f1fa8c>&#34;simple&#34;</span>          // 索引时使用 simple 分词
        },
        <span style=color:#ff79c6>&#34;default_search&#34;</span>: {
          <span style=color:#ff79c6>&#34;type&#34;</span>: <span style=color:#f1fa8c>&#34;whitespace&#34;</span>      // 搜索时使用 whitespace 分词
        }
      }
    }
  }
}
</code></pre></div><ul><li>若上述参数均未指定，则使用内置的 standard analyzer。</li></ul><p class=edit-page><a href=https://github.com/koktlzz/koktlzz.github.io/blob/master/content/Observability/ElasticStack/TextAnalysis.md><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2"><path d="M17 3a2.828 2.828.0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>Edit this page on GitHub</a></p><div class="docs-navigation d-flex justify-content-between"><a href=https://koktlzz.github.io/observability/elasticstack/mapping/><div class="card my-1"><div class="card-body py-2">&larr; Mapping</div></div></a><a class=ms-auto href=https://koktlzz.github.io/observability/elasticstack/template/><div class="card my-1"><div class="card-body py-2">Template &rarr;</div></div></a></div><script src=https://utteranc.es/client.js repo=koktlzz/koktlzz.github.io issue-term=pathname theme=photon-dark crossorigin=anonymous async></script></main><nav class="docs-toc d-none d-xl-block col-lg-3 col-xl-2" aria-label="Secondary navigation"><div class=page-links><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=#概述>概述</a></li><li><a href=#组成>组成</a><ul><li><a href=#character-filters>Character Filters</a></li><li><a href=#tokenizer>Tokenizer</a></li><li><a href=#token-filters>Token Filters</a></li></ul></li><li><a href=#应用场景>应用场景</a></li><li><a href=#配置>配置</a><ul><li><a href=#测试分词器>测试分词器</a></li><li><a href=#配置内置分词器>配置内置分词器</a></li><li><a href=#创建自定义分词器>创建自定义分词器</a></li><li><a href=#指定分词器>指定分词器</a></li></ul></li></ul></nav></div></nav></div></div></div><script src=https://koktlzz.github.io/js/bootstrap.min.d67050adf5d370668aede4201f82af781b16970934804995a1ca37c1ee9222c2fc530972aa6d5d2b6124caf1fe318f139aac99df2c1e89af65504fc1185c7972.js integrity="sha512-1nBQrfXTcGaK7eQgH4KveBsWlwk0gEmVoco3we6SIsL8Uwlyqm1dK2EkyvH+MY8TmqyZ3yweia9lUE/BGFx5cg==" crossorigin=anonymous defer></script><script src=https://koktlzz.github.io/js/vendor/katex/dist/katex.min.b334e5b00c45f572e7f38a543046f36854bf4cbb543880480c09271a0efedc694d6905f719934f6ede2f26f52e80411c05b90121d722cbf8be2fa8fc51bc6b81.js integrity="sha512-szTlsAxF9XLn84pUMEbzaFS/TLtUOIBIDAknGg7+3GlNaQX3GZNPbt4vJvUugEEcBbkBIdciy/i+L6j8UbxrgQ==" crossorigin=anonymous defer></script><script src=https://koktlzz.github.io/js/vendor/katex/dist/contrib/auto-render.min.916823ec103cf367b71e28a6f01513cb9c3ac6708ccb5229402ec46b8e30a8b25003db694df35d80e9dd666a371f327c6152790617b6256390c164109a90bd4c.js integrity="sha512-kWgj7BA882e3Hiim8BUTy5w6xnCMy1IpQC7Ea44wqLJQA9tpTfNdgOndZmo3HzJ8YVJ5Bhe2JWOQwWQQmpC9TA==" crossorigin=anonymous defer></script><script src=https://koktlzz.github.io/main.min.1febbf2f6fd6a36fc2f57dd50d7935fbb640743329baeb4ef7cefcf2e7630e413371fbba976e103656b82808ee227dc4a84237edb0f8433648bef3a56900661a.js integrity="sha512-H+u/L2/Wo2/C9X3VDXk1+7ZAdDMpuutO98788udjDkEzcfu6l24QNla4KAjuIn3EqEI37bD4QzZIvvOlaQBmGg==" crossorigin=anonymous defer></script></body></html>