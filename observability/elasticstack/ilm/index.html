<!doctype html><html lang=en-us><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-D022F6NT2P"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-D022F6NT2P')</script><script>(function(b,d,e,a,g){b[a]=b[a]||[],b[a].push({'gtm.start':(new Date).getTime(),event:'gtm.js'});var f=d.getElementsByTagName(e)[0],c=d.createElement(e),h=a!='dataLayer'?'&l='+a:'';c.async=!0,c.src='https://www.googletagmanager.com/gtm.js?id='+g+h,f.parentNode.insertBefore(c,f)})(window,document,'script','dataLayer','GTM-P72R45W')</script><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://koktlzz.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://koktlzz.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://koktlzz.github.io/fonts/KaTeX_Main-Regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://koktlzz.github.io/fonts/KaTeX_Math-Italic.woff2 type=font/woff2 crossorigin><link rel=stylesheet href=https://koktlzz.github.io/main.ebca557cf3c32b5d7383007b1d6530ae70a1c5514b328a864833775693332c3b061b5d3b53c07da94226d83ae7e1b1154ae602c9af23bf774333c01006692c0e.css integrity="sha512-68pVfPPDK11zgwB7HWUwrnChxVFLMoqGSDN3VpMzLDsGG107U8B9qUIm2Drn4bEVSuYCya8jv3dDM8AQBmksDg==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>ILM | KnowledgeBase</title><meta name=description content><link rel=canonical href=https://koktlzz.github.io/observability/elasticstack/ilm/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="ILM"><meta property="og:description" content="概述 我们可以通过配置索引生命周期管理 ILM（Index Lifecycle Management）策略，来自动管理索引以达到某些效果：
 Rollover：当索引达到一定大小、创建超过一定时间或文档达到一定数量时，创建一个新索引； Shrink：减少索引中主分片的数量； Force merge：手动触发合并以减少索引中每个分片中的 segment 数，并释放已删除文档所使用的空间； Freeze：将索引设为只读，最大程度地减少其内存占用量； Delete：永久删除索引，包括其所有数据和元数据。  举例来说，我们要一台 ATM 的指标数据索引到 Elasticsearch 中，那么便可以配置相关的 ILM 策略：
 当索引主分片的总大小达到 50GB 时，创建新索引； 将旧索引标记为只读，并将其缩小为单个分片； 7 天后，将索引移至较便宜的硬件上； 30 天后，删除索引。  索引的生命周期 索引的生命周期共分为 4 个阶段（Phase）：
 Hot：索引正在不断更新且可以被搜索到； Warm：索引不再更新但可以被搜索到； Cold：索引不再更新且很少被搜索。虽然依然可以被搜索，但是搜索速度可能会变慢； Delete：索引不再被需要，可以安全地将其删除。  当某阶段中的所有动作均完成（Phase execution）且超过了最小持续时间，ILM 便会将索引转换到下一个阶段（Phase transitions）。每个阶段默认的最小持续时间为 0，因此我们在配置 ILM 策略时，一般会为每个阶段设置一个最小持续时间。由于 Elasticsearch 只能在健康状况为绿色的集群上执行某些清理任务，所以 ILM 可能会在健康状况为黄色的集群中失效。
ILM 控制每个阶段执行动作的顺序和与每个动作相关的索引操作的步骤。
数据层 数据层（data tier）是 Elasticsearch 集群中保存相同类型索引的节点集合。此处索引的类型是根据其生命周期划分的，因此对应的数据层分别为：Hot tier，Warm tier 和 Cold tier。上述三种数据层常用来保存如日志、指标等时间序列数据，而对产品目录、用户档案等需要持久化存储的数据进行生命周期管理是没有意义的，因此 Elasticsearch 引入 Content tier 来存放这种长时间内相对恒定的数据。"><meta property="og:url" content="https://koktlzz.github.io/observability/elasticstack/ilm/"><meta property="og:site_name" content="KnowledgeBase"><meta property="article:published_time" content="2020-11-04T09:19:42+01:00"><meta property="article:modified_time" content="2020-11-04T09:19:42+01:00"><meta property="og:image" content="https://koktlzz.github.io/doks.png"><meta property="og:image:alt" content="KnowledgeBase"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@getdoks"><meta name=twitter:creator content="@henkverlinde"><meta name=twitter:title content="ILM"><meta name=twitter:description content><meta name=twitter:image content="https://koktlzz.github.io/doks.png"><meta name=twitter:image:alt content="ILM"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://koktlzz.github.io/#/schema/organization/1","name":"Doks","url":"https://koktlzz.github.io/","sameAs":["https://twitter.com/getdoks","https://github.com/h-enk/doks"],"logo":{"@type":"ImageObject","@id":"https://koktlzz.github.io/#/schema/image/1","url":"https://koktlzz.github.io/logo-doks.png","width":512,"height":512,"caption":"Doks"},"image":{"@id":"https://koktlzz.github.io/#/schema/image/1"}},{"@type":"WebSite","@id":"https://koktlzz.github.io/#/schema/website/1","url":"https://koktlzz.github.io/","name":"KnowledgeBase","description":"","publisher":{"@id":"https://koktlzz.github.io/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://koktlzz.github.io/observability/elasticstack/ilm/","url":"https://koktlzz.github.io/observability/elasticstack/ilm/","name":"ILM","description":"","isPartOf":{"@id":"https://koktlzz.github.io/#/schema/website/1"},"about":{"@id":"https://koktlzz.github.io/#/schema/organization/1"},"datePublished":"2020-11-04T09:19:42CET","dateModified":"2020-11-04T09:19:42CET","breadcrumb":{"@id":"https://koktlzz.github.io/observability/elasticstack/ilm/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://koktlzz.github.io/observability/elasticstack/ilm/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://koktlzz.github.io/observability/elasticstack/ilm/"]}]},{"@type":"BreadcrumbList","@id":"https://koktlzz.github.io/observability/elasticstack/ilm/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://koktlzz.github.io/","url":"https://koktlzz.github.io/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://koktlzz.github.io/observability/","url":"https://koktlzz.github.io/observability/","name":"Observability"}},{"@type":"ListItem","position":3,"item":{"@type":"WebPage","@id":"https://koktlzz.github.io/observability/elasticstack/","url":"https://koktlzz.github.io/observability/elasticstack/","name":"Elasticstack"}},{"@type":"ListItem","position":4,"item":{"@id":"https://koktlzz.github.io/observability/elasticstack/ilm/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://koktlzz.github.io/observability/elasticstack/ilm/#/schema/image/2","url":"https://koktlzz.github.io/doks.png","contentUrl":"https://koktlzz.github.io/doks.png","caption":"ILM"}]}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=https://koktlzz.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://koktlzz.github.io/favicon-32x32.ico><link rel=icon type=image/png sizes=16x16 href=https://koktlzz.github.io/favicon-16x16.ico><link rel=manifest crossorigin=use-credentials href=https://koktlzz.github.io/site.webmanifest></head><body class="Observability single dark"><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-P72R45W" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container-fluid><input class="menu-btn order-0" type=checkbox id=menu-btn>
<label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label><a class="navbar-brand order-1 order-md-0 me-auto" href=https://koktlzz.github.io/>KnowledgeBase</a>
<button id=mode class="btn btn-link order-2 order-md-4" type=button aria-label="Toggle mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button><ul class="navbar-nav social-nav order-3 order-md-5"><li class=nav-item><a class=nav-link href=https://github.com/koktlzz><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><span class="ms-2 visually-hidden">GitHub</span></a></li></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav me-auto order-5 order-md-2"><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/container/docker/intro>Container</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/observability/elasticstack/intro>Observability</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/programming/go/intro>Programming</a></li><li class=nav-item><a class=nav-link href=https://koktlzz.github.io/infrastructure/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/tcpip%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B>Infrastructure</a></li></ul><div class="break order-6 d-md-none"></div></div></div></header><div class="wrap container-fluid" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-4 col-xl-3 d-none d-xl-block"><nav class=docs-links aria-label="Main navigation"><h3>ElasticStack</h3><ul class=list-unstyled><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/intro/>Getting Started</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/%E5%8D%95%E8%8A%82%E7%82%B9%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B/>单节点部署流程</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/elasticsearchintro/>ElasticSearch 简介</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/mapping/>Mapping</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/textanalysis/>Text analysis</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/template/>Template</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/ilm/>ILM</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/snapshot/>Snapshot</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/>Elasticsearch 性能调优</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/kafkaintro/>Kafka 简介</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/hw/>Kafka 副本备份</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/elasticstack/transaction/>Kafka 事务</a></li></ul><h3>Prometheus</h3><ul class=list-unstyled><li><a class=docs-link href=https://koktlzz.github.io/observability/prometheus/intro/>Getting Started</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/prometheus/operator%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE/>Operator 自定义配置</a></li></ul><h3>Opentelemetry</h3><ul class=list-unstyled><li><a class=docs-link href=https://koktlzz.github.io/observability/opentelemetry/intro/>Getting Started</a></li><li><a class=docs-link href=https://koktlzz.github.io/observability/opentelemetry/opentelemetry/>Collector Example</a></li></ul></nav></div><main class="docs-content col-lg-12 col-xl-10"><h1>ILM</h1><p class=lead></p><h2 id=概述>概述<a href=#概述 class=anchor aria-hidden=true>#</a></h2><p>我们可以通过配置索引生命周期管理 ILM（Index Lifecycle Management）策略，来自动管理索引以达到某些效果：</p><ul><li>Rollover：当索引达到一定大小、创建超过一定时间或文档达到一定数量时，创建一个新索引；</li><li>Shrink：减少索引中主分片的数量；</li><li>Force merge：手动触发合并以减少索引中每个分片中的 segment 数，并释放已删除文档所使用的空间；</li><li>Freeze：将索引设为只读，最大程度地减少其内存占用量；</li><li>Delete：永久删除索引，包括其所有数据和元数据。</li></ul><p>举例来说，我们要一台 ATM 的指标数据索引到 Elasticsearch 中，那么便可以配置相关的 ILM 策略：</p><ul><li>当索引主分片的总大小达到 50GB 时，创建新索引；</li><li>将旧索引标记为只读，并将其缩小为单个分片；</li><li>7 天后，将索引移至较便宜的硬件上；</li><li>30 天后，删除索引。</li></ul><h2 id=索引的生命周期>索引的生命周期<a href=#索引的生命周期 class=anchor aria-hidden=true>#</a></h2><p>索引的生命周期共分为 4 个阶段（Phase）：</p><ul><li>Hot：索引正在不断更新且可以被搜索到；</li><li>Warm：索引不再更新但可以被搜索到；</li><li>Cold：索引不再更新且很少被搜索。虽然依然可以被搜索，但是搜索速度可能会变慢；</li><li>Delete：索引不再被需要，可以安全地将其删除。</li></ul><p>当某阶段中的所有动作均完成（Phase execution）且超过了最小持续时间，ILM 便会将索引转换到下一个阶段（Phase transitions）。每个阶段默认的最小持续时间为 0，因此我们在配置 ILM 策略时，一般会为每个阶段设置一个最小持续时间。由于 Elasticsearch 只能在健康状况为绿色的集群上执行某些清理任务，所以 ILM 可能会在健康状况为黄色的集群中失效。</p><p>ILM 控制每个阶段执行动作的顺序和与每个动作相关的索引操作的步骤。</p><h2 id=数据层>数据层<a href=#数据层 class=anchor aria-hidden=true>#</a></h2><p>数据层（<a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/data-tiers.html>data tier</a>）是 Elasticsearch 集群中保存相同类型索引的节点集合。此处索引的类型是根据其生命周期划分的，因此对应的数据层分别为：Hot tier，Warm tier 和 Cold tier。上述三种数据层常用来保存如日志、指标等时间序列数据，而对产品目录、用户档案等需要持久化存储的数据进行生命周期管理是没有意义的，因此 Elasticsearch 引入 Content tier 来存放这种长时间内相对恒定的数据。</p><ul><li>当文档被直接写入到指定的索引时，它们会无限期地保留在 Content tier 节点上；</li><li>当文档被写入到数据流（<a href=https://www.elastic.co/guide/en/elasticsearch/reference/7.11/data-streams.html>data stream</a>）时，它们最初位于 Hot tier 节点上。随后根据 ILM 策略移动到其他数据层节点上；</li><li>节点位于的数据层可以在 elasticsearch.yml 文件中的<code>node.roles</code>参数中进行配置；</li><li>索引的<code>index.routing.allocation.include._tier_preference</code>参数可以指定索引被分配到的数据层。</li></ul><h2 id=阶段动作phase-action>阶段动作（Phase action）<a href=#阶段动作phase-action class=anchor aria-hidden=true>#</a></h2><p>每个阶段中支持的动作如下：</p><table><thead><tr><th></th><th>Hot</th><th>Warm</th><th>Cold</th><th>Delete</th></tr></thead><tbody><tr><td>Set Priority</td><td>$\checkmark$</td><td>$\checkmark$</td><td>$\checkmark$</td><td></td></tr><tr><td>Unfollow</td><td>$\checkmark$</td><td>$\checkmark$</td><td>$\checkmark$</td><td></td></tr><tr><td>Rollover</td><td>$\checkmark$</td><td></td><td></td><td></td></tr><tr><td>Read-Only</td><td>$\checkmark$</td><td>$\checkmark$</td><td></td><td></td></tr><tr><td>Shrink</td><td>$\checkmark$</td><td>$\checkmark$</td><td></td><td></td></tr><tr><td>Force merge</td><td>$\checkmark$</td><td>$\checkmark$</td><td></td><td></td></tr><tr><td>Allocate</td><td></td><td>$\checkmark$</td><td>$\checkmark$</td><td></td></tr><tr><td>Migrate</td><td></td><td>$\checkmark$</td><td>$\checkmark$</td><td></td></tr><tr><td>Freeze</td><td></td><td></td><td>$\checkmark$</td><td></td></tr><tr><td>Searchable Snapshot</td><td>$\checkmark$</td><td></td><td>$\checkmark$</td><td></td></tr><tr><td>Wait For Snapshot</td><td></td><td></td><td></td><td>$\checkmark$</td></tr><tr><td>Delete</td><td></td><td></td><td></td><td>$\checkmark$</td></tr></tbody></table><h3 id=set-priority>Set Priority<a href=#set-priority class=anchor aria-hidden=true>#</a></h3><p>一旦索引进入相应阶段，就为其设置优先级（<code>priority</code>）。如果节点重新启动，将先恢复优先级级别更高的索引。通常，处于 Hot 阶段的索引应具有最高值，而处于 Cold 阶段的索引应具有最低值。每个索引的<code>priority</code>默认值为 1。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>PUT _ilm/policy/my_policy
{
  <span style=color:#ff79c6>&#34;policy&#34;</span>: {
    <span style=color:#ff79c6>&#34;phases&#34;</span>: {
      <span style=color:#ff79c6>&#34;warm&#34;</span>: {
        <span style=color:#ff79c6>&#34;actions&#34;</span>: {
          <span style=color:#ff79c6>&#34;set_priority&#34;</span> : {
            <span style=color:#ff79c6>&#34;priority&#34;</span>: <span style=color:#bd93f9>50</span>
          }
        }
      }
    }
  }
}
</code></pre></div><h3 id=unfollow>Unfollow<a href=#unfollow class=anchor aria-hidden=true>#</a></h3><p>涉及到跨集群复制（ Cross-cluster replication），详见 <a href="https://www.elastic.co/cn/webinars/cross-cluster-replication?baymax=rtp&elektra=docs&storm=sidebar3">跨集群复制 (CCR) 深度解析</a>。</p><h3 id=rollover>Rollover<a href=#rollover class=anchor aria-hidden=true>#</a></h3><p>当索引达到一定大小、创建超过一定时间或文档达到一定数量时，创建一个新索引并接收文档写入。注意，只有带有别名的索引（index alias）和数据流（data stream）支持 Rollover 动作。对于带有别名的索引，必须符合下列条件：</p><ul><li>索引名称的格式符合**^.*-\d+$**，如 my-index-000001；</li><li>参数<code>settings.index.lifecycle.rollover_alias</code>必须被定义。</li></ul><p>由于创建的新索引（如 my-index-000002）的别名与旧索引相同，因此 Elasticsearch 引入参数<code>aliases.&lt;alias-name>.is_write_index</code>来表示当前正在写入文档的索引（<a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-rollover-index.html#indices-rollover-is-write-index>write index</a>）。例如，初始索引 my-index-000001 的该参数为<code>true</code>。当它执行 Rollover 动作后，创建了新索引 my-index-000002。那么新索引 my-index-000002<code>is_write_index</code>参数为<code>true</code>，旧索引的则自动变为<code>false</code>。</p><p>我们创建一个索引 my-index-000001，别名为 my_data。进行下列配置后便能够支持 Rollover 动作：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>PUT my-index<span style=color:#bd93f9>-000001</span>
{
  <span style=color:#ff79c6>&#34;settings&#34;</span>: {
    <span style=color:#ff79c6>&#34;index.lifecycle.name&#34;</span>: <span style=color:#f1fa8c>&#34;my_policy&#34;</span>,
    <span style=color:#ff79c6>&#34;index.lifecycle.rollover_alias&#34;</span>: <span style=color:#f1fa8c>&#34;my_data&#34;</span>
  },
  <span style=color:#ff79c6>&#34;aliases&#34;</span>: {
    <span style=color:#ff79c6>&#34;my_data&#34;</span>: {
      <span style=color:#ff79c6>&#34;is_write_index&#34;</span>: <span style=color:#ff79c6>true</span>
    }
  }
}
</code></pre></div><p>上文提到，ILM 执行 Rollover 动作的条件为：索引达到一定大小、创建超过一定时间或文档达到一定数量，它们所对应的参数分别为：<code>max_size</code>、<code>max_age</code>、<code>max_docs</code>。常见的 Rollover 配置如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>PUT _ilm/policy/my_policy
{
  <span style=color:#ff79c6>&#34;policy&#34;</span>: {
    <span style=color:#ff79c6>&#34;phases&#34;</span>: {
      <span style=color:#ff79c6>&#34;hot&#34;</span>: {
        <span style=color:#ff79c6>&#34;actions&#34;</span>: {
          <span style=color:#ff79c6>&#34;rollover&#34;</span> : {
            <span style=color:#ff79c6>&#34;max_age&#34;</span>: <span style=color:#f1fa8c>&#34;7d&#34;</span>,
            <span style=color:#ff79c6>&#34;max_size&#34;</span>: <span style=color:#f1fa8c>&#34;100GB&#34;</span>
            <span style=color:#f1fa8c>&#34;max_docs&#34;</span>: <span style=color:#bd93f9>100000000</span>
          }
        }
      }
    }
  }
}
</code></pre></div><p>当指定多个参数时，只要有一个条件满足，ILM 就会执行 Rollover 动作。</p><h3 id=read-only>Read-Only<a href=#read-only class=anchor aria-hidden=true>#</a></h3><p>将索引变为只读模式。另外，若想在 Hot 阶段执行该动作，必须存在 Rollover 动作的配置，否则将被 ILM 拒绝。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>PUT _ilm/policy/my_policy
{
  <span style=color:#ff79c6>&#34;policy&#34;</span>: {
    <span style=color:#ff79c6>&#34;phases&#34;</span>: {
      <span style=color:#ff79c6>&#34;warm&#34;</span>: {
        <span style=color:#ff79c6>&#34;actions&#34;</span>: {
          <span style=color:#ff79c6>&#34;readonly&#34;</span> : { }
        }
      }
    }
  }
}
</code></pre></div><h3 id=shrink>Shrink<a href=#shrink class=anchor aria-hidden=true>#</a></h3><p>将索引设置为只读，并将其收缩为一个具有更少主分片数的新索引，新索引的名称为<code>shrink-&lt;original-index-name></code>。Shrink 动作将所有主分片全部分配到一个节点上，并在执行完毕后将与原索引关联的别名转换为新索引。与 Read-Only 动作相同，若想在 Hot 阶段执行该动作，必须存在 Rollover 动作的配置，否则将被 ILM 拒绝。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>PUT _ilm/policy/my_policy
{
  <span style=color:#ff79c6>&#34;policy&#34;</span>: {
    <span style=color:#ff79c6>&#34;phases&#34;</span>: {
      <span style=color:#ff79c6>&#34;warm&#34;</span>: {
        <span style=color:#ff79c6>&#34;actions&#34;</span>: {
          <span style=color:#ff79c6>&#34;shrink&#34;</span> : {
            <span style=color:#ff79c6>&#34;number_of_shards&#34;</span>: <span style=color:#bd93f9>1</span>
          }
        }
      }
    }
  }
}
</code></pre></div><h3 id=force-merge>Force merge<a href=#force-merge class=anchor aria-hidden=true>#</a></h3><p>将索引强制合并为指定的 segement 数，该操作将使索引变为只读。同样，若想在 Hot 阶段执行该动作，必须存在 Rollover 动作的配置，否则将被 ILM 拒绝。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>PUT _ilm/policy/my_policy
{
  <span style=color:#ff79c6>&#34;policy&#34;</span>: {
    <span style=color:#ff79c6>&#34;phases&#34;</span>: {
      <span style=color:#ff79c6>&#34;warm&#34;</span>: {
        <span style=color:#ff79c6>&#34;actions&#34;</span>: {
          <span style=color:#ff79c6>&#34;forcemerge&#34;</span> : {
            <span style=color:#ff79c6>&#34;max_num_segments&#34;</span>: <span style=color:#bd93f9>1</span>
          }
        }
      }
    }
  }
}
</code></pre></div><h3 id=allocate>Allocate<a href=#allocate class=anchor aria-hidden=true>#</a></h3><p>更改索引分片分配的节点和副本的个数。可选参数如下：</p><ul><li><code>number_of_replicas</code>：索引副本数</li><li><code>include</code>：将分片分配到至少有一个参数符合配置的节点上</li><li><code>exclude</code>：将分片分配到参数不符合配置的节点上</li><li><code>require</code>：将分配分配到参数全部符合配置的节点上</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>PUT _ilm/policy/my_policy
{
  <span style=color:#ff79c6>&#34;policy&#34;</span>: {
    <span style=color:#ff79c6>&#34;phases&#34;</span>: {
      <span style=color:#ff79c6>&#34;warm&#34;</span>: {
        <span style=color:#ff79c6>&#34;actions&#34;</span>: {
          <span style=color:#ff79c6>&#34;allocate&#34;</span> : {
            <span style=color:#ff79c6>&#34;number_of_replicas&#34;</span>: <span style=color:#bd93f9>2</span>,            // 分片的副本数更改为 2
            <span style=color:#ff79c6>&#34;include&#34;</span> : {
              <span style=color:#ff79c6>&#34;box_type&#34;</span>: <span style=color:#f1fa8c>&#34;cold&#34;</span>                // elasticsearch.yml 文件中的 node.attr.box_type 字段
            },
            
         
        }
      }
    }
  }
}
</code></pre></div><h3 id=migrate>Migrate<a href=#migrate class=anchor aria-hidden=true>#</a></h3><p>在生命周期的阶段转换时，通过更新索引设置中的<code>index.routing.allocation.include._tier_preference</code>参数，将索引移动到与当前阶段对应的数据层节点上。</p><ul><li>如果 Warm 和 Cold 阶段中没有指定 Allocate 动作，那么 ILM 将会自动执行 Migrate 动作；</li><li>如果在 Allocate 动作中仅修改了分片副本数，那么 ILM 会在执行 Migrate 动作前减少副本数；</li><li>可以将<code>enabled</code>参数设置为<code>false</code>从而禁用 ILM 自动执行的 Migrate 动作。</li></ul><h3 id=freeze>Freeze<a href=#freeze class=anchor aria-hidden=true>#</a></h3><p>Freeze 动作将索引的内存占用量降低到最低，该索引被搜索时的响应变慢（原理参考：<a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/frozen-indices.html>https://www.elastic.co/guide/en/elasticsearch/reference/current/frozen-indices.html</a>)。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>PUT _ilm/policy/my_policy
{
  <span style=color:#ff79c6>&#34;policy&#34;</span>: {
    <span style=color:#ff79c6>&#34;phases&#34;</span>: {
      <span style=color:#ff79c6>&#34;cold&#34;</span>: {
        <span style=color:#ff79c6>&#34;actions&#34;</span>: {
          <span style=color:#ff79c6>&#34;freeze&#34;</span> : { }
        }
      }
    }
  }
}
</code></pre></div><h3 id=searchable-snapshot>Searchable Snapshot<a href=#searchable-snapshot class=anchor aria-hidden=true>#</a></h3><p>为索引拍摄快照，并将其挂载为 <a href=https://koktlzz.github.io/elastic/elasticsearch/snapshot/#%E5%8F%AF%E6%90%9C%E7%B4%A2%E5%BF%AB%E7%85%A7>可搜索快照</a>。想在 Hot 阶段执行该动作，必须存在 Rollover 动作的配置，否则将被 ILM 拒绝。若在 Hot 阶段执行 Searchable Snapshot，则在后续阶段中无法定义任何 Shrink, Force merge 和 Freeze 动作。默认情况下，当索引在 Delete 阶段被删除后，相应的快照也随之删除。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>PUT _ilm/policy/my_policy
{
  <span style=color:#ff79c6>&#34;policy&#34;</span>: {
    <span style=color:#ff79c6>&#34;phases&#34;</span>: {
      <span style=color:#ff79c6>&#34;cold&#34;</span>: {
        <span style=color:#ff79c6>&#34;actions&#34;</span>: {
          <span style=color:#ff79c6>&#34;searchable_snapshot&#34;</span> : {
            <span style=color:#ff79c6>&#34;snapshot_repository&#34;</span> : <span style=color:#f1fa8c>&#34;backing_repo&#34;</span>    // 指定存储快照的仓库为 backing_repo
          }
        }
      }
    }
  }
}
</code></pre></div><h3 id=wait-for-snapshot>Wait for snapshot<a href=#wait-for-snapshot class=anchor aria-hidden=true>#</a></h3><p>等待指定的快照生命周期管理 SLM（Snapshot Lifecycle Management）策略执行后再删除索引，这样可以确保已删除索引有快照可用。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>PUT _ilm/policy/my_policy
{
  <span style=color:#ff79c6>&#34;policy&#34;</span>: {
    <span style=color:#ff79c6>&#34;phases&#34;</span>: {
      <span style=color:#ff79c6>&#34;delete&#34;</span>: {
        <span style=color:#ff79c6>&#34;actions&#34;</span>: {
          <span style=color:#ff79c6>&#34;wait_for_snapshot&#34;</span> : {
            <span style=color:#ff79c6>&#34;policy&#34;</span>: <span style=color:#f1fa8c>&#34;slm-policy-name&#34;</span>    // 名为 slm-policy-name 的 SLM 策略执行完毕后才会删除索引
          }
        }
      }
    }
  }
}
</code></pre></div><h3 id=delete>Delete<a href=#delete class=anchor aria-hidden=true>#</a></h3><p>永久删除索引。如果该索引执行过 Searchable Snapshot 动作且<code>delete_searchable_snapshot</code>参数为<code>false</code>，则索引被删除后快照依然保留。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>PUT _ilm/policy/my_policy
{
  <span style=color:#ff79c6>&#34;policy&#34;</span>: {
    <span style=color:#ff79c6>&#34;phases&#34;</span>: {
      <span style=color:#ff79c6>&#34;delete&#34;</span>: {
        <span style=color:#ff79c6>&#34;actions&#34;</span>: {
          <span style=color:#ff79c6>&#34;delete&#34;</span> : { }
        }
      }
    }
  }
}
</code></pre></div><h2 id=为索引配置-ilm>为索引配置 ILM<a href=#为索引配置-ilm class=anchor aria-hidden=true>#</a></h2><p>在 Elastic Cloud 创建 ILM 策略是非常方便的：<a href=https://github.com/elastic/elasticsearch/edit/7.11/docs/reference/ilm/example-index-lifecycle-policy.asciidoc>Tutorial: Customize built-in ILM policies</a>。</p><p>而将已创建的 ILM 策略关联到索引的方法有以下几种：</p><ul><li>通过在索引模板中添加 ILM 策略来关联索引</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>PUT _index_template/my_template
{
  <span style=color:#ff79c6>&#34;index_patterns&#34;</span>: [<span style=color:#f1fa8c>&#34;my-index-*&#34;</span>],                           
  <span style=color:#ff79c6>&#34;template&#34;</span>: {
    <span style=color:#ff79c6>&#34;settings&#34;</span>: {
      <span style=color:#ff79c6>&#34;index.lifecycle.name&#34;</span>: <span style=color:#f1fa8c>&#34;my_ilm_policy&#34;</span>,    // 将名称开头为<span style=color:#ff79c6>&#34;my-index-&#34;</span>的索引关联到 ILM 策略 my_ilm_policy
      <span style=color:#f1fa8c>&#34;index.lifecycle.rollover_alias&#34;</span>: <span style=color:#f1fa8c>&#34;test-alias&#34;</span> 
    }
</code></pre></div><ul><li>直接修改现有索引的设置</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>PUT my-index-*/_settings 
{
  <span style=color:#ff79c6>&#34;index&#34;</span>: {
    <span style=color:#ff79c6>&#34;lifecycle&#34;</span>: {
      <span style=color:#ff79c6>&#34;name&#34;</span>: <span style=color:#f1fa8c>&#34;my_ilm_policy&#34;</span>    // 将名称开头为<span style=color:#f1fa8c>&#34;my-index-&#34;</span>的索引关联到 ILM 策略 my_ilm_policy
    }
  }
}
</code></pre></div><ul><li>在创建新索引时直接在设置中指定 ILM 策略</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>PUT new-index
{
  <span style=color:#ff79c6>&#34;settings&#34;</span>: {
    <span style=color:#ff79c6>&#34;number_of_shards&#34;</span>: <span style=color:#bd93f9>1</span>,
    <span style=color:#ff79c6>&#34;number_of_replicas&#34;</span>: <span style=color:#bd93f9>1</span>,
    <span style=color:#ff79c6>&#34;index.lifecycle.name&#34;</span>: <span style=color:#f1fa8c>&#34;my_ilm_policy&#34;</span>    // 将 new-index 关联到 ILM 策略 my_ilm_policy
  }
}
</code></pre></div><p class=edit-page><a href=https://github.com/koktlzz/koktlzz.github.io/blob/master/content/Observability/ElasticStack/ILM.md><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2"><path d="M17 3a2.828 2.828.0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>Edit this page on GitHub</a></p><div class="docs-navigation d-flex justify-content-between"><a href=https://koktlzz.github.io/observability/elasticstack/template/><div class="card my-1"><div class="card-body py-2">&larr; Template</div></div></a><a class=ms-auto href=https://koktlzz.github.io/observability/elasticstack/snapshot/><div class="card my-1"><div class="card-body py-2">Snapshot &rarr;</div></div></a></div><script src=https://utteranc.es/client.js repo=koktlzz/koktlzz.github.io issue-term=pathname theme=photon-dark crossorigin=anonymous async></script></main><nav class="docs-toc d-none d-xl-block col-lg-3 col-xl-2" aria-label="Secondary navigation"><div class=page-links><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=#概述>概述</a></li><li><a href=#索引的生命周期>索引的生命周期</a></li><li><a href=#数据层>数据层</a></li><li><a href=#阶段动作phase-action>阶段动作（Phase action）</a><ul><li><a href=#set-priority>Set Priority</a></li><li><a href=#unfollow>Unfollow</a></li><li><a href=#rollover>Rollover</a></li><li><a href=#read-only>Read-Only</a></li><li><a href=#shrink>Shrink</a></li><li><a href=#force-merge>Force merge</a></li><li><a href=#allocate>Allocate</a></li><li><a href=#migrate>Migrate</a></li><li><a href=#freeze>Freeze</a></li><li><a href=#searchable-snapshot>Searchable Snapshot</a></li><li><a href=#wait-for-snapshot>Wait for snapshot</a></li><li><a href=#delete>Delete</a></li></ul></li><li><a href=#为索引配置-ilm>为索引配置 ILM</a></li></ul></nav></div></nav></div></div></div><script src=https://koktlzz.github.io/js/bootstrap.min.d67050adf5d370668aede4201f82af781b16970934804995a1ca37c1ee9222c2fc530972aa6d5d2b6124caf1fe318f139aac99df2c1e89af65504fc1185c7972.js integrity="sha512-1nBQrfXTcGaK7eQgH4KveBsWlwk0gEmVoco3we6SIsL8Uwlyqm1dK2EkyvH+MY8TmqyZ3yweia9lUE/BGFx5cg==" crossorigin=anonymous defer></script><script src=https://koktlzz.github.io/js/vendor/katex/dist/katex.min.b334e5b00c45f572e7f38a543046f36854bf4cbb543880480c09271a0efedc694d6905f719934f6ede2f26f52e80411c05b90121d722cbf8be2fa8fc51bc6b81.js integrity="sha512-szTlsAxF9XLn84pUMEbzaFS/TLtUOIBIDAknGg7+3GlNaQX3GZNPbt4vJvUugEEcBbkBIdciy/i+L6j8UbxrgQ==" crossorigin=anonymous defer></script><script src=https://koktlzz.github.io/js/vendor/katex/dist/contrib/auto-render.min.916823ec103cf367b71e28a6f01513cb9c3ac6708ccb5229402ec46b8e30a8b25003db694df35d80e9dd666a371f327c6152790617b6256390c164109a90bd4c.js integrity="sha512-kWgj7BA882e3Hiim8BUTy5w6xnCMy1IpQC7Ea44wqLJQA9tpTfNdgOndZmo3HzJ8YVJ5Bhe2JWOQwWQQmpC9TA==" crossorigin=anonymous defer></script><script src=https://koktlzz.github.io/main.min.1febbf2f6fd6a36fc2f57dd50d7935fbb640743329baeb4ef7cefcf2e7630e413371fbba976e103656b82808ee227dc4a84237edb0f8433648bef3a56900661a.js integrity="sha512-H+u/L2/Wo2/C9X3VDXk1+7ZAdDMpuutO98788udjDkEzcfu6l24QNla4KAjuIn3EqEI37bD4QzZIvvOlaQBmGg==" crossorigin=anonymous defer></script></body></html>